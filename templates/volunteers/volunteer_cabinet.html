<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–æ–π –ö–∞–±–∏–Ω–µ—Ç</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/qFYrFSnD/2105176-1-removebg-preview.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00c6ff; --bg: #020408; --glass: rgba(15, 23, 42, 0.85); }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; background-image: radial-gradient(circle at 50% -20%, #10192e 0%, #020408 100%); min-height: 100vh; padding: 20px; overflow-x: hidden; }
        
        .glass-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 24px; transition: transform 0.2s; }
        
        .lang-btn { font-size: 10px; font-weight: 900; color: #64748b; cursor: pointer; transition: 0.3s; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 8px; }
        .lang-btn.active { color: var(--primary); border-color: var(--primary); background: rgba(0, 198, 255, 0.05); }

        .input-field { 
            background: rgba(0, 198, 255, 0.03); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 16px; 
            padding: 14px 16px; 
            width: 100%; 
            color: white; 
            outline: none; 
            margin-bottom: 16px; 
            font-size: 14px; 
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .input-field:focus { 
            border-color: var(--primary); 
            background: rgba(0, 198, 255, 0.08); 
            box-shadow: 0 0 15px rgba(0, 198, 255, 0.1);
        }

        select.input-field {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2300c6ff'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
            padding-right: 2.5rem;
        }

        .btn-send { background: var(--primary); color: black; font-weight: 800; width: 100%; padding: 16px; border-radius: 16px; text-transform: uppercase; letter-spacing: 0.05em; transition: 0.3s; box-shadow: 0 4px 15px rgba(0, 198, 255, 0.3); }
        .btn-send:active { transform: scale(0.98); }
        
        .custom-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-top: 10px; }
        .custom-table th { text-align: left; padding: 0 12px; font-size: 10px; text-transform: uppercase; color: #6b7280; letter-spacing: 0.05em; }
        .custom-table td { padding: 12px; font-size: 13px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); }
        .custom-table tr td:first-child { border-radius: 12px 0 0 12px; border-right: none; }
        .custom-table tr td:last-child { border-radius: 0 12px 12px 0; border-left: none; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; padding: 16px; border-radius: 16px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-left: 4px solid var(--primary); color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: translateX(100%); transition: transform 0.3s ease-out; display: flex; align-items: center; gap: 12px; }
        .toast.show { transform: translateX(0); }

        @media (max-width: 768px) {
            body { padding: 16px; padding-bottom: 80px; }
            .glass-card { padding: 20px; border-radius: 20px; }
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
            <div class="flex items-start gap-4">
                <div>
                    <h1 id="vName" class="text-3xl md:text-4xl font-black italic uppercase leading-none">...</h1>
                    <div class="flex items-center gap-2 mt-2">
                        <span class="w-8 h-[2px] bg-primary"></span>
                        <p id="vRole" class="text-gray-400 text-[10px] font-bold tracking-[0.2em] uppercase">–ó–∞–≥—Ä—É–∑–∫–∞</p>
                    </div>
                </div>
                <div class="flex gap-2 mt-1">
                    <div class="lang-btn" id="lang-ru" onclick="setLang('ru')">RU</div>
                    <div class="lang-btn" id="lang-en" onclick="setLang('en')">EN</div>
                </div>
            </div>
            
            <div class="w-full md:w-auto glass-card flex justify-between items-center gap-6 py-3 px-6 border-primary/20">
                <div>
                    <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-1" id="t-score">–í–∞—à —Å—á–µ—Ç</p>
                    <p id="vPoints" class="text-3xl font-black text-primary italic leading-none">0</p>
                </div>
                <div class="w-[1px] h-8 bg-white/10"></div>
                <div>
                    <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-1" id="t-yc">–ñ–ö</p>
                    <p id="vYellowCards" class="text-3xl font-black text-orange-500 italic leading-none">0</p>
                </div>
                <button onclick="logout()" class="ml-2 w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition-all">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1">
                <div class="glass-card lg:sticky lg:top-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary">
                            <i class="fas fa-paper-plane text-xs"></i>
                        </div>
                        <h3 class="font-black italic uppercase text-white text-lg" id="t-newreport">–ù–æ–≤—ã–π –æ—Ç—á–µ—Ç</h3>
                    </div>
                    
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-2 block tracking-wider" id="t-step1">1. –ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º?</label>
                    <select id="contextSelect" class="input-field" onchange="updateTaskDropdown()"></select>

                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-2 block tracking-wider" id="t-step2">2. –ö–∞–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ?</label>
                    <select id="taskSelect" class="input-field"></select>

                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-2 block tracking-wider" id="t-step3">3. –°—Å—ã–ª–∫–∞ / –û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="taskComm" class="input-field h-24 resize-none"></textarea>

                    <button onclick="sendReport()" id="sendBtn" class="btn-send flex items-center justify-center gap-2">
                        <span id="t-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                        <i class="fas fa-arrow-right text-xs"></i>
                    </button>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6" id="tablesContainer">
                <div class="glass-card flex flex-col items-center justify-center py-20 text-center">
                    <i class="fas fa-circle-notch fa-spin text-primary text-2xl mb-4"></i>
                    <p class="text-gray-500 text-sm font-medium" id="t-sync">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...</p>
                </div>
            </div>
        </div>
    </div>

   <script>
        const token = localStorage.getItem('access');
        let currentLang = localStorage.getItem('lang') || 'ru';

        const translations = {
            ru: {
                score: "–í–∞—à —Å—á–µ—Ç", yc: "–ñ–ö", newreport: "–ù–æ–≤—ã–π –æ—Ç—á–µ—Ç",
                step1: "1. –ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º?", step2: "2. –ö–∞–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ?",
                step3: "3. –°—Å—ã–ª–∫–∞ / –û–ø–∏—Å–∞–Ω–∏–µ", send: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
                sync: "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...", loading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
                chooseCtx: "–í—ã–±–µ—Ä–∏—Ç–µ, –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å...", chooseTask: "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ...",
                firstCtx: "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É", noActive: "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á",
                emptyCtx: "–í—ã –ø–æ–∫–∞ –Ω–∏–≥–¥–µ –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ", historyEmpty: "–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.",
                total: "–í—Å–µ–≥–æ", dirSub: "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ + –û–±—â–∏–µ", cmdSub: "–°–ø–µ—Ü. –ö–æ–º–∞–Ω–¥–∞",
                noRecords: "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π", delTask: "–ó–∞–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ",
                toastErr: "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.", toastSent: "–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!",
                toastMiss: "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ!", toastFail: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ",
                placeComm: "–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ Google Drive –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ —Ä–∞–±–æ—Ç—É...",
                general: " (–û–±—â–∞—è)"
            },
            en: {
                score: "Your Score", yc: "YC", newreport: "New Report",
                step1: "1. Where to send?", step2: "2. Which task?",
                step3: "3. Link / Description", send: "Submit",
                sync: "Syncing data...", loading: "Loading...",
                chooseCtx: "Choose destination...", chooseTask: "Select task...",
                firstCtx: "Choose a group first", noActive: "No active tasks",
                emptyCtx: "You are not a member yet", historyEmpty: "History is empty.",
                total: "Total", dirSub: "Direction + General", cmdSub: "Special Team",
                noRecords: "No records", delTask: "Task deleted",
                toastErr: "Connection error.", toastSent: "Report sent successfully!",
                toastMiss: "Select a task!", toastFail: "Error sending report",
                placeComm: "Paste Google Drive link or describe your work...",
                general: " (General)"
            }
        };

        function setLang(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`lang-${lang}`).classList.add('active');

            const t = translations[lang];
            document.getElementById('t-score').innerText = t.score;
            document.getElementById('t-yc').innerText = t.yc;
            document.getElementById('t-newreport').innerText = t.newreport;
            document.getElementById('t-step1').innerText = t.step1;
            document.getElementById('t-step2').innerText = t.step2;
            document.getElementById('t-step3').innerText = t.step3;
            document.getElementById('t-send').innerText = t.send;
            if(document.getElementById('t-sync')) document.getElementById('t-sync').innerText = t.sync;
            document.getElementById('taskComm').placeholder = t.placeComm;

            renderContextSelect();
            updateTaskDropdown();
            renderTables();
        }

        let appData = {
            my_direction: [],
            my_commands: [],
            available_tasks: [],
            history: []
        };

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} text-lg"></i> <span class="text-sm font-semibold">${message}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function logout() { localStorage.clear(); location.href = '/login/'; }

        function extractId(obj, fieldName) {
            if (!obj) return null;
            const directId = obj[`${fieldName}_id`];
            if (directId !== undefined && directId !== null) return String(directId);
            const val = obj[fieldName];
            if (val && typeof val === 'object' && val.id) return String(val.id);
            if (val !== undefined && val !== null && typeof val !== 'object') return String(val);
            return null; 
        }

        async function init() {
            if(!token) return location.href = '/login/';
            try {
                const [uRes, dRes, hRes] = await Promise.all([
                    fetch('/api/profile/', { headers: {'Authorization': `Bearer ${token}`}}),
                    fetch('/api/discovery/', { headers: {'Authorization': `Bearer ${token}`}}),
                    fetch('/api/activities/', { headers: {'Authorization': `Bearer ${token}`}})
                ]);
                if (uRes.status === 401 || dRes.status === 401) return logout();
                const user = await uRes.json();
                const disc = await dRes.json();
                const hist = await hRes.json();

                document.getElementById('vName').innerText = user.name || user.login;
                document.getElementById('vRole').innerText = user.role_display || "Volunteer";
                document.getElementById('vPoints').innerText = user.point || 0;
                document.getElementById('vYellowCards').innerText = user.yellow_card || 0;

                appData.my_direction = Array.isArray(disc.my_direction) ? disc.my_direction : (disc.my_direction ? [disc.my_direction] : []);
                appData.my_commands = Array.isArray(disc.my_commands) ? disc.my_commands : (disc.my_commands ? [disc.my_commands] : []);
                appData.available_tasks = disc.available_tasks || [];
                appData.history = hist;

                setLang(currentLang);
            } catch(e) { showToast(translations[currentLang].toastErr, "error"); }
        }

        function renderContextSelect() {
            const sel = document.getElementById('contextSelect');
            const t = translations[currentLang];
            sel.innerHTML = `<option value="">${t.chooseCtx}</option>`;
            appData.my_direction.forEach(dir => sel.innerHTML += `<option value="dir_${dir.id || dir}">üîπ ${dir.name || 'Direction'}</option>`);
            appData.my_commands.forEach(cmd => sel.innerHTML += `<option value="cmd_${cmd.id || cmd}">üî∏ ${cmd.title}</option>`);
            if (appData.my_direction.length === 0 && appData.my_commands.length === 0) sel.innerHTML = `<option value="">${t.emptyCtx}</option>`;
        }

function updateTaskDropdown() {
            const contextVal = document.getElementById('contextSelect').value;
            const taskSel = document.getElementById('taskSelect');
            const t = translations[currentLang];
            taskSel.innerHTML = `<option value="">${contextVal ? t.chooseTask : t.firstCtx}</option>`;
            
            if (!contextVal) return;

            const [type, targetId] = contextVal.split('_');
            const relevantTasks = appData.available_tasks.filter(tk => {
                const tDirId = extractId(tk, 'direction');
                const tCmdId = extractId(tk, 'command');
                const isGen = !tCmdId && !tDirId;
                return type === 'dir' ? (tDirId === targetId || isGen) : (tCmdId === targetId || isGen);
            });

            if (relevantTasks.length === 0) {
                taskSel.innerHTML = `<option value="">${t.noActive}</option>`;
            } else {
                relevantTasks.forEach(tk => {
                    // –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –Ø–ó–´–ö–ê –î–õ–Ø –ó–ê–î–ê–ù–ò–Ø
                    const displayTitle = (currentLang === 'en' && tk.title_en) ? tk.title_en : tk.title;
                    
                    const isGen = (!tk.command_id && !tk.direction_id) ? t.general : "";
                    taskSel.innerHTML += `<option value="${tk.id}">${displayTitle}${isGen} (+${tk.points})</option>`;
                });
            }
        }

        function renderTables() {
            const container = document.getElementById('tablesContainer');
            const t = translations[currentLang];
            container.innerHTML = '';
            appData.my_direction.forEach(dir => {
                const dId = String(dir.id || dir);
                const dirSubmissions = appData.history.filter(s => {
                    const tDir = extractId(s.task_details, 'direction');
                    const tCmd = extractId(s.task_details, 'command');
                    return tDir === dId || (!tDir && !tCmd);
                });
                container.innerHTML += createTableHTML(dir.name || "Direction", t.dirSub, dirSubmissions);
            });
            appData.my_commands.forEach(cmd => {
                const cId = String(cmd.id || cmd);
                const cmdSubmissions = appData.history.filter(s => extractId(s.task_details, 'command') === cId);
                container.innerHTML += createTableHTML(cmd.title, t.cmdSub, cmdSubmissions);
            });
            if (container.innerHTML === '') container.innerHTML = `<div class="glass-card text-center py-10"><p class="text-gray-400">${t.historyEmpty}</p></div>`;
        }

function createTableHTML(title, subtitle, submissions) {
            const t = translations[currentLang];
            const totalPoints = submissions.filter(s => s.status === 'approved').reduce((sum, s) => sum + (s.points_awarded !== null ? parseFloat(s.points_awarded) : (parseFloat(s.task_details?.points) || 0)), 0);
            
            const rows = submissions.length === 0 ? `<tr><td colspan="3" class="text-center text-gray-500 py-6 text-xs italic">${t.noRecords}</td></tr>` : submissions.map(s => {
                const displayPoints = (s.status === 'approved' && s.points_awarded !== null) ? s.points_awarded : (s.task_details?.points || 0);
                
                // –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –Ø–ó–´–ö–ê –î–õ–Ø –ò–°–¢–û–†–ò–ò
                // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –≤ task_details API —Ç–∞–∫–∂–µ –æ—Ç–¥–∞–µ—Ç title_en
                const taskTitle = (currentLang === 'en' && s.task_details?.title_en) 
                    ? s.task_details.title_en 
                    : (s.task_details?.title || t.delTask);

                return `
                    <tr>
                        <td class="text-gray-400 font-mono text-[10px]">${new Date(s.created_at).toLocaleDateString()}</td>
                        <td>
                            <div class="font-bold text-white text-xs md:text-sm">${taskTitle}</div>
                            <div class="mt-1">${getStatusBadge(s.status, s.status_display)}</div>
                        </td>
                        <td class="text-right font-black text-white">+${parseFloat(displayPoints).toFixed(1)}</td>
                    </tr>`;
            }).join('');

            return `
                <div class="glass-card">
                    <div class="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
                        <div>
                            <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-1">${subtitle}</p>
                            <h2 class="text-xl md:text-2xl font-black italic uppercase text-white">${title}</h2>
                        </div>
                        <div class="text-right bg-white/5 px-3 py-2 rounded-xl">
                            <p class="text-[9px] text-gray-500 font-bold uppercase">${t.total}</p>
                            <p class="text-xl font-black text-primary leading-none">${totalPoints.toFixed(1)}</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="custom-table">${rows}</table>
                    </div>
                </div>`;
        }

        function getStatusBadge(status, text) {
            const styles = { 'approved': 'bg-green-500/10 text-green-400 border-green-500/20', 'rejected': 'bg-red-500/10 text-red-400 border-red-500/20', 'pending': 'bg-orange-500/10 text-orange-400 border-orange-500/20' };
            const icons = { 'approved': 'fa-check', 'rejected': 'fa-times', 'pending': 'fa-clock' };
            return `<span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md border text-[9px] font-bold uppercase tracking-wider ${styles[status] || styles['pending']}"><i class="fas ${icons[status] || 'fa-question'}"></i>${text || status}</span>`;
        }

        async function sendReport() {
            const btn = document.getElementById('sendBtn');
            const taskId = document.getElementById('taskSelect').value;
            const t = translations[currentLang];
            if (!taskId) return showToast(t.toastMiss, "error");
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;
            btn.disabled = true;
            try {
                const res = await fetch('/api/activities/', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ task: taskId, description: document.getElementById('taskComm').value }) });
                if(res.ok) { 
                    showToast(t.toastSent);
                    document.getElementById('taskComm').value = ""; 
                    const hRes = await fetch('/api/activities/', { headers: {'Authorization': `Bearer ${token}`} });
                    appData.history = await hRes.json();
                    renderTables();
                } else showToast(t.toastFail, "error");
            } catch (e) { showToast(t.toastErr, "error"); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        }

        init();
    </script>
</body>
</html>