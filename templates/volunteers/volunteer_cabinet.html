<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–æ–π –ö–∞–±–∏–Ω–µ—Ç</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/qFYrFSnD/2105176-1-removebg-preview.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00c6ff; --bg: #020408; --glass: rgba(15, 23, 42, 0.85); }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; background-image: radial-gradient(circle at 50% -20%, #10192e 0%, #020408 100%); min-height: 100vh; padding: 20px; overflow-x: hidden; }
        
        .glass-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 24px; transition: transform 0.2s; }
        
        /* –ü–æ–ª—è –∏ —Å–ø–∏—Å–∫–∏ */
        .input-field { 
            background: rgba(0, 198, 255, 0.03); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 16px; 
            padding: 14px 16px; 
            width: 100%; 
            color: white; 
            outline: none; 
            margin-bottom: 16px; 
            font-size: 14px; 
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .input-field:focus { 
            border-color: var(--primary); 
            background: rgba(0, 198, 255, 0.08); 
            box-shadow: 0 0 15px rgba(0, 198, 255, 0.1);
        }

        select.input-field {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2300c6ff'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
            padding-right: 2.5rem;
        }

        select.input-field:hover { border-color: rgba(0, 198, 255, 0.5); }
        select.input-field option { background-color: #0f172a; color: white; padding: 12px; }

        .btn-send { background: var(--primary); color: black; font-weight: 800; width: 100%; padding: 16px; border-radius: 16px; text-transform: uppercase; letter-spacing: 0.05em; transition: 0.3s; box-shadow: 0 4px 15px rgba(0, 198, 255, 0.3); }
        .btn-send:active { transform: scale(0.98); }
        
        .custom-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-top: 10px; }
        .custom-table th { text-align: left; padding: 0 12px; font-size: 10px; text-transform: uppercase; color: #6b7280; letter-spacing: 0.05em; }
        .custom-table td { padding: 12px; font-size: 13px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); }
        .custom-table tr td:first-child { border-radius: 12px 0 0 12px; border-right: none; }
        .custom-table tr td:last-child { border-radius: 0 12px 12px 0; border-left: none; }
        .custom-table tr td:nth-child(2) { border-left: none; border-right: none; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; padding: 16px; border-radius: 16px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-left: 4px solid var(--primary); color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: translateX(100%); transition: transform 0.3s ease-out; display: flex; align-items: center; gap: 12px; }
        .toast.show { transform: translateX(0); }
        .toast.error { border-color: #ef4444; }
        .toast.success { border-color: #22c55e; }

        @media (max-width: 768px) {
            body { padding: 16px; padding-bottom: 80px; }
            .glass-card { padding: 20px; border-radius: 20px; }
            #vName { font-size: 1.5rem; }
            #vPoints, #vYellowCards { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
            <div>
                <h1 id="vName" class="text-3xl md:text-4xl font-black italic uppercase leading-none">...</h1>
                <div class="flex items-center gap-2 mt-2">
                    <span class="w-8 h-[2px] bg-primary"></span>
                    <p id="vRole" class="text-gray-400 text-[10px] font-bold tracking-[0.2em] uppercase">–ó–∞–≥—Ä—É–∑–∫–∞</p>
                </div>
            </div>
            
            <div class="w-full md:w-auto glass-card flex justify-between items-center gap-6 py-3 px-6 border-primary/20">
                <div>
                    <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-1">–í–∞—à —Å—á–µ—Ç</p>
                    <p id="vPoints" class="text-3xl font-black text-primary italic leading-none">0</p>
                </div>

                <div class="w-[1px] h-8 bg-white/10"></div>

                <div>
                    <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-1">–ñ–ö</p>
                    <p id="vYellowCards" class="text-3xl font-black text-orange-500 italic leading-none">0</p>
                </div>

                <button onclick="logout()" class="ml-2 w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition-all">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1">
                <div class="glass-card lg:sticky lg:top-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary">
                            <i class="fas fa-paper-plane text-xs"></i>
                        </div>
                        <h3 class="font-black italic uppercase text-white text-lg">–ù–æ–≤—ã–π –æ—Ç—á–µ—Ç</h3>
                    </div>
                    
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-2 block tracking-wider">1. –ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º?</label>
                    <select id="contextSelect" class="input-field" onchange="updateTaskDropdown()">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                    </select>

                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-2 block tracking-wider">2. –ö–∞–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ?</label>
                    <select id="taskSelect" class="input-field">
                        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
                    </select>

                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-2 block tracking-wider">3. –°—Å—ã–ª–∫–∞ / –û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="taskComm" class="input-field h-24 resize-none" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ Google Drive –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ —Ä–∞–±–æ—Ç—É..."></textarea>

                    <button onclick="sendReport()" id="sendBtn" class="btn-send flex items-center justify-center gap-2">
                        <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                        <i class="fas fa-arrow-right text-xs"></i>
                    </button>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6" id="tablesContainer">
                <div class="glass-card flex flex-col items-center justify-center py-20 text-center">
                    <i class="fas fa-circle-notch fa-spin text-primary text-2xl mb-4"></i>
                    <p class="text-gray-500 text-sm font-medium">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...</p>
                </div>
            </div>
        </div>
    </div>

   <script>
        const token = localStorage.getItem('access');
        
        let appData = {
            my_direction: [],
            my_commands: [],
            available_tasks: [],
            history: []
        };

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${icon} text-lg"></i> <span class="text-sm font-semibold">${message}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function logout() { localStorage.clear(); location.href = '/login/'; }

        // --- –§–£–ù–ö–¶–ò–Ø –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø ID ---
        function extractId(obj, fieldName) {
            if (!obj) return null;
            
            // 1. –ò—â–µ–º –ø–æ–ª–µ _id (direction_id / command_id)
            const directId = obj[`${fieldName}_id`];
            if (directId !== undefined && directId !== null) return String(directId);

            // 2. –ò—â–µ–º –≤–ª–æ–∂–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç (direction.id / command.id)
            const val = obj[fieldName];
            if (val && typeof val === 'object' && val.id) return String(val.id);
            
            // 3. –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ ID (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ —á–∏—Å–ª–æ)
            if (val !== undefined && val !== null && typeof val !== 'object') return String(val);

            return null; 
        }

        const toArray = (data) => {
            if (!data) return [];
            return Array.isArray(data) ? data : [data];
        };

        async function init() {
            if(!token) return location.href = '/login/';

            try {
                const [uRes, dRes, hRes] = await Promise.all([
                    fetch('/api/profile/', { headers: {'Authorization': `Bearer ${token}`}}),
                    fetch('/api/discovery/', { headers: {'Authorization': `Bearer ${token}`}}),
                    fetch('/api/activities/', { headers: {'Authorization': `Bearer ${token}`}})
                ]);

                if (uRes.status === 401 || dRes.status === 401) { logout(); return; }
                if (!uRes.ok) throw new Error("Auth failed");

                const user = await uRes.json();
                const disc = await dRes.json();
                const hist = await hRes.json();

                // –û–¢–õ–ê–î–ö–ê
                console.log("üì• –í—Å–µ –∑–∞–¥–∞—á–∏:", disc.available_tasks);

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                document.getElementById('vName').innerText = user.name || user.login;
                document.getElementById('vRole').innerText = user.role_display || "–í–æ–ª–æ–Ω—Ç–µ—Ä";
                document.getElementById('vPoints').innerText = user.point || 0;
                document.getElementById('vYellowCards').innerText = user.yellow_card || 0;

                appData.my_direction = toArray(disc.my_direction);
                appData.my_commands = toArray(disc.my_commands);
                appData.available_tasks = toArray(disc.available_tasks);
                appData.history = hist;

                renderContextSelect();
                renderTables();

            } catch(e) { 
                console.error(e);
                showToast("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.", "error");
            }
        }

        function renderContextSelect() {
            const sel = document.getElementById('contextSelect');
            sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ, –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å...</option>';
            
            // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            appData.my_direction.forEach(dir => {
                const dId = dir.id || dir; 
                const dName = dir.name || "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"; 
                sel.innerHTML += `<option value="dir_${dId}">üîπ ${dName}</option>`;
            });

            // –ö–æ–º–∞–Ω–¥—ã
            appData.my_commands.forEach(cmd => {
                const cId = cmd.id || cmd;
                sel.innerHTML += `<option value="cmd_${cId}">üî∏ –ö–æ–º–∞–Ω–¥–∞: ${cmd.title}</option>`;
            });

            if (appData.my_direction.length === 0 && appData.my_commands.length === 0) {
                sel.innerHTML = '<option value="">–í—ã –ø–æ–∫–∞ –Ω–∏–≥–¥–µ –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ</option>';
            }
        }

        function updateTaskDropdown() {
            const contextVal = document.getElementById('contextSelect').value;
            const taskSel = document.getElementById('taskSelect');
            taskSel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ...</option>';
            
            if (!contextVal) return;

            const [type, idStr] = contextVal.split('_');
            const targetId = String(idStr);

            console.log(`üîé –§–∏–ª—å—Ç—Ä: –¢–∏–ø=${type}, ID=${targetId}`);

            const relevantTasks = appData.available_tasks.filter(t => {
                const taskDirId = extractId(t, 'direction');
                const taskCmdId = extractId(t, 'command');

                // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---
                // –ó–∞–¥–∞—á–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è "–û–±—â–µ–π", –µ—Å–ª–∏ —É –Ω–µ—ë –Ω–µ—Ç –Ω–∏ –ö–æ–º–∞–Ω–¥—ã, –Ω–∏ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                const isGeneralTask = !taskCmdId && !taskDirId;

                if (type === 'dir') {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ —Å–æ–≤–ø–∞–ª–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–õ–ò –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –æ–±—â–∞—è
                    return (taskDirId === targetId) || isGeneralTask;
                }
                if (type === 'cmd') {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ —Å–æ–≤–ø–∞–ª–∞ –∫–æ–º–∞–Ω–¥–∞ –ò–õ–ò –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –æ–±—â–∞—è
                    return (taskCmdId === targetId) || isGeneralTask;
                }
                return false;
            });

            console.log(`–ù–∞–π–¥–µ–Ω–æ –∑–∞–¥–∞—á: ${relevantTasks.length}`);

            if (relevantTasks.length === 0) {
                taskSel.innerHTML = '<option value="">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</option>';
            } else {
                relevantTasks.forEach(t => {
                    // –î–æ–±–∞–≤–∏–º –ø–æ–º–µ—Ç–∫—É (–û–±—â–∞—è), –µ—Å–ª–∏ —ç—Ç–æ –æ–±—â–∞—è –∑–∞–¥–∞—á–∞
                    const isGen = (!t.command_id && !t.direction_id) ? " (–û–±—â–∞—è)" : "";
                    taskSel.innerHTML += `<option value="${t.id}">${t.title}${isGen} (+${t.points})</option>`;
                });
            }
        }

        function renderTables() {
            const container = document.getElementById('tablesContainer');
            container.innerHTML = '';

            // –ò—Å—Ç–æ—Ä–∏—è –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
            appData.my_direction.forEach(dir => {
                const dId = String(dir.id || dir);
                const dName = dir.name || "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ";
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é + –û–±—â–∏–µ –∑–∞–¥–∞—á–∏, –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –≤ —Ä–∞–º–∫–∞—Ö —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–µ—Å–ª–∏ –±—ã –º—ã —Ö—Ä–∞–Ω–∏–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç)
                // –ù–æ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ª—É—á—à–µ –ø—Ä–æ—Å—Ç–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ —Ñ–∞–∫—Ç—É –ø—Ä–∏–≤—è–∑–∫–∏ –∑–∞–¥–∞—á–∏
                const dirSubmissions = appData.history.filter(s => {
                    const tDir = extractId(s.task_details, 'direction');
                    const tCmd = extractId(s.task_details, 'command');
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–¥–∞—á—É –∑–¥–µ—Å—å, –µ—Å–ª–∏ –æ–Ω–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —ç—Ç–æ–º—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ò–õ–ò –æ–Ω–∞ –æ–±—â–∞—è (–Ω–µ—Ç –ø—Ä–∏–≤—è–∑–æ–∫)
                    return tDir === dId || (!tDir && !tCmd);
                });
                container.innerHTML += createTableHTML(dName, "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ + –û–±—â–∏–µ", dirSubmissions);
            });

            // –ò—Å—Ç–æ—Ä–∏—è –ö–æ–º–∞–Ω–¥
            appData.my_commands.forEach(cmd => {
                const cId = String(cmd.id || cmd);
                const cmdSubmissions = appData.history.filter(s => extractId(s.task_details, 'command') === cId);
                container.innerHTML += createTableHTML(cmd.title, "–°–ø–µ—Ü. –ö–æ–º–∞–Ω–¥–∞", cmdSubmissions);
            });

            if (container.innerHTML === '') {
                container.innerHTML = `
                    <div class="glass-card text-center py-10">
                        <i class="fas fa-wind text-4xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.</p>
                    </div>`;
            }
        }

        function createTableHTML(title, subtitle, submissions) {
            // –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –±–∞–ª–ª—ã (points_awarded), –∞ –Ω–µ –±–∞–∑–æ–≤—ã–µ –∏–∑ –∑–∞–¥–∞—á–∏
            const totalPoints = submissions
                .filter(s => s.status === 'approved')
                .reduce((sum, s) => {
                    // –ï—Å–ª–∏ –∫—É—Ä–∞—Ç–æ—Ä –≤–ø–∏—Å–∞–ª –±–∞–ª–ª—ã –≤—Ä—É—á–Ω—É—é, –±–µ—Ä–µ–º –∏—Ö, –∏–Ω–∞—á–µ –±–∞–∑–æ–≤—ã–µ
                    const actualPoints = s.points_awarded !== null ? parseFloat(s.points_awarded) : (parseFloat(s.task_details?.points) || 0);
                    return sum + actualPoints;
                }, 0);
            
            const rows = submissions.length === 0 
                ? `<tr><td colspan="3" class="text-center text-gray-500 py-6 text-xs italic">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>`
                : submissions.map(s => {
                    // –õ–û–ì–ò–ö–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –ë–ê–õ–õ–û–í –î–õ–Ø –°–¢–†–û–ö–ò
                    // –ï—Å–ª–∏ –æ–¥–æ–±—Ä–µ–Ω–æ –∏ –µ—Å—Ç—å points_awarded ‚Äî –±–µ—Ä–µ–º –∏—Ö. –í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö ‚Äî –±–∞–∑–æ–≤—ã–µ.
                    const displayPoints = (s.status === 'approved' && s.points_awarded !== null) 
                        ? s.points_awarded 
                        : (s.task_details?.points || 0);

                    return `
                    <tr>
                        <td class="text-gray-400 font-mono text-[10px]">${new Date(s.created_at).toLocaleDateString()}</td>
                        <td>
                            <div class="font-bold text-white text-xs md:text-sm line-clamp-1">${s.task_details?.title || '–ó–∞–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ'}</div>
                            <div class="flex items-center gap-2 mt-1">
                                ${getStatusBadge(s.status, s.status_display)}
                            </div>
                        </td>
                        <td class="text-right font-black text-white">+${parseFloat(displayPoints).toFixed(1)}</td>
                    </tr>
                `}).join('');

            // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            return `
                <div class="glass-card">
                    <div class="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
                        <div>
                            <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-1">${subtitle}</p>
                            <h2 class="text-xl md:text-2xl font-black italic uppercase text-white">${title}</h2>
                        </div>
                        <div class="text-right bg-white/5 px-3 py-2 rounded-xl">
                            <p class="text-[9px] text-gray-500 font-bold uppercase">–í—Å–µ–≥–æ</p>
                            <p class="text-xl font-black text-primary leading-none">${totalPoints.toFixed(1)}</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="custom-table">
                            ${rows}
                        </table>
                    </div>
                </div>
            `;
        }

        function getStatusBadge(status, text) {
            const styles = {
                'approved': 'bg-green-500/10 text-green-400 border-green-500/20',
                'rejected': 'bg-red-500/10 text-red-400 border-red-500/20',
                'pending': 'bg-orange-500/10 text-orange-400 border-orange-500/20'
            };
            const icons = { 'approved': 'fa-check', 'rejected': 'fa-times', 'pending': 'fa-clock' };
            return `
                <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md border text-[9px] font-bold uppercase tracking-wider ${styles[status] || styles['pending']}">
                    <i class="fas ${icons[status] || 'fa-question'}"></i>
                    ${text || status}
                </span>
            `;
        }

        async function sendReport() {
            const btn = document.getElementById('sendBtn');
            const taskId = document.getElementById('taskSelect').value;
            const comment = document.getElementById('taskComm').value;

            if (!taskId) return showToast("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ!", "error");
            
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;
            btn.disabled = true;
            
            try {
                const res = await fetch('/api/activities/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ task: taskId, description: comment })
                });
                
                if(res.ok) { 
                    showToast("–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
                    document.getElementById('taskComm').value = ""; 
                    const hRes = await fetch('/api/activities/', { headers: {'Authorization': `Bearer ${token}`} });
                    appData.history = await hRes.json();
                    renderTables();
                } else {
                    showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ", "error");
                }
            } catch (e) {
                showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        init();
    </script>
</body>
</html>