<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–æ–π –ö–∞–±–∏–Ω–µ—Ç</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/qFYrFSnD/2105176-1-removebg-preview.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00c6ff; --bg: #020408; --glass: rgba(15, 23, 42, 0.85); }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; background-image: radial-gradient(circle at 50% -20%, #10192e 0%, #020408 100%); min-height: 100vh; padding: 20px; overflow-x: hidden; }
        
        .glass-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 24px; transition: transform 0.2s; }
        
        .input-field { 
            background: rgba(0, 198, 255, 0.03); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 16px; 
            padding: 14px 16px; 
            width: 100%; 
            color: white; 
            outline: none; 
            margin-bottom: 16px; 
            font-size: 14px; 
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .input-field:focus { 
            border-color: var(--primary); 
            background: rgba(0, 198, 255, 0.08); 
            box-shadow: 0 0 15px rgba(0, 198, 255, 0.1);
        }

        select.input-field {
            appearance: none; -webkit-appearance: none; -moz-appearance: none; cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2300c6ff'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3e");
            background-repeat: no-repeat; background-position: right 1rem center; background-size: 1.2em; padding-right: 2.5rem;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .scroll-item {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-snap-align: center;
            transition: all 0.2s;
        }
        /* –≠—Ñ—Ñ–µ–∫—Ç —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ */
        .scroll-item.active {
            color: #fff;
            transform: scale(1.1);
            filter: blur(0);
        }
        .scroll-item:not(.active) {
            color: rgba(255,255,255,0.2);
            filter: blur(0.5px);
        }
        
        select.input-field:hover { border-color: rgba(0, 198, 255, 0.5); }
        select.input-field option { background-color: #0f172a; color: white; padding: 12px; }

        .lang-btn { font-size: 10px; font-weight: 900; color: #64748b; cursor: pointer; transition: 0.3s; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 8px; }
        .lang-btn.active { color: var(--primary); border-color: var(--primary); background: rgba(0, 198, 255, 0.05); }

        input[type="date"] { color-scheme: dark; }
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; filter: invert(1); opacity: 0.6; transition: 0.3s; }
        input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }

        input[type="file"]::file-selector-button { background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; margin-right: 10px; transition: 0.3s; }
        input[type="file"]::file-selector-button:hover { background: var(--primary); color: black; }

        .btn-send { background: var(--primary); color: black; font-weight: 800; width: 100%; padding: 16px; border-radius: 16px; text-transform: uppercase; letter-spacing: 0.05em; transition: 0.3s; box-shadow: 0 4px 15px rgba(0, 198, 255, 0.3); }
        .btn-send:active { transform: scale(0.98); }

        .btn-logout { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); font-weight: 700; width: 100%; padding: 14px; border-radius: 16px; transition: 0.3s; margin-top: 12px; font-size: 14px; }
        .btn-logout:hover { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; }
        
        .custom-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-top: 10px; }
        .custom-table th { text-align: left; padding: 0 12px; font-size: 10px; text-transform: uppercase; color: #6b7280; letter-spacing: 0.05em; }
        .custom-table td { padding: 12px; font-size: 13px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); }
        .custom-table tr td:first-child { border-radius: 12px 0 0 12px; border-right: none; }
        .custom-table tr td:last-child { border-radius: 0 12px 12px 0; border-left: none; }
        .custom-table tr td:nth-child(2) { border-left: none; border-right: none; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px); }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-content { max-width: 500px; width: 90%; transform: scale(0.9); transition: 0.3s; }
        .modal-overlay.open .modal-content { transform: scale(1); }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; padding: 16px; border-radius: 16px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-left: 4px solid var(--primary); color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: translateX(100%); transition: transform 0.3s ease-out; display: flex; align-items: center; gap: 12px; }
        .toast.show { transform: translateX(0); }
        .toast.error { border-color: #ef4444; }
        .toast.success { border-color: #22c55e; }

        @media (max-width: 768px) {
            body { padding: 16px; padding-bottom: 80px; }
            .glass-card { padding: 20px; border-radius: 20px; }
            #vName { font-size: 1.5rem; }
            #vPoints, #vYellowCards { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div id="profileModal" class="modal-overlay">
        <div class="glass-card modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black italic uppercase text-white text-xl" id="t-editProfile">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
                <button onclick="closeProfileModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-1 block" id="t-profName">–§–ò–û</label>
                    <input type="text" id="profName" class="input-field">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-1 block" id="t-profPhone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="text" id="profPhone" class="input-field">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-1 block" id="t-profEmail">Email</label>
                    <input type="email" id="profEmail" class="input-field">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-1 block" id="t-profPhoto">–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</label>
                    <input type="file" id="profPhoto" class="input-field" accept="image/*">
                </div>
                
                <button onclick="saveProfile()" id="saveProfileBtn" class="btn-send flex items-center justify-center gap-2 mt-4">
                    <span id="t-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                    <i class="fas fa-save text-xs"></i>
                </button>

                <button onclick="logout()" class="btn-logout flex items-center justify-center gap-2">
                    <span id="t-logout">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</span>
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
            <div class="flex items-start gap-4">
                <div>
                    <h1 id="vName" class="text-3xl md:text-4xl font-black italic uppercase leading-none">...</h1>
                    <div class="flex items-center gap-2 mt-2">
                        <span class="w-8 h-[2px] bg-primary"></span>
                        <p id="vRole" class="text-gray-400 text-[10px] font-bold tracking-[0.2em] uppercase">–ó–∞–≥—Ä—É–∑–∫–∞</p>
                    </div>
                </div>
                <div class="flex gap-2 mt-1">
                    <div class="lang-btn" id="lang-ru" onclick="setLang('ru')">RU</div>
                    <div class="lang-btn" id="lang-en" onclick="setLang('en')">EN</div>
                </div>
            </div>
            
            <div class="w-full md:w-auto glass-card flex justify-between items-center gap-6 py-3 px-6 border-primary/20">
                <div>
                    <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-1" id="t-score">–í–∞—à —Å—á–µ—Ç</p>
                    <p id="vPoints" class="text-3xl font-black text-primary italic leading-none">0</p>
                </div>
                <div class="w-[1px] h-8 bg-white/10"></div>
                <div>
                    <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-1" id="t-yc">–ñ–ö</p>
                    <p id="vYellowCards" class="text-3xl font-black text-orange-500 italic leading-none">0</p>
                </div>
                
                <button onclick="openProfileModal()" class="ml-2 w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary hover:bg-primary/20 transition-all border border-primary/30 overflow-hidden relative" title="–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç">
                    <img id="headerProfileImg" src="" class="w-full h-full object-cover hidden">
                    <i id="headerProfileIcon" class="fas fa-user text-xl"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1">
                <div class="glass-card lg:sticky lg:top-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary">
                            <i class="fas fa-paper-plane text-xs"></i>
                        </div>
                        <h3 class="font-black italic uppercase text-white text-lg" id="t-newreport">–ù–æ–≤—ã–π –æ—Ç—á–µ—Ç</h3>
                    </div>
                    
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-2 block tracking-wider" id="t-step1">1. –ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º?</label>
                    <select id="contextSelect" class="input-field" onchange="updateTaskDropdown()"></select>

                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-2 block tracking-wider" id="t-step2">2. –ö–∞–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ?</label>
                    <select id="taskSelect" class="input-field"></select>

                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-2 block tracking-wider" id="t-stepDate">–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                    <input type="hidden" id="taskDate" value="">

                    <div class="relative flex h-[120px] w-full max-w-[200px] mx-auto rounded-xl border border-white/10 bg-black/60 overflow-hidden shadow-[inset_0_4px_12px_rgba(0,0,0,0.7)] mb-4">
                        <div class="absolute top-1/2 left-0 right-0 h-[40px] border-y border-primary/30 bg-primary/5 -translate-y-1/2 pointer-events-none z-10 backdrop-blur-[2px]"></div>
                        <div class="absolute inset-0 bg-gradient-to-b from-black/90 via-transparent to-black/90 pointer-events-none z-20"></div>

                        <div id="scroll-days" class="flex-1 overflow-y-scroll snap-y snap-mandatory hide-scrollbar pt-[40px] pb-[40px] text-center z-0">
                            </div>
                        <div id="scroll-months" class="flex-1 overflow-y-scroll snap-y snap-mandatory hide-scrollbar pt-[40px] pb-[40px] text-center border-l border-white/5 z-0">
                            </div>
                    </div>

                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-2 block tracking-wider" id="t-step3">3. –°—Å—ã–ª–∫–∞ / –û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="taskComm" class="input-field h-24 resize-none"></textarea>

                    <button onclick="sendReport()" id="sendBtn" class="btn-send flex items-center justify-center gap-2">
                        <span id="t-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                        <i class="fas fa-arrow-right text-xs"></i>
                    </button>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6" id="tablesContainer">
                <div class="glass-card flex flex-col items-center justify-center py-20 text-center">
                    <i class="fas fa-circle-notch fa-spin text-primary text-2xl mb-4"></i>
                    <p class="text-gray-500 text-sm font-medium" id="t-sync">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...</p>
                </div>
            </div>
        </div>
    </div>
    <div id="cancelModal" class="modal-overlay">
        <div class="glass-card modal-content border-red-500/20 max-w-sm text-center">
            <div class="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-4 border border-red-500/20">
                <i class="fas fa-exclamation-triangle text-2xl text-red-500"></i>
            </div>
            <h3 class="text-xl font-black uppercase italic text-white mb-2" id="t-cancelHeader">–û—Ç–º–µ–Ω–∞ –∑–∞—è–≤–∫–∏</h3>
            <p class="text-xs text-gray-400 mb-8" id="t-cancelConfirmText">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–æ–∑–≤–∞—Ç—å —ç—Ç–æ—Ç –æ—Ç—á–µ—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            
            <div class="flex gap-3">
                <button onclick="closeCancelModal()" class="flex-1 py-3 bg-white/5 hover:bg-white/10 text-gray-400 font-bold uppercase rounded-xl text-[10px] transition">
                    –ù–∞–∑–∞–¥
                </button>
                <button id="confirmCancelBtn" class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white font-black uppercase rounded-xl text-[10px] shadow-lg shadow-red-500/20 transition transform active:scale-95">
                    –î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
   <script>
        let currentLang = localStorage.getItem('lang') || 'ru';
        let currentUser = null; 

        // --- –£–ú–ù–´–ô FETCH –° –ê–í–¢–û-–û–ë–ù–û–í–õ–ï–ù–ò–ï–ú –¢–û–ö–ï–ù–ê ---
        async function apiFetch(url, options = {}) {
            let access = localStorage.getItem('access');
            if (!options.headers) options.headers = {};
            if (access) options.headers['Authorization'] = `Bearer ${access}`;
            
            let res = await fetch(url, options);
            
            // –ï—Å–ª–∏ –ª–æ–≤–∏–º 401 (—Ç–æ–∫–µ–Ω –ø—Ä–æ—Ç—É—Ö), –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ
            if (res.status === 401) {
                const refresh = localStorage.getItem('refresh');
                if (refresh) {
                    try {
                        const refreshRes = await fetch('/api/token/refresh/', { 
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ refresh })
                        });
                        
                        if (refreshRes.ok) {
                            const data = await refreshRes.json();
                            localStorage.setItem('access', data.access);
                            options.headers['Authorization'] = `Bearer ${data.access}`;
                            // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å
                            res = await fetch(url, options);
                        } else {
                            logout();
                        }
                    } catch (e) { logout(); }
                } else {
                    logout();
                }
            }
            return res;
        }

        const translations = {
            ru: {
                score: "–í–∞—à —Å—á–µ—Ç", yc: "–ñ–ö", newreport: "–ù–æ–≤—ã–π –æ—Ç—á–µ—Ç",
                step1: "1. –ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º?", step2: "2. –ö–∞–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ?",
                stepDate: "–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è",
                step3: "3. –°—Å—ã–ª–∫–∞ / –û–ø–∏—Å–∞–Ω–∏–µ", send: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
                sync: "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...", loading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
                chooseCtx: "–í—ã–±–µ—Ä–∏—Ç–µ, –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å...", chooseTask: "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ...",
                firstCtx: "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É", noActive: "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á",
                emptyCtx: "–í—ã –ø–æ–∫–∞ –Ω–∏–≥–¥–µ –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ", historyEmpty: "–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.",
                total: "–í—Å–µ–≥–æ", dirSub: "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ + –û–±—â–∏–µ", cmdSub: "–°–ø–µ—Ü. –ö–æ–º–∞–Ω–¥–∞",
                noRecords: "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π", delTask: "–ó–∞–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ",
                toastErr: "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.", toastSent: "–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!",
                toastMiss: "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ!", toastFail: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ",
                placeComm: "–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ Google Drive –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ —Ä–∞–±–æ—Ç—É...",
                general: " (–û–±—â–∞—è)",
                editProfile: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å", profName: "–§–ò–û", profPhone: "–¢–µ–ª–µ—Ñ–æ–Ω",
                profEmail: "Email", profPhoto: "–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è", save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
                saveSuccess: "–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!", saveErr: "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏",
                logout: "–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞",
                cancel: "–û—Ç–º–µ–Ω–∏—Ç—å",
                cancelConfirm: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?",
                cancelSuccess: "–ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"
            },
            en: {
                score: "Your Score", yc: "YC", newreport: "New Report",
                step1: "1. Where to send?", step2: "2. Which task?",
                stepDate: "Execution Date",
                step3: "3. Link / Description", send: "Submit",
                sync: "Syncing data...", loading: "Loading...",
                chooseCtx: "Choose destination...", chooseTask: "Select task...",
                firstCtx: "Choose a group first", noActive: "No active tasks",
                emptyCtx: "You are not a member yet", historyEmpty: "History is empty.",
                total: "Total", dirSub: "Direction + General", cmdSub: "Special Team",
                noRecords: "No records", delTask: "Task deleted",
                toastErr: "Connection error.", toastSent: "Report sent successfully!",
                toastMiss: "Select a task!", toastFail: "Error sending report",
                placeComm: "Paste Google Drive link or describe your work...",
                general: " (General)",
                editProfile: "Edit Profile", profName: "Full Name", profPhone: "Phone",
                profEmail: "Email", profPhoto: "Profile Photo", save: "Save",
                saveSuccess: "Profile updated!", saveErr: "Error saving profile",
                logout: "Log Out",
                cancel: "Cancel",
                cancelConfirm: "Are you sure you want to cancel this request?",
                cancelSuccess: "Request canceled"
            }
        };

        function setLang(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`lang-${lang}`).classList.add('active');

            const t = translations[lang];
            document.getElementById('t-score').innerText = t.score;
            document.getElementById('t-yc').innerText = t.yc;
            document.getElementById('t-newreport').innerText = t.newreport;
            document.getElementById('t-step1').innerText = t.step1;
            document.getElementById('t-step2').innerText = t.step2;
            document.getElementById('t-stepDate').innerText = t.stepDate;
            document.getElementById('t-step3').innerText = t.step3;
            document.getElementById('t-send').innerText = t.send;
            
            document.getElementById('t-editProfile').innerText = t.editProfile;
            document.getElementById('t-profName').innerText = t.profName;
            document.getElementById('t-profPhone').innerText = t.profPhone;
            document.getElementById('t-profEmail').innerText = t.profEmail;
            document.getElementById('t-profPhoto').innerText = t.profPhoto;
            document.getElementById('t-save').innerText = t.save;
            document.getElementById('t-logout').innerText = t.logout;
            if(document.getElementById('t-sync')) document.getElementById('t-sync').innerText = t.sync;
            document.getElementById('taskComm').placeholder = t.placeComm;

            renderContextSelect();
            updateTaskDropdown();
            renderTables();
            setupDatePicker();
        }

        let appData = {
            my_direction: [],
            my_commands: [],
            available_tasks: [],
            history: []
        };

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} text-lg"></i> <span class="text-sm font-semibold">${message}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function logout() { 
            localStorage.removeItem('access'); 
            localStorage.removeItem('refresh');
            location.href = '/login/'; 
        }

        function openProfileModal() {
            if (currentUser) {
                document.getElementById('profName').value = currentUser.name || "";
                document.getElementById('profPhone').value = currentUser.phone_number || "";
                document.getElementById('profEmail').value = currentUser.email || "";
                document.getElementById('profPhoto').value = ""; 
            }
            document.getElementById('profileModal').classList.add('open');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('open');
        }

        async function saveProfile() {
            const btn = document.getElementById('saveProfileBtn');
            const originalText = btn.innerHTML;
            const t = translations[currentLang];
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            btn.disabled = true;

            const formData = new FormData();
            formData.append('name', document.getElementById('profName').value);
            formData.append('phone_number', document.getElementById('profPhone').value);
            formData.append('email', document.getElementById('profEmail').value);
            const fileInput = document.getElementById('profPhoto');
            if (fileInput.files.length > 0) formData.append('image', fileInput.files[0]);

            try {
                const res = await apiFetch('/api/profile/', {
                    method: 'PATCH',
                    body: formData // Content-Type —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ –¥–ª—è FormData
                });
                if (res.ok) {
                    showToast(t.saveSuccess);
                    closeProfileModal();
                    init(); 
                } else showToast(t.saveErr, "error");
            } catch (e) { showToast(t.toastErr, "error"); } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        document.getElementById('profileModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('profileModal')) closeProfileModal();
        });

        function extractId(obj, fieldName) {
            if (!obj) return null;
            const directId = obj[`${fieldName}_id`];
            if (directId !== undefined && directId !== null) return String(directId);
            const val = obj[fieldName];
            if (val && typeof val === 'object' && val.id) return String(val.id);
            if (val !== undefined && val !== null && typeof val !== 'object') return String(val);
            return null; 
        }

        async function init() {
            if(!localStorage.getItem('access')) return location.href = '/login/';
            document.getElementById('taskDate').value = new Date().toISOString().split('T')[0];

            try {
                const [uRes, dRes, hRes] = await Promise.all([
                    apiFetch('/api/profile/'),
                    apiFetch('/api/discovery/'),
                    apiFetch('/api/activities/')
                ]);

                if (uRes.status === 401 || dRes.status === 401) return logout();
                if (!uRes.ok || !dRes.ok || !hRes.ok) throw new Error("Server Error");

                const user = await uRes.json();
                const disc = await dRes.json();
                const hist = await hRes.json();

                currentUser = user; 

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∞–ø–∫–∏
                const headerImg = document.getElementById('headerProfileImg');
                const headerIcon = document.getElementById('headerProfileIcon');
                if (user.image_url || user.image) {
                    headerImg.src = user.image_url || user.image;
                    headerImg.classList.remove('hidden');
                    headerIcon.classList.add('hidden');
                } else {
                    headerImg.classList.add('hidden');
                    headerIcon.classList.remove('hidden');
                }

                document.getElementById('vName').innerText = user.name || user.login;
                document.getElementById('vRole').innerText = user.role_display || "Volunteer";
                document.getElementById('vPoints').innerText = user.point || 0;
                document.getElementById('vYellowCards').innerText = user.yellow_card_count ?? user.yellow_card ?? 0;

                appData.my_direction = Array.isArray(disc.my_direction) ? disc.my_direction : (disc.my_direction ? [disc.my_direction] : []);
                appData.my_commands = Array.isArray(disc.my_commands) ? disc.my_commands : (disc.my_commands ? [disc.my_commands] : []);
                appData.available_tasks = disc.available_tasks || [];
                appData.history = hist;

                setLang(currentLang);
            } catch(e) { 
                console.error(e);
                showToast(translations[currentLang].toastErr, "error"); 
            }
        }

        function renderContextSelect() {
            const sel = document.getElementById('contextSelect');
            const t = translations[currentLang];
            sel.innerHTML = `<option value="">${t.chooseCtx}</option>`;
            appData.my_direction.forEach(dir => sel.innerHTML += `<option value="dir_${dir.id || dir}">üîπ ${dir.name || 'Direction'}</option>`);
            appData.my_commands.forEach(cmd => sel.innerHTML += `<option value="cmd_${cmd.id || cmd}">üî∏ ${cmd.title}</option>`);
            if (appData.my_direction.length === 0 && appData.my_commands.length === 0) sel.innerHTML = `<option value="">${t.emptyCtx}</option>`;
        }

    function updateTaskDropdown() {
            const contextVal = document.getElementById('contextSelect').value;
            const taskSel = document.getElementById('taskSelect');
            const t = translations[currentLang];
            
            taskSel.innerHTML = `<option value="">${contextVal ? t.chooseTask : t.firstCtx}</option>`;
            
            if (!contextVal) return;

            const [type, targetId] = contextVal.split('_');
            
            const relevantTasks = appData.available_tasks.filter(tk => {
                // --- –ë–õ–û–ö –ñ–ï–°–¢–ö–û–ô –§–ò–õ–¨–¢–†–ê–¶–ò–ò –®–¢–†–ê–§–û–í ---
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–ª–æ–≤–æ —à—Ç—Ä–∞—Ñ/penalty)
                const titleLower = (tk.title || "").toLowerCase();
                if (titleLower.includes("—à—Ç—Ä–∞—Ñ") || titleLower.includes("penalty")) return false;

                // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞ (–µ—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –æ—Ç–¥–∞–µ—Ç is_penalty)
                if (tk.is_penalty === true) return false;

                // --- –ö–û–ù–ï–¶ –§–ò–õ–¨–¢–†–ê–¶–ò–ò ---

                const tDirId = extractId(tk, 'direction');
                const tCmdId = extractId(tk, 'command');
                const isGen = !tCmdId && !tDirId;

                return type === 'dir' ? (tDirId === targetId || isGen) : (tCmdId === targetId || isGen);
            });

            if (relevantTasks.length === 0) {
                taskSel.innerHTML = `<option value="">${t.noActive}</option>`;
            } else {
                relevantTasks.forEach(tk => {
                    const displayTitle = (currentLang === 'en' && tk.title_en) ? tk.title_en : tk.title;
                    const isGen = (!tk.command_id && !tk.direction_id) ? t.general : "";
                    
                    // –ï—Å–ª–∏ –±–∞–ª–ª—ã 0 (–ø–ª–∞–≤–∞—é—â–∏–µ), —Ç–æ –ø–∏—à–µ–º "(–ü–ª–∞–≤–∞—é—â–∏–µ)" –≤–º–µ—Å—Ç–æ "(+0)"
                    const pointsDisplay = parseFloat(tk.points) > 0 ? `(+${tk.points})` : "(–ì–∏–±–∫–∏–µ –±–∞–ª–ª—ã)";
                    
                    taskSel.innerHTML += `<option value="${tk.id}">${displayTitle}${isGen} ${pointsDisplay}</option>`;
                });
            }
        }

        function setupDatePicker() {
            const scrollDays = document.getElementById('scroll-days');
            const scrollMonths = document.getElementById('scroll-months');
            const taskDateInput = document.getElementById('taskDate');

            const monthsRu = ['–Ø–ù–í', '–§–ï–í', '–ú–ê–†', '–ê–ü–†', '–ú–ê–ô', '–ò–Æ–ù', '–ò–Æ–õ', '–ê–í–ì', '–°–ï–ù', '–û–ö–¢', '–ù–û–Ø', '–î–ï–ö'];
            const monthsEn = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            const months = currentLang === 'en' ? monthsEn : monthsRu;

            // 1. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ
            function getDaysInMonth(month, year) {
                return new Date(year, month, 0).getDate();
            }

            // 2. –†–µ–Ω–¥–µ—Ä –º–µ—Å—è—Ü–µ–≤ (–¥–µ–ª–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑)
            scrollMonths.innerHTML = '';
            months.forEach((m, i) => {
                const mon = document.createElement('div');
                mon.className = 'scroll-item font-bold text-[10px] uppercase tracking-tighter';
                mon.textContent = m;
                scrollMonths.appendChild(mon);
            });

            // 3. –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –¥–Ω–µ–π
            function updateDaysList() {
                const currentMonthIdx = Math.round(scrollMonths.scrollTop / 40) + 1;
                const currentYear = new Date().getFullYear();
                const daysCount = getDaysInMonth(currentMonthIdx, currentYear);
                
                const currentDaysInDOM = scrollDays.querySelectorAll('.scroll-item').length;
                
                if (currentDaysInDOM !== daysCount) {
                    scrollDays.innerHTML = '';
                    for (let i = 1; i <= daysCount; i++) {
                        const d = document.createElement('div');
                        d.className = 'scroll-item font-black text-lg';
                        d.textContent = i.toString().padStart(2, '0');
                        scrollDays.appendChild(d);
                    }
                }
            }

            function updateSelectedDate() {
                updateDaysList(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–¥–≤–∏–≥–µ –º–µ—Å—è—Ü–∞
                
                const dIdx = Math.round(scrollDays.scrollTop / 40);
                const mIdx = Math.round(scrollMonths.scrollTop / 40);

                const itemsDays = scrollDays.querySelectorAll('.scroll-item');
                const itemsMonths = scrollMonths.querySelectorAll('.scroll-item');

                itemsDays.forEach((item, idx) => item.classList.toggle('active', idx === dIdx));
                itemsMonths.forEach((item, idx) => item.classList.toggle('active', idx === mIdx));

                const day = (dIdx + 1).toString().padStart(2, '0');
                const month = (mIdx + 1).toString().padStart(2, '0');
                const year = new Date().getFullYear();
                
                taskDateInput.value = `${year}-${month}-${day}`;
            }

            scrollDays.onscroll = updateSelectedDate;
            scrollMonths.onscroll = updateSelectedDate;

            // –ù–∞—á–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞
            const now = new Date();
            updateDaysList(); 
            setTimeout(() => {
                scrollDays.scrollTop = (now.getDate() - 1) * 40;
                scrollMonths.scrollTop = now.getMonth() * 40;
                updateSelectedDate();
            }, 50);
        }

        function renderTables() {
            const container = document.getElementById('tablesContainer');
            const t = translations[currentLang];
            container.innerHTML = '';
            
            const customSort = (a, b) => {
                const isAPending = a.status === 'pending';
                const isBPending = b.status === 'pending';
                if (isAPending && !isBPending) return -1;
                if (!isAPending && isBPending) return 1;
                return new Date(b.date || b.created_at) - new Date(a.date || a.created_at);
            };

            // 1. –°–Ω–∞—á–∞–ª–∞ –≤—ã–≤–æ–¥–∏–º —Ç–∞–±–ª–∏—Ü—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π (–ë–ï–ó —à—Ç—Ä–∞—Ñ–æ–≤)
            appData.my_direction.forEach(dir => {
                const dId = String(dir.id || dir);
                const dirSubmissions = appData.history.filter(s => {
                    if (s.is_penalty) return false; // –ò—Å–∫–ª—é—á–∞–µ–º —à—Ç—Ä–∞—Ñ—ã
                    const tDir = extractId(s.task_details, 'direction') || extractId(s, 'direction');
                    const tCmd = extractId(s.task_details, 'command') || extractId(s, 'command');
                    return (tDir === dId && !tCmd) || (!tDir && !tCmd);
                }).sort(customSort);
                
                container.innerHTML += createTableHTML(dir.name || "Direction", t.dirSub, dirSubmissions);
            });

            // 2. –ó–∞—Ç–µ–º —Ç–∞–±–ª–∏—Ü—ã —Å–ø–µ—Ü-–∫–æ–º–∞–Ω–¥ (–ë–ï–ó —à—Ç—Ä–∞—Ñ–æ–≤)
            appData.my_commands.forEach(cmd => {
                const cId = String(cmd.id || cmd);
                const cmdSubmissions = appData.history.filter(s => {
                    if (s.is_penalty) return false; // –ò—Å–∫–ª—é—á–∞–µ–º —à—Ç—Ä–∞—Ñ—ã
                    const tCmd = extractId(s.task_details, 'command') || extractId(s, 'command');
                    return tCmd === cId;
                }).sort(customSort);
                
                container.innerHTML += createTableHTML(cmd.title, t.cmdSub, cmdSubmissions);
            });

            // 3. –û–¢–î–ï–õ–¨–ù–´–ô –ë–õ–û–ö –î–õ–Ø –®–¢–†–ê–§–û–í (–ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
            const penalties = appData.history.filter(s => s.is_penalty);
            if (penalties.length > 0) {
                container.innerHTML += createPenaltyTableHTML(penalties);
            }

            if (container.innerHTML === '') {
                container.innerHTML = `<div class="glass-card text-center py-10"><p class="text-gray-400">${t.historyEmpty}</p></div>`;
            }
        }
        function createTableHTML(title, subtitle, submissions) {
            const t = translations[currentLang];
            // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–µ –±–∞–ª–ª—ã
            const totalPoints = submissions
                .filter(s => s.status === 'approved')
                .reduce((sum, s) => sum + (s.points_awarded !== null ? parseFloat(s.points_awarded) : (parseFloat(s.task_details?.points) || 0)), 0);
            
            const rows = submissions.length === 0 ? `<tr><td colspan="3" class="text-center text-gray-500 py-6 text-xs italic">${t.noRecords}</td></tr>` : submissions.map(s => {
                const displayPoints = (s.status === 'approved' && s.points_awarded !== null) ? s.points_awarded : (s.task_details?.points || 0);
                const taskTitle = (currentLang === 'en' && s.task_details?.title_en) ? s.task_details.title_en : (s.task_details?.title || t.delTask);
                
                // --- –ü–ê–†–°–ò–ù–ì –î–ê–¢–´ ---
                const dateObj = s.date ? new Date(s.date) : new Date(s.created_at);
                const day = dateObj.getDate().toString().padStart(2, '0');
                // –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π –º–µ—Å—è—Ü (Jan, Feb / –Ø–Ω–≤, –§–µ–≤)
                const monthStr = dateObj.toLocaleDateString(currentLang === 'en' ? 'en-US' : 'ru-RU', { month: 'short' })
                    .replace('.', '')
                    .slice(0, 3)
                    .toUpperCase();

                // --- –î–ò–ó–ê–ô–ù –°–ö–†–û–õ–õ–ê (–ë–£–î–ò–õ–¨–ù–ò–ö) ---
                const dateScrollWidget = `
                    <div class="relative flex items-center rounded-md border border-white/10 bg-black/40 overflow-hidden w-[64px] shadow-[inset_0_4px_8px_rgba(0,0,0,0.6)] shrink-0">
                        <div class="absolute inset-0 bg-gradient-to-b from-black/80 via-transparent to-black/80 pointer-events-none"></div>
                        <div class="absolute top-1/2 left-0 right-0 h-[1px] bg-white/5 -translate-y-1/2 pointer-events-none"></div>
                        
                        <div class="flex-1 py-1.5 flex justify-center items-center border-r border-white/5 relative z-10">
                            <span class="text-[14px] font-black text-white leading-none tracking-tighter">${day}</span>
                        </div>
                        <div class="flex-1 py-1.5 flex justify-center items-center relative z-10">
                            <span class="text-[9px] font-bold text-gray-400 uppercase leading-none">${monthStr}</span>
                        </div>
                    </div>
                `;

                // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞—è–≤–æ–∫ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏
                const cancelBtn = s.status === 'pending' 
                    ? `<button onclick="cancelSubmission(${s.id})" class="mt-2 text-[9px] text-red-500 hover:text-red-400 uppercase font-bold transition flex items-center justify-end gap-1 w-full"><i class="fas fa-trash-alt"></i> ${t.cancel}</button>` 
                    : '';

                return `
                    <tr>
                        <td class="pr-3 align-top pt-1 w-[75px]">${dateScrollWidget}</td>
                        <td>
                            <div class="font-bold text-white text-xs md:text-sm">${taskTitle}</div>
                            <div class="mt-1">${getStatusBadge(s.status, s.status_display)}</div>
                        </td>
                        <td class="text-right font-black text-white align-top">
                            <div>${parseFloat(displayPoints) > 0 ? '+' : ''}${parseFloat(displayPoints).toFixed(1)}</div>
                            ${cancelBtn}
                        </td>
                    </tr>`;
            }).join('');

            return `
                <div class="glass-card">
                    <div class="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
                        <div>
                            <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-1">${subtitle}</p>
                            <h2 class="text-xl md:text-2xl font-black italic uppercase text-white">${title}</h2>
                        </div>
                        <div class="text-right bg-white/5 px-3 py-2 rounded-xl">
                            <p class="text-[9px] text-gray-500 font-bold uppercase">${t.total}</p>
                            <p class="text-xl font-black text-primary leading-none">${totalPoints.toFixed(1)}</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="custom-table w-full text-left">${rows}</table>
                    </div>
                </div>`;
        }

        function createPenaltyTableHTML(penalties) {
            const t = translations[currentLang];
            const rows = penalties.map(p => {
                // –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã –¥–ª—è —à—Ç—Ä–∞—Ñ–æ–≤
                const dateObj = new Date(p.created_at);
                const day = dateObj.getDate().toString().padStart(2, '0');
                const monthStr = dateObj.toLocaleDateString(currentLang === 'en' ? 'en-US' : 'ru-RU', { month: 'short' })
                    .replace('.', '')
                    .slice(0, 3)
                    .toUpperCase();

                // –°–∫—Ä–æ–ª–ª-–≤–∏–¥–∂–µ—Ç –≤ –∫—Ä–∞—Å–Ω—ã—Ö —Ç–æ–Ω–∞—Ö
                const dateScrollWidget = `
                    <div class="relative flex items-center rounded-md border border-red-500/20 bg-red-950/40 overflow-hidden w-[64px] shadow-[inset_0_4px_8px_rgba(0,0,0,0.6)] shrink-0">
                        <div class="absolute inset-0 bg-gradient-to-b from-black/80 via-transparent to-black/80 pointer-events-none"></div>
                        <div class="absolute top-1/2 left-0 right-0 h-[1px] bg-red-500/10 -translate-y-1/2 pointer-events-none"></div>
                        
                        <div class="flex-1 py-1.5 flex justify-center items-center border-r border-red-500/10 relative z-10">
                            <span class="text-[14px] font-black text-red-500 leading-none tracking-tighter">${day}</span>
                        </div>
                        <div class="flex-1 py-1.5 flex justify-center items-center relative z-10">
                            <span class="text-[9px] font-bold text-red-400/80 uppercase leading-none">${monthStr}</span>
                        </div>
                    </div>
                `;

                return `
                    <tr>
                        <td class="pr-3 align-top pt-1 w-[75px]">${dateScrollWidget}</td>
                        <td>
                            <div class="font-bold text-red-400 text-xs md:text-sm uppercase italic">–®—Ç—Ä–∞—Ñ / Penalty</div>
                            <div class="text-[10px] text-gray-500 mt-1">${p.description || '–ù–∞—Ä—É—à–µ–Ω–∏–µ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∞'}</div>
                        </td>
                        <td class="text-right font-black text-red-500 align-top">
                            ${parseFloat(p.points_awarded || 0).toFixed(1)}
                        </td>
                    </tr>`;
            }).join('');

            return `
                <div class="glass-card border-red-500/10">
                    <div class="flex items-center gap-2 mb-4">
                        <i class="fas fa-gavel text-red-500 text-xs"></i>
                        <h2 class="text-sm font-black italic uppercase text-red-500 tracking-widest">–ù–∞—Ä—É—à–µ–Ω–∏—è –∏ –≤–∑—ã—Å–∫–∞–Ω–∏—è</h2>
                    </div>
                    <table class="custom-table w-full text-left">${rows}</table>
                </div>`;
        }
        function getStatusBadge(status, text) {
            const styles = { 'approved': 'bg-green-500/10 text-green-400 border-green-500/20', 'rejected': 'bg-red-500/10 text-red-400 border-red-500/20', 'pending': 'bg-orange-500/10 text-orange-400 border-orange-500/20' };
            const icons = { 'approved': 'fa-check', 'rejected': 'fa-times', 'pending': 'fa-clock' };
            return `<span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md border text-[9px] font-bold uppercase tracking-wider ${styles[status] || styles['pending']}"><i class="fas ${icons[status] || 'fa-question'}"></i>${text || status}</span>`;
        }

        let submissionToCancel = null;

        function closeCancelModal() {
            document.getElementById('cancelModal').classList.remove('open');
            submissionToCancel = null;
        }

        // –í—ã–∑–æ–≤ –º–æ–¥–∞–ª–∫–∏
        async function cancelSubmission(id) {
            submissionToCancel = id;
            const modal = document.getElementById('cancelModal');
            
            // –ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏
            const t = translations[currentLang];
            document.getElementById('t-cancelHeader').innerText = t.cancel;
            document.getElementById('t-cancelConfirmText').innerText = t.cancelConfirm;
            
            modal.classList.add('open');
            
            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –∫ –∫–Ω–æ–ø–∫–µ
            document.getElementById('confirmCancelBtn').onclick = async () => {
                const btn = document.getElementById('confirmCancelBtn');
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
                btn.disabled = true;

                try {
                    const res = await apiFetch(`/api/activities/${id}/`, { method: 'DELETE' });
                    if (res.ok || res.status === 204) {
                        showToast(t.cancelSuccess);
                        closeCancelModal();
                        init();
                    } else {
                        showToast("Error", "error");
                    }
                } catch (e) {
                    showToast("Network Error", "error");
                } finally {
                    btn.innerHTML = '–î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å';
                    btn.disabled = false;
                }
            };
        }

        async function sendReport() {
            const btn = document.getElementById('sendBtn');
            const taskId = document.getElementById('taskSelect').value;
            const taskDate = document.getElementById('taskDate').value;
            const contextVal = document.getElementById('contextSelect').value; 
            const t = translations[currentLang];

            if (!taskId) return showToast(t.toastMiss, "error");

            let commandId = null;
            let directionId = null;

            if (contextVal) {
                const [type, id] = contextVal.split('_');
                if (type === 'cmd') commandId = parseInt(id);
                if (type === 'dir') directionId = parseInt(id);
            }

            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;
            btn.disabled = true;

            try {
                const res = await apiFetch('/api/activities/', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ 
                        task: taskId, 
                        date: taskDate, 
                        description: document.getElementById('taskComm').value,
                        command: commandId,
                        direction: directionId 
                    }) 
                });
                
                if(res.ok) { 
                    showToast(t.toastSent);
                    document.getElementById('taskComm').value = ""; 
                    init(); 
                } else {
                    showToast(t.toastFail, "error");
                }
            } catch (e) { 
                showToast(t.toastErr, "error"); 
            } finally { 
                btn.innerHTML = originalText; 
                btn.disabled = false; 
            }
        }
        
        init();
    </script>
</body>
</html>