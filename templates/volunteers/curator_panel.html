<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–æ—Ä–¥ –∫–∞–±–∏–Ω–µ—Ç</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/qFYrFSnD/2105176-1-removebg-preview.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800;900&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00c6ff; --bg: #020408; --glass: rgba(15, 23, 42, 0.95); }
        body { 
            background: var(--bg); color: white; font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(circle at 50% 120%, #10192e 0%, #020408 100%); 
            min-height: 100vh; padding: 20px; padding-bottom: 80px; 
        }
        .glass-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 24px; }
        .btn-glass { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #94a3b8; transition: all 0.3s ease; border-radius: 14px; }
        .btn-glass:hover { background: rgba(255, 255, 255, 0.1); color: white; border-color: rgba(255, 255, 255, 0.3); }
        
        .tab-btn { padding: 12px 24px; font-weight: 800; text-transform: uppercase; font-size: 11px; letter-spacing: 0.1em; border-radius: 12px; transition: all 0.3s; color: #64748b; border: 1px solid transparent; white-space: nowrap; }
        .tab-btn:hover:not(.active) { color: white; background: rgba(255,255,255,0.05); }
        .tab-btn.active { background: rgba(0, 198, 255, 0.1); color: var(--primary); border-color: rgba(0, 198, 255, 0.3); box-shadow: 0 0 20px rgba(0, 198, 255, 0.15); }
        
        .app-card { 
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.08); border-radius: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer; position: relative; overflow: hidden;
        }
        .app-card:hover { 
            border-color: var(--primary); transform: translateY(-4px); 
            box-shadow: 0 10px 40px -10px rgba(0, 198, 255, 0.15); 
        }
        
        .custom-select-wrapper { position: relative; user-select: none; z-index: 50; }
        .select-trigger {
            background: rgba(0, 198, 255, 0.05); border: 1px solid rgba(0, 198, 255, 0.2);
            border-radius: 16px; padding: 12px 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: space-between;
            transition: all 0.3s ease;
        }
        .select-trigger:hover { border-color: var(--primary); background: rgba(0, 198, 255, 0.1); }
        .select-options {
            position: absolute; top: calc(100% + 8px); left: 0; right: 0;
            background: #0f172a; border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px; overflow: hidden; display: none;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5); z-index: 100;
        }
        .select-options.active { display: block; animation: slideDown 0.2s ease-out; }
        .option-item { padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .option-item:hover { background: var(--primary); color: black; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .custom-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .custom-table th { padding: 0 16px; text-align: left; font-size: 10px; text-transform: uppercase; color: #4b5563; font-weight: 900; }
        .custom-table td { padding: 16px; background: rgba(255,255,255,0.03); font-size: 13px; vertical-align: middle; }
        .custom-table td:first-child { border-radius: 16px 0 0 16px; }
        .custom-table td:last-child { border-radius: 0 16px 16px 0; }
        .score-badge { background: rgba(0, 198, 255, 0.15); color: var(--primary); padding: 4px 10px; border-radius: 8px; font-weight: 900; font-family: 'Montserrat'; }
        
        .loader-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 16px 24px; border-radius: 16px; background: rgba(15, 23, 42, 0.95); border-left: 4px solid var(--primary); color: white; transform: translateX(110%); transition: 0.3s; display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .toast.show { transform: translateX(0); }

        .nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 3.5rem; height: 3.5rem; background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; z-index: 60; color: white;
        }
        .nav-btn:hover { background: var(--primary); color: black; }
        .nav-btn.prev { left: -5rem; }
        .nav-btn.next { right: -5rem; }
        @media (max-width: 1024px) {
            .nav-btn { position: fixed; bottom: 20px; top: auto; transform: none; background: #000; border-color: var(--primary); }
            .nav-btn.prev { left: 20px; }
            .nav-btn.next { right: 20px; }
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* –ß–µ–∫–±–æ–∫—Å */
        .custom-checkbox { appearance: none; width: 20px; height: 20px; border: 2px solid #334155; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .custom-checkbox:checked { background: var(--primary); border-color: var(--primary); }
        .custom-checkbox:checked::after { content: '‚úî'; color: black; font-size: 12px; font-weight: 900; }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div id="app" class="max-w-7xl mx-auto hidden animate-fade-in">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-6">
            <div>
                <p id="cName" class="text-gray-400 text-sm font-bold uppercase tracking-widest mb-1 pl-1">...</p>
                <h1 class="text-4xl md:text-5xl font-black italic uppercase text-white leading-none">
                    Curator <span class="text-primary">Panel</span>
                </h1>
                <div class="flex items-center gap-3 mt-3">
                    <span class="w-8 h-[2px] bg-primary"></span>
                    <p id="cRole" class="text-primary font-bold text-[10px] tracking-[0.3em] uppercase">...</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <p class="text-[9px] text-gray-500 uppercase font-black">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</p>
                    <p id="managedTeamsLabel" class="text-white font-bold text-sm italic uppercase">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
                <button onclick="logout()" class="btn-glass py-3 px-6 text-xs font-bold uppercase"><i class="fas fa-power-off mr-2"></i>–í—ã—Ö–æ–¥</button>
            </div>
        </header>
        
        <div class="flex gap-3 mb-8 overflow-x-auto pb-2 scrollbar-hide">
            <button onclick="switchTab('req')" id="tab_req" class="tab-btn active"><i class="fas fa-inbox mr-2"></i>–ó–∞—è–≤–∫–∏ –Ω–∞ –±–∞–ª–ª—ã</button>
            <button onclick="switchTab('apps')" id="tab_apps" class="tab-btn"><i class="fas fa-rocket mr-2"></i>–ù–∞–±–æ—Ä –≤ –∫–æ–º–∞–Ω–¥—ã</button>
            <button onclick="switchTab('vols')" id="tab_vols" class="tab-btn"><i class="fas fa-users mr-2"></i>–ë–∞–∑–∞ –í–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤</button>
        </div>

        <div id="secReq" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 section-view">
            <div class="col-span-full flex justify-center py-20"><i class="fas fa-circle-notch loader-spin text-4xl text-primary/50"></i></div>
        </div>
        
        <div id="secApps" class="hidden section-view">
            <div class="flex flex-col md:flex-row gap-4 mb-6 justify-between items-end">
                <div class="flex bg-white/5 p-1 rounded-xl border border-white/5 w-full md:w-auto">
                    <button id="subTabPending" onclick="switchAppSubTab('pending')" class="flex-1 md:flex-none px-6 py-2.5 rounded-lg text-[10px] font-black uppercase transition-all bg-sky-400/10 text-sky-400">–û–∂–∏–¥–∞—é—Ç (<span id="cntPending">0</span>)</button>
                    <button id="subTabAccepted" onclick="switchAppSubTab('accepted')" class="flex-1 md:flex-none px-6 py-2.5 rounded-lg text-[10px] font-black uppercase transition-all text-gray-500">–ü—Ä–∏–Ω—è—Ç—ã (<span id="cntAccepted">0</span>)</button>
                </div>
                <div class="custom-select-wrapper w-full md:w-64">
                    <div class="select-trigger" id="selectTrigger">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-filter text-primary text-xs"></i>
                            <span id="selectedLabel" class="text-[10px] font-black uppercase tracking-widest text-white">–í—Å–µ –∫–æ–º–∞–Ω–¥—ã</span>
                        </div>
                        <i class="fas fa-chevron-down text-[10px] text-primary"></i>
                    </div>
                    <div class="select-options" id="selectOptions"></div>
                </div>
            </div>
            <div id="appsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="secVols" class="hidden section-view">
            <div class="flex justify-end mb-4" id="addVolBtnContainer">
                 <button onclick="openSearchModal()" class="py-3 px-6 text-xs font-black uppercase bg-white text-black hover:bg-gray-200 border border-white rounded-xl flex items-center gap-2 shadow-[0_0_20px_rgba(255,255,255,0.2)] transition-all transform hover:scale-105">
                     <i class="fas fa-user-plus text-primary"></i> –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                 </button>
            </div>

            <div class="glass-card overflow-hidden p-0 border-white/5">
                <div class="overflow-x-auto p-4">
                    <table class="custom-table w-full">
                        <thead>
                            <tr>
                                <th>–í–æ–ª–æ–Ω—Ç–µ—Ä</th>
                                <th>–ö–æ–º–∞–Ω–¥—ã</th>
                                <th>–ë–∞–ª–ª—ã (–í –∫–æ–º–∞–Ω–¥–µ / –û–±—â–∏–µ)</th>
                                <th class="text-right">–ù–∞—Ä—É—à–µ–Ω–∏—è</th>
                                <th class="text-right">–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody id="vTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="deleteModal" class="hidden fixed inset-0 bg-black/95 backdrop-blur-xl flex items-center justify-center p-4 z-[400]">
        <div class="glass-card w-full max-w-sm p-8 text-center bg-[#0f172a] border border-red-500/20 shadow-[0_0_50px_rgba(220,38,38,0.2)] relative transform transition-all scale-100">
            <div class="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-6 border border-red-500/20 shadow-[0_0_20px_rgba(220,38,38,0.1)]">
                <i class="fas fa-trash-alt text-2xl text-red-500"></i>
            </div>
            
            <h3 class="text-xl font-black uppercase italic text-white mb-2">–£–¥–∞–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
            <p class="text-xs text-gray-400 mb-8 leading-relaxed">
                –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏—Å–∫–ª—é—á–∏—Ç—å <br> 
                <span id="delVolName" class="text-white font-bold">...</span> <br>
                –∏–∑ –∫–æ–º–∞–Ω–¥—ã <span id="delTeamName" class="text-primary font-bold">...</span>?
            </p>

            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 py-3 bg-white/5 hover:bg-white/10 text-gray-400 font-bold uppercase rounded-xl text-[10px] transition">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button onclick="confirmDeleteAction()" id="btnConfirmDelete" class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white font-black uppercase rounded-xl text-[10px] shadow-lg shadow-red-500/20 transition transform active:scale-95">
                    –î–∞, —É–¥–∞–ª–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <div id="searchModal" class="hidden fixed inset-0 bg-black/95 backdrop-blur-xl flex items-center justify-center p-4 z-[300]">
        <div class="glass-card w-full max-w-lg p-0 relative bg-[#0b1121] border-primary/20 flex flex-col max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b border-white/5 bg-[#0f172a]">
                <button onclick="closeSearchModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
                <h3 class="text-xl font-black italic uppercase text-white mb-4">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É</h3>
                
                <div class="mb-4">
                    <label class="text-[10px] font-bold text-gray-500 uppercase ml-1 mb-2 block">1. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É –∫–æ–º–∞–Ω–¥—É</label>
                    <select id="targetTeamSelect" class="w-full bg-[#1e293b] border border-white/10 rounded-xl px-4 py-3 text-white text-sm outline-none focus:border-primary transition appearance-none">
                    </select>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase ml-1 mb-2 block">2. –ü–æ–∏—Å–∫ –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤</label>
                    <div class="relative">
                        <i class="fas fa-search absolute left-4 top-3.5 text-gray-500 text-xs"></i>
                        <input type="text" id="volSearchInput" oninput="filterVolunteersList()" 
                               class="w-full bg-[#1e293b] border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white text-sm focus:border-primary focus:outline-none transition" 
                               placeholder="–ò–º—è –∏–ª–∏ –ª–æ–≥–∏–Ω...">
                    </div>
                </div>
            </div>

            <div id="volSearchResults" class="flex-1 overflow-y-auto custom-scrollbar p-2 bg-[#020408]">
                </div>

            <div class="p-4 border-t border-white/5 bg-[#0f172a] flex justify-between items-center">
                <span class="text-xs text-gray-400 font-bold uppercase ml-2">–í—ã–±—Ä–∞–Ω–æ: <span id="selectedCount" class="text-primary">0</span></span>
                <button onclick="submitBulkAdd()" id="bulkAddBtn" class="py-3 px-6 bg-white/5 text-gray-500 font-black uppercase rounded-xl transition text-xs cursor-not-allowed" disabled>
                    –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
                </button>
            </div>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black/95 backdrop-blur-xl flex items-center justify-center p-2 md:p-6 z-[200]">
        <div class="relative w-full max-w-4xl">
            <button class="nav-btn prev" onclick="navigateApp(-1)"><i class="fas fa-chevron-left text-xl"></i></button>
            <button class="nav-btn next" onclick="navigateApp(1)"><i class="fas fa-chevron-right text-xl"></i></button>
            <div class="glass-card w-full rounded-[30px] p-6 md:p-10 max-h-[90vh] overflow-y-auto relative border-white/10 shadow-2xl bg-[#0b1121]">
                <button onclick="closeModal()" class="absolute top-6 right-6 text-gray-500 hover:text-white transition z-50"><i class="fas fa-times text-2xl"></i></button>
                <div id="modalContent"></div>
                <div class="mt-8 pt-8 border-t border-white/10 flex gap-4">
                    <button id="approveAppBtn" class="flex-1 py-4 bg-primary text-black font-black uppercase rounded-2xl hover:bg-white transition flex items-center justify-center gap-2 shadow-lg shadow-primary/20">
                        <i class="fas fa-check-double"></i> –ü—Ä–∏–Ω—è—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const token = localStorage.getItem('access');
    const API = {
        profile: '/api/profile/',
        submissions: '/api/curator/submissions/',
        volunteers: '/api/list/',
        commands: '/commands/',
        apps: '/commands-applications/'
    };

    let state = {
        user: null,
        submissions: [],
        volunteers: [],
        apps: [],
        commands: [],
        myManagedTeams: [],
        myLeadingTeams: [],
        appsView: [],
        appSubTab: 'pending',
        currentAppIndex: 0,
        currentCommandSlug: ''
    };

    let selectedVolIds = new Set();
    let deleteTarget = { volId: null, cmdId: null };

    let questionMap = {};
    const extractId = (obj, fieldName) => {
        if (!obj) return null;
        if (obj[`${fieldName}_id`]) return String(obj[`${fieldName}_id`]);
        if (obj[fieldName] && typeof obj[fieldName] === 'object' && obj[fieldName].id) return String(obj[fieldName].id);
        if (obj[fieldName]) return String(obj[fieldName]);
        return null;
    };
    const getIds = (data) => {
        if (!data) return [];
        const arr = Array.isArray(data) ? data : [data];
        return arr.map(item => String(item.id || item));
    };
    const getCleanAnswers = (rawAnswers) => {
        let answers = rawAnswers;
        if (typeof answers === 'string') { try { answers = JSON.parse(answers); } catch (e) { return {}; } }
        if (!answers || typeof answers !== 'object') return {};
        return answers;
    };

    async function init() {
        if (!token) return location.href = '/login/';
        try {
            const res = await fetch(API.profile, { headers: { 'Authorization': `Bearer ${token}` } });
            if (res.status === 401) return logout();
            state.user = await res.json();
            
            document.getElementById('cName').innerText = state.user.name || state.user.login;
            document.getElementById('cRole').innerText = state.user.role_display;
            document.getElementById('app').classList.remove('hidden');

            setupDropdown();
            await loadAllData();
        } catch (e) { console.error("Init Error:", e); }
    }

    function setupDropdown() {
        const trigger = document.getElementById('selectTrigger');
        const options = document.getElementById('selectOptions');
        trigger.onclick = (e) => { e.stopPropagation(); options.classList.toggle('active'); };
        window.onclick = () => options.classList.remove('active');
    }

    async function loadAllData() {
        try {
            const h = { 'Authorization': `Bearer ${token}` };
            const [sub, vol, cmd, app] = await Promise.all([
                fetch(API.submissions, { headers: h }).then(r => r.json()),
                fetch(API.volunteers, { headers: h }).then(r => r.json()),
                fetch(API.commands, { headers: h }).then(r => r.json()),
                fetch(API.apps, { headers: h }).then(r => r.json())
            ]);

            state.submissions = sub;
            if (Array.isArray(vol)) {
                state.volunteers = vol;
            } else if (vol.results) {
                state.volunteers = vol.results;
            } else {
                state.volunteers = [];
            }
            state.commands = cmd;
            state.apps = app;
            
            questionMap = {};
            state.commands.forEach(c => c.questions?.forEach(q => questionMap[`q_${q.id}`] = q.label));
            state.commands.forEach(c => c.questions?.forEach(q => questionMap[q.id] = q.label));
            state.commands.forEach(c => c.questions?.forEach(q => questionMap[String(q.id)] = q.label));

            let dbTeams = [], leadTeams = [];
            const label = document.getElementById('managedTeamsLabel');
            const myDirIds = getIds(state.user.direction);

            if (state.user.role === 'admin') {
                dbTeams = cmd; leadTeams = cmd;
                label.innerText = "–í—Å–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (Admin)";
            } else if (state.user.role === 'curator') {
                dbTeams = cmd.filter(c => myDirIds.includes(extractId(c, 'direction')));
                leadTeams = cmd.filter(c => String(c.leader?.id || c.leader) === String(state.user.id));
                const dirs = Array.isArray(state.user.direction) ? state.user.direction : [state.user.direction];
                const dirNames = dirs.map(d => d.name || d.title).filter(Boolean);
                label.innerText = dirNames.length > 0 ? dirNames.join(' / ') : "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ";
            } else {
                dbTeams = cmd.filter(c => String(c.leader?.id || c.leader) === String(state.user.id));
                leadTeams = dbTeams;
                label.innerText = dbTeams.map(t => t.title).join(' / ') || "–ö–æ–º–∞–Ω–¥–∞ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞";
            }

            state.myManagedTeams = dbTeams;
            state.myLeadingTeams = leadTeams;

            if (leadTeams.length === 0 && state.user.role !== 'admin') {
                document.getElementById('addVolBtnContainer').style.display = 'none';
            }

            renderCommandFilter();
            renderSubmissions();
            renderVolunteers();
            filterAndRenderApps();
        } catch (e) { console.error("Load Data Error:", e); }
    }

    // ============================================
    //  –õ–û–ì–ò–ö–ê –¢–ê–ë–õ–ò–¶–´ –í–û–õ–û–ù–¢–ï–†–û–í –ò –£–î–ê–õ–ï–ù–ò–Ø
    // ============================================

    function renderVolunteers() {
        const table = document.getElementById('vTable');
        if (!table) return;

        const isAdmin = state.user.role === 'admin';
        const isCurator = state.user.role === 'curator';
        
        // –ü–æ–ª—É—á–∞–µ–º ID —Ç–≤–æ–∏—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
        const myDirIds = getIds(state.user.direction); 
        const myManagedTeamIds = state.myManagedTeams.map(t => String(t.id));

        let myVolunteers = [];

        if (isAdmin) {
            // –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å–µ—Ö
            myVolunteers = state.volunteers;
        } else if (isCurator) {
            // üî• –ö–£–†–ê–¢–û–†: –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–µ—Ö, –∫—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –µ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º
            myVolunteers = state.volunteers.filter(v => {
                const vDirIds = getIds(v.direction);
                // –ï—Å–ª–∏ —É –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞ –µ—Å—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, —Å–æ–≤–ø–∞–¥–∞—é—â–µ–µ —Å –∫—É—Ä–∞—Ç–æ—Ä—Å–∫–∏–º
                const hasDirMatch = vDirIds.some(id => myDirIds.includes(id));
                
                // –¢–∞–∫–∂–µ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤ —Ç–≤–æ–µ–π –ª–∏ –æ–Ω –∫–æ–º–∞–Ω–¥–µ (managed)
                const vCmdIds = getIds(v.volunteer_commands || v.commands);
                const hasCmdMatch = vCmdIds.some(id => myManagedTeamIds.includes(id));

                return hasDirMatch || hasCmdMatch;
            });
        } else {
            // –¢–ò–ú–õ–ò–î: –í–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, –∫—Ç–æ –≤ –µ–≥–æ –∫–æ–º–∞–Ω–¥–∞—Ö
            myVolunteers = state.volunteers.filter(v => {
                const vCmdIds = getIds(v.volunteer_commands || v.commands);
                return vCmdIds.some(id => myManagedTeamIds.includes(id));
            });
        }

        table.innerHTML = myVolunteers.map(v => {
            const totalPoints = parseFloat(v.point || 0).toFixed(1);
            const localPoints = parseFloat(v.local_points || 0).toFixed(1);
            const vCommands = v.volunteer_commands || v.commands || [];
            
            // –î–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è: –∏—â–µ–º –∫–æ–º–∞–Ω–¥—É, –∫–æ—Ç–æ—Ä–æ–π —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π —é–∑–µ—Ä
            const myManagedIds = state.myManagedTeams.map(t => String(t.id));
            const targetCmd = vCommands.find(c => myManagedIds.includes(String(c.id || c)));
            const targetCmdId = targetCmd ? String(targetCmd.id || targetCmd) : null;
            const targetCmdName = targetCmd ? (targetCmd.title || '–ö–æ–º–∞–Ω–¥–∞') : '–ö–æ–º–∞–Ω–¥–∞';
            
            const safeName = (v.name || v.login || 'User').replace(/'/g, "\\'");

            return `
            <tr class="hover:bg-white/5 transition border-b border-white/5 group">
                <td class="py-3 px-4">
                    <div class="font-black uppercase text-sm italic text-white leading-none">${v.name || v.login || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                    <div class="text-[10px] text-gray-500 font-mono mt-1">${v.login}</div>
                </td>
                <td class="py-3 px-4">
                    <div class="flex flex-wrap gap-1">
                        ${vCommands.length > 0 
                            ? vCommands.map(c => `<span class="bg-white/5 text-gray-400 text-[8px] px-2 py-0.5 rounded font-black uppercase">${c.title || c.name || '–ö–æ–º–∞–Ω–¥–∞'}</span>`).join('')
                            : '<span class="text-[8px] text-gray-600 italic">–ë–µ–∑ –∫–æ–º–∞–Ω–¥—ã</span>'
                        }
                    </div>
                </td>
                <td class="py-3 px-4">
                    <div class="flex items-center gap-2">
                        <div class="flex flex-col items-center">
                            <span class="text-primary font-black text-sm">${localPoints}</span>
                            <span class="text-[8px] text-primary/50 uppercase">–í –∫–æ–º–∞–Ω–¥–µ</span>
                        </div>
                        <span class="text-gray-600">/</span>
                        <div class="flex flex-col items-center">
                            <span class="text-white font-bold text-xs">${totalPoints}</span>
                            <span class="text-[8px] text-gray-600 uppercase">–í—Å–µ–≥–æ</span>
                        </div>
                    </div>
                </td>
                <td class="py-3 px-4 text-right font-black ${v.yellow_card_count > 0 ? 'text-red-400' : 'text-gray-600'}">
                    ${v.yellow_card_count || 0} <i class="fas fa-exclamation-triangle text-[10px] ml-1 opacity-50"></i>
                </td>
                <td class="py-3 px-4 text-right">
                    ${targetCmdId ? 
                        `<button onclick="openDeleteModal(${v.id}, ${targetCmdId}, '${safeName}', '${targetCmdName}')" 
                            class="w-8 h-8 rounded-lg bg-white text-red-600 hover:bg-red-50 transition flex items-center justify-center border border-white ml-auto">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>` : ''}
                </td>
            </tr>`;
        }).join('');
    }

    // --- –£–î–ê–õ–ï–ù–ò–ï ---
    function openDeleteModal(volId, cmdId, volName, cmdName) {
        deleteTarget = { volId, cmdId };
        
        document.getElementById('delVolName').innerText = volName;
        document.getElementById('delTeamName').innerText = cmdName;
        
        const btn = document.getElementById('btnConfirmDelete');
        btn.innerText = '–î–∞, —É–¥–∞–ª–∏—Ç—å';
        btn.disabled = false;
        
        document.getElementById('deleteModal').classList.remove('hidden');
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
    }

    async function confirmDeleteAction() {
        if (!deleteTarget.volId || !deleteTarget.cmdId) return;

        const btn = document.getElementById('btnConfirmDelete');
        btn.innerText = '–£–¥–∞–ª–µ–Ω–∏–µ...';
        btn.disabled = true;

        try {
            const res = await fetch(`/commands/${deleteTarget.cmdId}/remove-volunteer/`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ volunteer_id: deleteTarget.volId })
            });
            
            if(res.ok) {
                showToast(`üóëÔ∏è –£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª–µ–Ω`);
                closeDeleteModal();
                setTimeout(loadAllData, 500);
            } else {
                const d = await res.json();
                showToast(d.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                btn.innerText = '–û—à–∏–±–∫–∞';
            }
        } catch(e) { 
            console.error(e); 
            showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            btn.innerText = '–û—à–∏–±–∫–∞';
        }
    }

    // ============================================

    function openSearchModal() {
        const modal = document.getElementById('searchModal');
        const select = document.getElementById('targetTeamSelect');
        
        selectedVolIds.clear();
        updateBulkBtn();
        document.getElementById('volSearchInput').value = '';

        select.innerHTML = '';
        if (state.myLeadingTeams.length === 0) {
            select.innerHTML = '<option disabled selected>–ù–µ—Ç –∫–æ–º–∞–Ω–¥</option>';
        } else {
            state.myLeadingTeams.forEach(t => {
                select.innerHTML += `<option value="${t.id}">${t.title}</option>`;
            });
        }

        renderVolList(state.volunteers);
        modal.classList.remove('hidden');
    }

    function closeSearchModal() {
        document.getElementById('searchModal').classList.add('hidden');
    }

    function renderVolList(volArray) {
        const container = document.getElementById('volSearchResults');
        if (volArray.length === 0) {
            container.innerHTML = '<div class="text-center py-10 text-gray-500 text-xs uppercase font-bold">–ü—É—Å—Ç–æ</div>';
            return;
        }

        container.innerHTML = volArray.map(v => {
            const isChecked = selectedVolIds.has(v.id) ? 'checked' : '';
            const inTeams = (v.volunteer_commands || []).map(c => c.title || c.name || 'cmd').join(', ');

            return `
            <label class="flex items-center gap-4 p-3 border-b border-white/5 hover:bg-white/5 transition cursor-pointer select-none">
                <input type="checkbox" class="custom-checkbox flex-shrink-0" onchange="toggleVolSelection(${v.id})" ${isChecked}>
                <div class="flex-1">
                    <div class="text-sm font-bold text-gray-200">${v.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                    <div class="text-[10px] text-gray-500">${v.login}</div>
                    ${inTeams ? `<div class="text-[9px] text-primary/50 mt-1">–£–∂–µ –≤: ${inTeams}</div>` : ''}
                </div>
            </label>
            `;
        }).join('');
    }

    function filterVolunteersList() {
        const query = document.getElementById('volSearchInput').value.toLowerCase();
        const filtered = state.volunteers.filter(v => {
            const name = (v.name || '').toLowerCase();
            const login = (v.login || '').toLowerCase();
            return name.includes(query) || login.includes(query);
        });
        renderVolList(filtered);
    }

    function toggleVolSelection(id) {
        if (selectedVolIds.has(id)) selectedVolIds.delete(id);
        else selectedVolIds.add(id);
        updateBulkBtn();
    }

    function updateBulkBtn() {
        const btn = document.getElementById('bulkAddBtn');
        const countSpan = document.getElementById('selectedCount');
        const count = selectedVolIds.size;
        
        countSpan.innerText = count;
        
        if (count > 0) {
            btn.disabled = false;
            // –î–ï–õ–ê–ï–ú –ö–ù–û–ü–ö–£ –ë–ï–õ–û–ô (–°–í–ï–¢–õ–û–ô)
            btn.classList.remove('bg-white/5', 'text-gray-500', 'cursor-not-allowed');
            btn.classList.add('bg-white', 'text-black', 'hover:bg-gray-200', 'shadow-[0_0_15px_rgba(255,255,255,0.2)]');
            btn.innerText = `–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö (${count})`;
        } else {
            btn.disabled = true;
            btn.classList.add('bg-white/5', 'text-gray-500', 'cursor-not-allowed');
            btn.classList.remove('bg-white', 'text-black', 'hover:bg-gray-200', 'shadow-[0_0_15px_rgba(255,255,255,0.2)]');
            btn.innerText = '–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö';
        }
    }

    async function submitBulkAdd() {
        const select = document.getElementById('targetTeamSelect');
        const cmdId = select.value;
        const cmdTitle = select.options[select.selectedIndex].text;
        
        if (!cmdId) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É!'); return; }
        if (selectedVolIds.size === 0) return;

        const idsArray = Array.from(selectedVolIds);

        const btn = document.getElementById('bulkAddBtn');
        btn.innerText = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        btn.disabled = true;

        try {
            const res = await fetch(`/commands/${cmdId}/add-volunteer/`, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${token}`, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({ volunteer_ids: idsArray })
            });
            const data = await res.json();

            if (res.ok) {
                showToast(`‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${idsArray.length}`);
                closeSearchModal();
                setTimeout(loadAllData, 500);
            } else {
                showToast(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏');
                btn.disabled = false;
                updateBulkBtn();
            }
        } catch (e) {
            console.error(e);
            showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            btn.disabled = false;
            updateBulkBtn();
        }
    }

    // ============================================

    function renderCommandFilter() {
        const container = document.getElementById('selectOptions');
        let html = `<div class="option-item" onclick="applyCommandFilter('', '–í—Å–µ –∫–æ–º–∞–Ω–¥—ã')">
            <span class="text-[10px] font-black uppercase tracking-widest text-white">‚ö° –í—Å–µ –∫–æ–º–∞–Ω–¥—ã</span>
        </div>`;
        state.myLeadingTeams.forEach(cmd => {
            const count = state.apps.filter(a => (a.command_slug === cmd.slug || a.command_title === cmd.title) && a.status === 'pending').length;
            html += `<div class="option-item" onclick="applyCommandFilter('${cmd.slug}', '${cmd.title}')">
                <span class="text-[10px] font-bold text-gray-300">${cmd.title}</span>
                <span class="badge text-gray-400">${count}</span>
            </div>`;
        });
        container.innerHTML = html;
    }

    function applyCommandFilter(slug, title) {
        state.currentCommandSlug = slug;
        document.getElementById('selectedLabel').innerText = title;
        filterAndRenderApps();
    }

    function filterAndRenderApps() {
        const subTab = state.appSubTab;
        const appsGrid = document.getElementById('appsGrid');
        const slug = state.currentCommandSlug;

        state.appsView = state.apps.filter(app => {
            const statusMatch = subTab === 'pending' ? app.status === 'pending' : app.status === 'accepted';
            const hasRights = state.user.role === 'admin' || state.myLeadingTeams.some(t => t.slug === app.command_slug || t.title === app.command_title);
            const commandMatch = slug ? (app.command_slug === slug) : true;
            return statusMatch && hasRights && commandMatch;
        });

        const countPending = state.apps.filter(a => a.status==='pending' && (state.user.role === 'admin' || state.myLeadingTeams.some(t => t.slug === a.command_slug))).length;
        const countAccepted = state.apps.filter(a => a.status==='accepted' && (state.user.role === 'admin' || state.myLeadingTeams.some(t => t.slug === a.command_slug))).length;
        
        document.getElementById('cntPending').innerText = countPending;
        document.getElementById('cntAccepted').innerText = countAccepted;

        if (state.appsView.length === 0) {
            appsGrid.innerHTML = `<div class="col-span-full py-20 text-center text-gray-600 font-black uppercase text-xs italic tracking-widest">–ù–µ—Ç –∑–∞—è–≤–æ–∫</div>`;
            return;
        }

        appsGrid.innerHTML = state.appsView.map((a, index) => {
            const answers = getCleanAnswers(a.answers);
            const values = Object.values(answers);
            let derivedName = "–ë–µ–∑ –∏–º–µ–Ω–∏";
            if (values.length > 0 && values[0]) derivedName = String(values[0]);
            let previewText = "–ê–Ω–∫–µ—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞";
            if (values.length > 1 && values[1]) previewText = String(values[1]);
            const fileCount = (a.files && Array.isArray(a.files)) ? a.files.length : 0;
            return `
            <div class="app-card p-6 flex flex-col group" onclick="openAppModal(${index})">
                <div class="flex justify-between items-start mb-3">
                    <span class="px-2 py-1 bg-white/5 rounded text-[8px] font-black uppercase text-primary border border-white/5">${a.command_title}</span>
                    <span class="text-[9px] font-mono text-gray-600">ID-${a.id}</span>
                </div>
                <h4 class="font-black text-white uppercase italic text-xl group-hover:text-primary transition-colors line-clamp-1">${derivedName}</h4>
                <p class="text-[10px] text-gray-400 mt-2 line-clamp-2 italic">"${previewText}"</p>
                ${fileCount > 0 ? `<div class="mt-3 text-[9px] text-blue-400 font-bold flex items-center gap-1"><i class="fas fa-paperclip"></i> –í–ª–æ–∂–µ–Ω–∏–π: ${fileCount}</div>` : ''}
            </div>`;
        }).join('');
    }

    function openAppModal(index) {
        try {
            state.currentAppIndex = index;
            updateModalContent();
            document.getElementById('modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        } catch (e) { console.error(e); }
    }

    function navigateApp(direction) {
        const newIndex = state.currentAppIndex + direction;
        if (newIndex >= 0 && newIndex < state.appsView.length) {
            state.currentAppIndex = newIndex;
            updateModalContent();
        }
    }

    function updateModalContent() {
        const app = state.appsView[state.currentAppIndex];
        if (!app) return closeModal();

        const prevBtn = document.querySelector('.nav-btn.prev');
        const nextBtn = document.querySelector('.nav-btn.next');
        if(prevBtn) {
            prevBtn.style.opacity = state.currentAppIndex > 0 ? '1' : '0.3';
            prevBtn.style.pointerEvents = state.currentAppIndex > 0 ? 'auto' : 'none';
        }
        if(nextBtn) {
            nextBtn.style.opacity = state.currentAppIndex < state.appsView.length - 1 ? '1' : '0.3';
            nextBtn.style.pointerEvents = state.currentAppIndex < state.appsView.length - 1 ? 'auto' : 'none';
        }

        const answers = getCleanAnswers(app.answers);
        const values = Object.values(answers);
        let derivedName = "–ë–µ–∑ –∏–º–µ–Ω–∏";
        let firstLetter = "?";
        if (values.length > 0 && values[0]) {
            derivedName = String(values[0]);
            firstLetter = derivedName.charAt(0).toUpperCase();
        }

        let answersHtml = '';
        if (Object.keys(answers).length > 0) {
            Object.entries(answers).forEach(([q, ans]) => {
                const label = questionMap[q] || q;
                const displayAns = (ans !== null && ans !== undefined) ? ans : "---";
                answersHtml += `
                <div class="mb-6">
                    <p class="text-[10px] text-primary uppercase font-black mb-2 tracking-widest flex items-center gap-2">
                         <span class="w-2 h-2 rounded-full bg-primary/50"></span> ${label}
                    </p>
                    <div class="bg-white/5 p-4 rounded-xl border border-white/5 text-sm italic text-gray-200 leading-relaxed shadow-inner">
                        ${displayAns}
                    </div>
                </div>`;
            });
        } else {
            answersHtml = '<div class="text-gray-500 italic mb-4">–¢–µ–∫—Å—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–µ—Ç</div>';
        }

        let mediaHtml = '';
        if (app.files && Array.isArray(app.files) && app.files.length > 0) {
             mediaHtml += `<div class="mt-8 pt-8 border-t border-white/10 space-y-8">`;
             mediaHtml += `<h4 class="text-xs font-black uppercase text-gray-500 tracking-widest mb-4">–í–ª–æ–∂–µ–Ω–∏—è (${app.files.length})</h4>`;

             app.files.forEach(f => {
                 const fileUrl = f.file;
                 const isImg = fileUrl.match(/\.(jpg|jpeg|png|webp|gif|svg)$/i);
                 const isVid = fileUrl.match(/\.(mp4|mov|webm|avi)$/i);
                 const label = f.label || "–§–∞–π–ª";
                 
                 mediaHtml += `
                 <div class="bg-black/40 p-4 rounded-2xl border border-white/10">
                     <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded bg-primary/20 flex items-center justify-center text-primary text-xs">
                             <i class="fas fa-paperclip"></i>
                        </div>
                        <p class="text-xs font-bold text-gray-300 uppercase">${label}</p>
                     </div>
                     ${isImg 
                         ? `<div class="rounded-xl overflow-hidden border border-white/10 bg-black/50"><img src="${fileUrl}" class="w-full h-auto object-contain max-h-[600px]"></div>`
                         : isVid
                            ? `<div class="rounded-xl overflow-hidden border border-white/10 bg-black/50"><video controls class="w-full max-h-[500px]"><source src="${fileUrl}"></video></div>`
                            : `<div class="p-8 text-center bg-white/5 rounded-xl border border-white/5 flex flex-col items-center gap-3">
                                  <i class="fas fa-file-alt text-4xl text-gray-500"></i>
                                  <span class="text-xs text-gray-400">${fileUrl.split('/').pop()}</span>
                               </div>`
                     }
                     <div class="flex gap-2 mt-4">
                         <a href="${fileUrl}" target="_blank" class="flex-1 py-3 bg-white/10 hover:bg-white/20 text-center text-[10px] font-bold uppercase rounded-xl text-white transition"><i class="fas fa-external-link-alt mr-2"></i> –û—Ç–∫—Ä—ã—Ç—å</a>
                         <a href="${fileUrl}" download class="flex-1 py-3 bg-primary/10 hover:bg-primary/20 text-center text-[10px] font-bold uppercase rounded-xl text-primary transition"><i class="fas fa-download mr-2"></i> –°–∫–∞—á–∞—Ç—å</a>
                     </div>
                 </div>`;
             });
             mediaHtml += `</div>`;
        }

        document.getElementById('modalContent').innerHTML = `
            <div class="flex items-center gap-5 mb-8 pb-8 border-b border-white/10">
                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center text-black font-black text-3xl italic shadow-[0_0_20px_rgba(0,198,255,0.3)]">
                    ${firstLetter}
                </div>
                <div>
                    <h3 class="text-2xl md:text-3xl font-black text-white uppercase italic leading-none mb-1">${derivedName}</h3>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">–ö–æ–º–∞–Ω–¥–∞: <span class="text-white">${app.command_title}</span></p>
                </div>
            </div>
            <div class="custom-scrollbar pr-2 max-h-[60vh] overflow-y-auto">
                ${answersHtml}
                ${mediaHtml}
            </div>
        `;
        
        const btn = document.getElementById('approveAppBtn');
        if (app.status === 'accepted') {
            btn.innerHTML = '<i class="fas fa-check"></i> –£–∂–µ –ø—Ä–∏–Ω—è—Ç';
            btn.disabled = true;
            btn.className = "flex-1 py-4 bg-green-500/10 text-green-500 border border-green-500/20 font-black uppercase rounded-2xl cursor-not-allowed flex items-center justify-center gap-2";
        } else {
            btn.innerHTML = '<i class="fas fa-check-double"></i> –ü—Ä–∏–Ω—è—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É';
            btn.disabled = false;
            btn.className = "flex-1 py-4 bg-[#80e5ff] text-black font-black uppercase rounded-2xl hover:bg-white transition flex items-center justify-center gap-2 shadow-lg shadow-primary/20";
            btn.onclick = () => acceptApp(app.id);
        }
    }

    async function acceptApp(id) {
        try {
            const btn = document.getElementById('approveAppBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            const res = await fetch(`${API.apps}${id}/accept/`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'accepted' })
            });
            if (res.ok) {
                showToast('–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ –≤ –∫–æ–º–∞–Ω–¥—É');
                const app = state.apps.find(a => a.id === id);
                if (app) app.status = 'accepted';
                state.appsView.splice(state.currentAppIndex, 1);
                document.getElementById('cntPending').innerText = parseInt(document.getElementById('cntPending').innerText) - 1;
                document.getElementById('cntAccepted').innerText = parseInt(document.getElementById('cntAccepted').innerText) + 1;
                if (state.appsView.length === 0) { closeModal(); filterAndRenderApps(); }
                else {
                    if (state.currentAppIndex >= state.appsView.length) state.currentAppIndex = state.appsView.length - 1;
                    updateModalContent();
                    filterAndRenderApps();
                }
            }
        } catch(e){ console.error(e); }
    }

    function decideSub(id, status) {
        try {
            const body = { status };
            if (status === 'approved') {
                const pointsInput = document.getElementById(`pts-${id}`);
                if (pointsInput) { body.points_awarded = parseFloat(pointsInput.value); }
            }
            fetch(`${API.submissions}${id}/`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            }).then(res => {
                if (res.ok) {
                    const el = document.getElementById(`sub-${id}`);
                    el.style.opacity = '0';
                    el.style.transform = 'scale(0.9)';
                    setTimeout(() => el.remove(), 300);
                    const msg = status === 'approved' ? '–ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã' : '–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞';
                    showToast(msg);
                    setTimeout(loadAllData, 500);
                } else {
                    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
                }
            });
        } catch(e) { console.error(e); showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    }

    function renderSubmissions() {
        const container = document.getElementById('secReq');
        const myDirIds = getIds(state.user.direction);
        const myTeamIds = state.myManagedTeams.map(t => String(t.id));
        const pending = state.submissions.filter(s => {
            if (s.status !== 'pending') return false;
            if (state.user.role === 'admin') return true;
            const taskDirId = extractId(s.task_details, 'direction');
            const taskCmdId = extractId(s.task_details, 'command');
            if (!taskDirId && !taskCmdId) return true; 
            if (state.user.role === 'curator') return myDirIds.includes(taskDirId) || (taskCmdId && myTeamIds.includes(taskCmdId));
            return myTeamIds.includes(taskCmdId);
        });
        if (pending.length === 0) {
            container.innerHTML = `<div class="col-span-full py-20 text-center text-gray-600 font-black uppercase text-xs italic tracking-widest">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</div>`;
            return;
        }
        container.innerHTML = pending.map(s => {
            const isFlex = s.task_details?.is_flexible;
            return `
            <div class="glass-card flex flex-col h-full border-white/5 hover:border-primary/20 transition group" id="sub-${s.id}">
                <div class="flex justify-between items-start mb-4">
                    <span class="px-2 py-1 bg-primary/10 text-primary text-[8px] font-black uppercase rounded">${s.task_details?.command_name || '–û–±—â–∞—è –∑–∞–¥–∞—á–∞'}</span>
                    <span class="text-[10px] text-gray-600 font-mono tracking-tighter">${new Date(s.created_at).toLocaleDateString()}</span>
                </div>
                <div class="mb-6 flex-grow">
                    <h4 class="font-black text-lg italic uppercase leading-tight text-white group-hover:text-primary transition">${s.volunteer_name}</h4>
                    <p class="text-[10px] text-gray-400 font-bold uppercase mt-1 mb-3">${s.task_details?.title}</p>
                    <div class="bg-black/40 p-3 rounded-xl text-sm italic text-gray-500 border border-white/5">"${s.description || '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}"</div>
                </div>
                <div class="flex flex-col gap-3 mt-auto">
                <div class="flex items-center justify-between bg-white/5 p-3 rounded-2xl border border-white/10 transition-all hover:border-primary/30 group/input">
                    <div class="flex flex-col">
                        <span class="text-[9px] font-black text-gray-500 uppercase ml-1 tracking-tighter">${isFlex ? '–û—Ü–µ–Ω–∫–∞ —Ä–∞–±–æ—Ç—ã' : '–§–∏–∫—Å. –±–∞–ª–ª—ã'}</span>
                        <span class="text-[8px] text-primary/40 font-bold uppercase ml-1">${isFlex ? '–∏–∑–º–µ–Ω—è–µ–º–æ–µ' : '—Å—Ç–∞–Ω–¥–∞—Ä—Ç'}</span>
                    </div>
                    ${isFlex 
                        ? `<div class="relative flex items-center"><i class="fas fa-pen text-[10px] text-primary/30 absolute left-3 group-focus-within/input:text-primary transition-colors"></i><input type="number" id="pts-${s.id}" class="w-24 bg-[#0f172a] border-2 border-primary/20 rounded-xl pl-8 pr-3 py-2 text-primary font-black text-lg outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all hover:bg-[#1e293b] appearance-none" value="${s.task_details.points}" step="0.5"></div>`
                        : `<div class="score-badge text-xl px-4 py-2 bg-primary/10 border border-primary/20 rounded-xl">+${parseFloat(s.task_details?.points || 0)}</div>`
                    }
                </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="decideSub(${s.id}, 'approved')" class="py-3 bg-[#80e5ff] text-black rounded-xl font-black uppercase text-[10px] hover:bg-white transition shadow-lg shadow-sky-500/10">–ü—Ä–∏–Ω—è—Ç—å</button>
                        <button onclick="decideSub(${s.id}, 'rejected')" class="py-3 bg-white/5 text-gray-500 rounded-xl font-black uppercase text-[10px] hover:text-red-500 transition">–û—Ç–∫–∞–∑</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function switchTab(tab) {
        document.querySelectorAll('.section-view').forEach(s => s.classList.add('hidden'));
        document.getElementById(`sec${tab.charAt(0).toUpperCase()+tab.slice(1)}`).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab_${tab}`).classList.add('active');
    }

    function closeModal() { document.getElementById('modal').classList.add('hidden'); document.body.style.overflow = 'auto'; }
    function logout() { localStorage.removeItem('access'); location.href='/login/'; }
    function showToast(msg) {
        const toast = document.createElement('div');
        toast.className = 'toast show';
        toast.innerHTML = `<i class="fas fa-check-circle text-primary text-xl"></i> <span class="font-bold text-sm">${msg}</span>`;
        document.getElementById('toast-container').appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    init();
    </script>
</body>
</html>