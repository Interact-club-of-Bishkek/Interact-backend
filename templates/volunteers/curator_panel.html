<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Борд кабинет</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/qFYrFSnD/2105176-1-removebg-preview.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800;900&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00c6ff; --bg: #020408; --glass: rgba(15, 23, 42, 0.95); }
        body { 
            background: var(--bg); color: white; font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(circle at 50% 120%, #10192e 0%, #020408 100%); 
            min-height: 100vh; padding: 20px; padding-bottom: 80px; 
        }
        .glass-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 24px; }
        .btn-glass { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #94a3b8; transition: all 0.3s ease; border-radius: 14px; }
        .btn-glass:hover { background: rgba(255, 255, 255, 0.1); color: white; border-color: rgba(255, 255, 255, 0.3); }
        
        .tab-btn { padding: 12px 24px; font-weight: 800; text-transform: uppercase; font-size: 11px; letter-spacing: 0.1em; border-radius: 12px; transition: all 0.3s; color: #64748b; border: 1px solid transparent; white-space: nowrap; }
        .tab-btn:hover:not(.active) { color: white; background: rgba(255,255,255,0.05); }
        .tab-btn.active { background: rgba(0, 198, 255, 0.1); color: var(--primary); border-color: rgba(0, 198, 255, 0.3); box-shadow: 0 0 20px rgba(0, 198, 255, 0.15); }
        
        .app-card { 
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.08); border-radius: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer; position: relative; overflow: hidden;
        }
        .app-card:hover { 
            border-color: var(--primary); transform: translateY(-4px); 
            box-shadow: 0 10px 40px -10px rgba(0, 198, 255, 0.15); 
        }
        .app-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 100%;
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, transparent 100%);
            pointer-events: none;
        }

        .custom-select-wrapper { position: relative; user-select: none; z-index: 50; }
        .select-trigger {
            background: rgba(0, 198, 255, 0.05); border: 1px solid rgba(0, 198, 255, 0.2);
            border-radius: 16px; padding: 12px 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: space-between;
            transition: all 0.3s ease;
        }
        .select-trigger:hover { border-color: var(--primary); background: rgba(0, 198, 255, 0.1); }
        .select-options {
            position: absolute; top: calc(100% + 8px); left: 0; right: 0;
            background: #0f172a; border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px; overflow: hidden; display: none;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5); z-index: 100;
        }
        .select-options.active { display: block; animation: slideDown 0.2s ease-out; }
        .option-item { padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .option-item:hover { background: var(--primary); color: black; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .custom-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .custom-table th { padding: 0 16px; text-align: left; font-size: 10px; text-transform: uppercase; color: #4b5563; font-weight: 900; }
        .custom-table td { padding: 16px; background: rgba(255,255,255,0.03); font-size: 13px; vertical-align: middle; }
        .custom-table td:first-child { border-radius: 16px 0 0 16px; }
        .custom-table td:last-child { border-radius: 0 16px 16px 0; }
        .score-badge { background: rgba(0, 198, 255, 0.15); color: var(--primary); padding: 4px 10px; border-radius: 8px; font-weight: 900; font-family: 'Montserrat'; }
        .score-total { color: #4b5563; font-weight: 700; font-size: 11px; margin-left: 8px; }
        
        .loader-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 16px 24px; border-radius: 16px; background: rgba(15, 23, 42, 0.95); border-left: 4px solid var(--primary); color: white; transform: translateX(110%); transition: 0.3s; display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .toast.show { transform: translateX(0); }

        .nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 3.5rem; height: 3.5rem; background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; z-index: 60; color: white;
        }
        .nav-btn:hover { background: var(--primary); color: black; }
        .nav-btn.prev { left: -5rem; }
        .nav-btn.next { right: -5rem; }
        @media (max-width: 1024px) {
            .nav-btn { position: fixed; bottom: 20px; top: auto; transform: none; background: #000; border-color: var(--primary); }
            .nav-btn.prev { left: 20px; }
            .nav-btn.next { right: 20px; }
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div id="app" class="max-w-7xl mx-auto hidden animate-fade-in">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-6">
            <div>
                <p id="cName" class="text-gray-400 text-sm font-bold uppercase tracking-widest mb-1 pl-1">...</p>
                <h1 class="text-4xl md:text-5xl font-black italic uppercase text-white leading-none">
                    Curator <span class="text-primary">Panel</span>
                </h1>
                <div class="flex items-center gap-3 mt-3">
                    <span class="w-8 h-[2px] bg-primary"></span>
                    <p id="cRole" class="text-primary font-bold text-[10px] tracking-[0.3em] uppercase">...</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <p class="text-[9px] text-gray-500 uppercase font-black">Управление</p>
                    <p id="managedTeamsLabel" class="text-white font-bold text-sm italic uppercase">Загрузка...</p>
                </div>
                <button onclick="logout()" class="btn-glass py-3 px-6 text-xs font-bold uppercase"><i class="fas fa-power-off mr-2"></i>Выход</button>
            </div>
        </header>
        
        <div class="flex gap-3 mb-8 overflow-x-auto pb-2 scrollbar-hide">
            <button onclick="switchTab('req')" id="tab_req" class="tab-btn active"><i class="fas fa-inbox mr-2"></i>Заявки на баллы</button>
            <button onclick="switchTab('apps')" id="tab_apps" class="tab-btn"><i class="fas fa-rocket mr-2"></i>Набор в команды</button>
            <button onclick="switchTab('vols')" id="tab_vols" class="tab-btn"><i class="fas fa-users mr-2"></i>База Волонтеров</button>
        </div>

        <div id="secReq" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 section-view">
            <div class="col-span-full flex justify-center py-20"><i class="fas fa-circle-notch loader-spin text-4xl text-primary/50"></i></div>
        </div>
        
        <div id="secApps" class="hidden section-view">
            <div class="flex flex-col md:flex-row gap-4 mb-6 justify-between items-end">
                <div class="flex bg-white/5 p-1 rounded-xl border border-white/5 w-full md:w-auto">
                    <button id="subTabPending" onclick="switchAppSubTab('pending')" class="flex-1 md:flex-none px-6 py-2.5 rounded-lg text-[10px] font-black uppercase transition-all bg-sky-400/10 text-sky-400">Ожидают (<span id="cntPending">0</span>)</button>
                    <button id="subTabAccepted" onclick="switchAppSubTab('accepted')" class="flex-1 md:flex-none px-6 py-2.5 rounded-lg text-[10px] font-black uppercase transition-all text-gray-500">Приняты (<span id="cntAccepted">0</span>)</button>
                </div>
                <div class="custom-select-wrapper w-full md:w-64">
                    <div class="select-trigger" id="selectTrigger">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-filter text-primary text-xs"></i>
                            <span id="selectedLabel" class="text-[10px] font-black uppercase tracking-widest text-white">Все команды</span>
                        </div>
                        <i class="fas fa-chevron-down text-[10px] text-primary"></i>
                    </div>
                    <div class="select-options" id="selectOptions"></div>
                </div>
            </div>

            <div id="appsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="secVols" class="hidden section-view">
            <div class="glass-card overflow-hidden p-0 border-white/5">
                <div class="overflow-x-auto p-4">
                    <table class="custom-table w-full">
                        <thead>
                            <tr>
                                <th>Волонтер</th>
                                <th>Направления</th>
                                <th>Баллы (Всего / в команде)</th>
                                <th class="text-right">Нарушения</th>
                            </tr>
                        </thead>
                        <tbody id="vTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black/95 backdrop-blur-xl flex items-center justify-center p-2 md:p-6 z-[200]">
        <div class="relative w-full max-w-4xl">
            <button class="nav-btn prev" onclick="navigateApp(-1)"><i class="fas fa-chevron-left text-xl"></i></button>
            <button class="nav-btn next" onclick="navigateApp(1)"><i class="fas fa-chevron-right text-xl"></i></button>

            <div class="glass-card w-full rounded-[30px] p-6 md:p-10 max-h-[90vh] overflow-y-auto relative border-white/10 shadow-2xl bg-[#0b1121]">
                <button onclick="closeModal()" class="absolute top-6 right-6 text-gray-500 hover:text-white transition z-50">
                    <i class="fas fa-times text-2xl"></i>
                </button>
                
                <div id="modalContent"></div>

                <div class="mt-8 pt-8 border-t border-white/10 flex gap-4">
                    <button id="approveAppBtn" class="flex-1 py-4 bg-primary text-black font-black uppercase rounded-2xl hover:bg-white transition flex items-center justify-center gap-2 shadow-lg shadow-primary/20">
                        <i class="fas fa-check-double"></i> Принять в команду
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('access');

        const API = {
            profile: '/api/profile/',
            submissions: '/api/curator/submissions/',
            volunteers: '/api/list/',
            commands: '/commands/',
            apps: '/commands-applications/'
        };

        let state = {
            user: null,
            submissions: [],
            volunteers: [],
            apps: [],
            commands: [],
            myManagedTeams: [],
            myLeadingTeams: [],
            appsView: [],
            appSubTab: 'pending',
            currentAppIndex: 0,
            currentCommandSlug: ''
        };

        let questionMap = {};

        /* ---------------- HELPERS ---------------- */

        const extractId = (obj, field) => {
            if (!obj) return null;
            if (obj[`${field}_id`]) return String(obj[`${field}_id`]);
            if (obj[field]?.id) return String(obj[field].id);
            if (obj[field]) return String(obj[field]);
            return null;
        };

        const getIds = (data) => {
            if (!data) return [];
            return (Array.isArray(data) ? data : [data]).map(d => String(d.id || d));
        };

        const getCleanAnswers = (raw) => {
            if (!raw) return {};
            if (typeof raw === 'string') {
                try { return JSON.parse(raw); } catch { return {}; }
            }
            return typeof raw === 'object' ? raw : {};
        };

        /* --------- ACCESS CONTROL (KEY FIX) --------- */

        function curatorHasAccessToApp(app) {
            if (state.user.role === 'admin') return true;

            // Leader
            if (
                state.myLeadingTeams.some(t =>
                    t.slug === app.command_slug || t.title === app.command_title
                )
            ) return true;

            // Curator by direction
            if (state.user.role === 'curator') {
                const myDirIds = getIds(state.user.direction);
                const cmd = state.commands.find(
                    c => c.slug === app.command_slug || c.title === app.command_title
                );
                const cmdDirId = extractId(cmd, 'direction');
                return myDirIds.includes(cmdDirId);
            }

            return false;
        }

        /* ---------------- INIT ---------------- */

        async function init() {
            if (!token) return location.href = '/login/';
            try {
                const res = await fetch(API.profile, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (res.status === 401) return logout();

                state.user = await res.json();

                document.getElementById('cName').innerText = state.user.name || state.user.login;
                document.getElementById('cRole').innerText = state.user.role_display;
                document.getElementById('app').classList.remove('hidden');

                setupDropdown();
                await loadAllData();
            } catch (e) {
                console.error('Init error:', e);
            }
        }

        /* ---------------- DATA LOAD ---------------- */

        async function loadAllData() {
            try {
                const h = { Authorization: `Bearer ${token}` };
                const [sub, vol, cmd, app] = await Promise.all([
                    fetch(API.submissions, { headers: h }).then(r => r.json()),
                    fetch(API.volunteers, { headers: h }).then(r => r.json()),
                    fetch(API.commands, { headers: h }).then(r => r.json()),
                    fetch(API.apps, { headers: h }).then(r => r.json())
                ]);

                state.submissions = sub;
                state.volunteers = vol;
                state.commands = cmd;
                state.apps = app;

                // Questions map
                questionMap = {};
                cmd.forEach(c =>
                    c.questions?.forEach(q => {
                        questionMap[q.id] = q.label;
                        questionMap[`q_${q.id}`] = q.label;
                    })
                );

                // Teams
                const myDirIds = getIds(state.user.direction);
                const label = document.getElementById('managedTeamsLabel');

                if (state.user.role === 'admin') {
                    state.myManagedTeams = cmd;
                    state.myLeadingTeams = cmd;
                    label.innerText = 'Все направления (Admin)';
                } else if (state.user.role === 'curator') {
                    state.myManagedTeams = cmd.filter(c =>
                        myDirIds.includes(extractId(c, 'direction'))
                    );
                    state.myLeadingTeams = cmd.filter(c =>
                        String(c.leader?.id || c.leader) === String(state.user.id)
                    );
                    label.innerText = state.user.direction?.map(d => d.name).join(' / ') || 'Направление';
                } else {
                    state.myManagedTeams = cmd.filter(c =>
                        String(c.leader?.id || c.leader) === String(state.user.id)
                    );
                    state.myLeadingTeams = state.myManagedTeams;
                    label.innerText = state.myManagedTeams.map(t => t.title).join(' / ');
                }

                renderCommandFilter();
                renderSubmissions();
                renderVolunteers();
                filterAndRenderApps();

            } catch (e) {
                console.error('Load error:', e);
            }
        }

        /* ---------------- FILTER ---------------- */

        function filterAndRenderApps() {
            const appsGrid = document.getElementById('appsGrid');
            const slug = state.currentCommandSlug;

            state.appsView = state.apps.filter(app => {
                const statusOk = state.appSubTab === 'pending'
                    ? app.status === 'pending'
                    : app.status === 'accepted';
                const access = curatorHasAccessToApp(app);
                const cmdOk = slug ? app.command_slug === slug : true;
                return statusOk && access && cmdOk;
            });

            const countPending = state.apps.filter(
                a => a.status === 'pending' && curatorHasAccessToApp(a)
            ).length;

            const countAccepted = state.apps.filter(
                a => a.status === 'accepted' && curatorHasAccessToApp(a)
            ).length;

            document.getElementById('cntPending').innerText = countPending;
            document.getElementById('cntAccepted').innerText = countAccepted;

            if (!state.appsView.length) {
                appsGrid.innerHTML = `
                    <div class="col-span-full py-20 text-center text-gray-600 font-black uppercase text-xs">
                        Нет заявок
                    </div>`;
                return;
            }

            appsGrid.innerHTML = state.appsView.map((a, i) => {
                const answers = getCleanAnswers(a.answers);
                const values = Object.values(answers);
                const name = values[0] || 'Без имени';
                const text = values[1] || 'Анкета заполнена';

                return `
                <div class="app-card p-6" onclick="openAppModal(${i})">
                    <div class="flex justify-between mb-2">
                        <span class="text-[8px] uppercase text-primary font-black">
                            ${a.command_title}
                        </span>
                        <span class="text-[9px] text-gray-600">ID-${a.id}</span>
                    </div>
                    <h4 class="font-black italic text-xl">${name}</h4>
                    <p class="text-[10px] text-gray-400 italic mt-2">"${text}"</p>
                </div>`;
            }).join('');
        }

        /* ---------------- UI ---------------- */

        function setupDropdown() {
            const trigger = document.getElementById('selectTrigger');
            const options = document.getElementById('selectOptions');
            trigger.onclick = e => {
                e.stopPropagation();
                options.classList.toggle('active');
            };
            window.onclick = () => options.classList.remove('active');
        }

        function applyCommandFilter(slug, title) {
            state.currentCommandSlug = slug;
            document.getElementById('selectedLabel').innerText = title;
            filterAndRenderApps();
        }

        /* ---------------- OTHER (без изменений) ---------------- */

        function switchAppSubTab(tab) {
            state.appSubTab = tab;
            filterAndRenderApps();
        }

        function switchTab(tab) {
            document.querySelectorAll('.section-view').forEach(s => s.classList.add('hidden'));
            document.getElementById(`sec${tab.charAt(0).toUpperCase()+tab.slice(1)}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab_${tab}`).classList.add('active');
        }

        function logout() {
            localStorage.removeItem('access');
            location.href = '/login/';
        }

        init();
        </script>

</body>
</html>