<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equity Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #fbbf24; /* Желтый для карточек */ --bg: #020408; --border: rgba(255,255,255,0.1); }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0b1120; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }

        .table-container { flex: 1; overflow: auto; background: #0f172a; }
        
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        
        th, td {
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            text-align: left;
        }
        
        thead th {
            position: sticky; top: 0; z-index: 10;
            background: #1e293b; color: #94a3b8; font-size: 11px; font-weight: 700; uppercase;
        }

        .card-slot {
            width: 40px; height: 56px; 
            border-radius: 6px; 
            border: 2px dashed rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.02);
            cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        
        .card-slot:hover { border-color: rgba(255,255,255,0.3); }

        /* Активная желтая карточка */
        .card-slot.active {
            background: #fbbf24;
            border: 2px solid #f59e0b;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
            transform: rotate(-2deg);
        }
        .card-slot.active:hover { transform: scale(1.05) rotate(0deg); }

        .btn-logout { width: 40px; height: 40px; border-radius: 12px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; color: #9ca3af; transition: 0.3s; }
        .btn-logout:hover { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast { padding: 12px 20px; border-radius: 12px; background: #1e293b; border-left: 4px solid var(--primary); color: white; margin-bottom: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div class="bg-[#0b1120] border-b border-white/10 p-4 flex justify-between items-center">
        <div class="flex items-center gap-6">
            <h1 class="text-xl font-black italic uppercase text-white tracking-widest">
                <span class="text-yellow-400">EQUITY</span> OFFICER
            </h1>
            
            <select id="directionSelect" class="bg-[#1e293b] text-white text-xs font-bold px-4 py-2.5 rounded-xl border border-white/10 outline-none focus:border-yellow-500 w-64" onchange="fetchData()">
                <option value="">Выберите направление...</option>
            </select>
        </div>

        <button onclick="logout()" class="btn-logout"><i class="fas fa-power-off"></i></button>
    </div>

    <div class="table-container relative">
        <div id="loader" class="absolute inset-0 bg-[#0f172a] z-50 flex items-center justify-center hidden">
            <i class="fas fa-circle-notch fa-spin text-4xl text-yellow-500"></i>
        </div>

        <table id="equityTable" class="hidden w-full">
            <thead>
                <tr>
                    <th class="pl-8">Волонтер</th>
                    <th class="text-center w-64">Желтые карточки (Макс 4)</th>
                    <th class="text-right pr-8">Статус</th>
                </tr>
            </thead>
            <tbody id="equityBody">
                </tbody>
        </table>

        <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center opacity-50">
            <i class="fas fa-exclamation-triangle text-5xl mb-4 text-gray-600"></i>
            <p class="text-sm font-bold text-gray-400">Выберите направление</p>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('access');
        const API = {
            profile: '/api/profile/',
            discovery: '/api/discovery/',
            equity: '/api/equity/'
        };

        async function init() {
            if(!token) return location.href = '/login/';
            
            try {
                // 1. Проверяем юзера
                const uRes = await fetch(API.profile, { headers: { 'Authorization': `Bearer ${token}` } });
                if(uRes.status === 401) { logout(); return; }
                const user = await uRes.json();

                // Проверка прав: equity_officer, admin, curator
                if(!['equity_officer', 'admin', 'curator', 'president'].includes(user.role)) {
                    alert('Нет доступа'); location.href='/'; return;
                }

                // 2. Грузим направления
                const dRes = await fetch(API.discovery, { headers: { 'Authorization': `Bearer ${token}` } });
                const disc = await dRes.json();
                renderDirections(disc.all_directions);

            } catch(e) { console.error(e); }
        }

        function renderDirections(dirs) {
            const sel = document.getElementById('directionSelect');
            sel.innerHTML = '<option value="">Выберите направление...</option>';
            dirs.forEach(d => sel.innerHTML += `<option value="${d.id}">${d.name}</option>`);
        }

        async function fetchData() {
            const dirId = document.getElementById('directionSelect').value;
            if(!dirId) return;

            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('equityTable').classList.add('hidden');

            try {
                const res = await fetch(`${API.equity}board/?direction_id=${dirId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const volunteers = await res.json();
                renderTable(volunteers);
            } catch(e) {
                showToast("Ошибка загрузки", "error");
            } finally {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('equityTable').classList.remove('hidden');
            }
        }

        function renderTable(volunteers) {
            const tbody = document.getElementById('equityBody');
            tbody.innerHTML = '';

            if(volunteers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center p-8 text-gray-500">В этом направлении нет волонтеров</td></tr>';
                return;
            }

            volunteers.forEach(vol => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition border-b border-white/5";

                // Аватар и Имя
                const hue = (vol.id * 137) % 360;
                const initials = vol.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
                
                tr.innerHTML = `
                    <td class="pl-8">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center font-bold text-sm bg-[#1e293b]" style="color: hsl(${hue}, 70%, 60%)">
                                ${initials}
                            </div>
                            <div class="font-bold text-sm text-gray-200">${vol.name}</div>
                        </div>
                    </td>
                    <td>
                        <div class="flex items-center justify-center gap-3">
                            ${renderSlots(vol)}
                        </div>
                    </td>
                    <td class="text-right pr-8">
                        ${renderStatus(vol.count)}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderSlots(vol) {
            let html = '';
            // Генерируем 4 слота
            for(let i = 1; i <= 4; i++) {
                const isActive = i <= vol.count;
                // Если слот активен - он кликабелен для удаления (но удалять можно только последний)
                // Если слот пустой - кликабелен для добавления (но только следующий по очереди)
                
                let action = '';
                let opacity = 'opacity-100';

                if (isActive) {
                    // Это активная карточка
                    if (i === vol.count) action = `onclick="toggleCard(${vol.id}, 'remove')"`; // Можно удалить только последнюю
                    else opacity = 'opacity-50 cursor-not-allowed'; // Предыдущие заблокированы
                } else {
                    // Это пустая карточка
                    if (i === vol.count + 1) action = `onclick="toggleCard(${vol.id}, 'add')"`; // Можно добавить только следующую
                    else opacity = 'opacity-30 cursor-not-allowed'; // Дальнейшие заблокированы
                }

                html += `
                    <div class="card-slot ${isActive ? 'active' : ''} ${opacity}" ${action} title="${isActive ? 'Снять карточку' : 'Выдать карточку'}">
                        ${isActive ? '<i class="fas fa-file text-black text-lg"></i>' : ''}
                    </div>
                `;
            }
            return html;
        }

        function renderStatus(count) {
            if(count === 0) return '<span class="text-xs font-bold text-green-500 bg-green-500/10 px-3 py-1 rounded-full">Чисто</span>';
            if(count < 4) return `<span class="text-xs font-bold text-yellow-500 bg-yellow-500/10 px-3 py-1 rounded-full">Предупреждение (${count})</span>`;
            return '<span class="text-xs font-bold text-red-500 bg-red-500/10 px-3 py-1 rounded-full">БАН / Исключение</span>';
        }

        async function toggleCard(volId, action) {
            // Оптимистичное обновление UI можно сделать, но проще перезагрузить данные
            try {
                const res = await fetch(`${API.equity}toggle_card/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ volunteer_id: volId, action: action })
                });
                
                const data = await res.json();
                
                if(res.ok) {
                    showToast(action === 'add' ? 'Карточка выдана' : 'Карточка снята', 'success');
                    fetchData(); // Обновляем таблицу
                } else {
                    showToast(data.error, 'error');
                }
            } catch(e) {
                showToast("Ошибка сети", 'error');
            }
        }

        function logout() { localStorage.removeItem('access'); location.href='/login/'; }
        function showToast(msg, type='info') {
            const t = document.createElement('div');
            t.className = `toast border-${type==='error'?'red':'green'}-500`;
            t.innerHTML = `<span>${msg}</span>`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        init();
    </script>
</body>
</html>