<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üíñ Magical Volunteer Dashboard ü¶Ñ</title>
<style>
/* –ö–û–ù–¢–†–ê–°–¢–ù–´–ï –¶–í–ï–¢–ê –ò –ú–ê–ì–ò–Ø */
:root {
    --text-dark: #2d001a; 
    --pink-bright: #ff4d6d;
    --pink-soft: #ffccd5;
    --magic-purple: #7209b7;
    --glass: rgba(255, 255, 255, 0.95);
}

body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    background-attachment: fixed;
    margin: 0;
    padding: 15px;
    color: var(--text-dark);
}

/* –§–ï–ï–ß–ö–ò –ù–ê –§–û–ù–ï */
.fairy-dust {
    position: fixed; top: -10%; font-size: 1.5rem; pointer-events: none; z-index: -1;
    animation: fall linear infinite;
}
@keyframes fall {
    0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
}

h1 {
    text-align: center; font-size: calc(1.8rem + 1.5vw); color: white;
    text-shadow: 3px 3px 0px var(--pink-bright);
    margin-bottom: 20px; animation: float 3s ease-in-out infinite;
}
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

/* –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –§–ò–õ–¨–¢–†–´ */
.filter-panel {
    background: var(--glass); 
    padding: 20px; 
    border-radius: 30px;
    box-shadow: 0 10px 30px rgba(255, 77, 109, 0.2);
    margin-bottom: 30px; 
    border: 4px solid white;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* –ê–≤—Ç–æ-–∫–æ–ª–æ–Ω–∫–∏ */
    gap: 15px;
}

.filter-panel input, .filter-panel select {
    width: 100%;
    box-sizing: border-box;
    padding: 12px 20px; 
    border: 3px solid var(--pink-soft);
    border-radius: 25px; 
    font-size: 1rem; 
    font-weight: 600; 
    outline: none;
    background: white;
}

/* –ö–ê–ù–ë–ê–ù */
.columns { display: flex; gap: 20px; justify-content: center; }
.column {
    flex: 1; background: rgba(255, 255, 255, 0.7);
    border-radius: 30px; padding: 20px; min-width: 290px;
    border: 2px solid white; transition: 0.3s;
}
.column h2 {
    text-align: center; color: white; background: var(--pink-bright);
    padding: 10px; border-radius: 20px; font-size: 1.4rem; margin-top: 0;
}

/* –ö–ê–†–¢–û–ß–ö–ò */
.card {
    background: white; border-radius: 20px; padding: 15px; margin-top: 15px;
    cursor: pointer; transition: 0.3s;
    display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
.card:hover { transform: scale(1.03); box-shadow: 0 10px 20px rgba(255, 77, 109, 0.2); }
.card img { width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--pink-soft); object-fit: cover; flex-shrink: 0; }
.card-info { min-width: 0; } /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ä–∞–∑–¥—É–≤–∞–Ω–∏–µ –æ—Ç –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
.card-info strong { color: #800020; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.directions-brief { color: var(--magic-purple); font-weight: 700; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* –ú–û–î–ê–õ–ö–ê */
.modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(45, 0, 26, 0.7); backdrop-filter: blur(5px);
    z-index: 9999; justify-content: center; align-items: center;
    padding: 10px;
}
.modal-content {
    background: white; border-radius: 35px; padding: 25px;
    width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;
    position: relative; border: 6px solid var(--pink-soft);
}
.close-btn { position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer; color: var(--pink-bright); z-index: 10; }

/* –£–í–ï–õ–ò–ß–ï–ù–ù–û–ï –§–û–¢–û –í –ú–û–î–ê–õ–ö–ï */
.modal-content img { 
    display: block; 
    width: 100%; 
    max-width: 320px; /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä */
    height: auto; 
    aspect-ratio: 1 / 1;
    border-radius: 25px; 
    margin: 0 auto 20px; 
    border: 6px solid var(--pink-soft); 
    object-fit: cover; 
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

/* –¢–ê–ë–´ (–ú–û–ë–ò–õ–ö–ò) */
.tabs { display: none; background: white; border-radius: 30px; margin-bottom: 20px; padding: 5px; gap: 5px; }
.tab-button { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; border-radius: 25px; transition: 0.2s; }
.tab-button.active { background: var(--pink-bright); color: white; }

@media (max-width: 768px) {
    .columns { flex-direction: column; align-items: center; } 
    .column { display: none; width: 100%; max-width: 400px; }
    .column.active { display: block; } .tabs { display: flex; }
    .filter-panel { grid-template-columns: 1fr; } /* –û–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
}

/* –ö–ù–û–ü–ö–ò */
.buttons { display: flex; gap: 10px; margin-top: 25px; }
.buttons button { flex: 1; padding: 14px; border: none; border-radius: 18px; font-weight: 800; cursor: pointer; color: white; font-size: 1rem; }
.btn-stage { background: var(--pink-bright); }
.btn-reject { background: #cbd5e1; color: #475569; }
</style>
</head>
<body>

<h1>‚ú® Fairy Volunteer Board ü¶Ñ</h1>

<div class="filter-panel">
    <input type="text" id="searchName" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –§–ò–û...">
    <select id="filterStudy"><option value="">üè´ –í—Å–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è</option></select>
    <select id="filterYear"><option value="">üìÖ –í—Å–µ –≥–æ–¥—ã —Ä–æ–∂–¥–µ–Ω–∏—è</option></select>
</div>

<div class="tabs" id="tabs">
    <div class="tab-button active" data-target="submitted">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
    <div class="tab-button" data-target="interview">–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ</div>
    <div class="tab-button" data-target="accepted">–ü—Ä–∏–Ω—è—Ç—ã</div>
</div>

<div class="columns">
  <div class="column active" id="submitted"><h2>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ üíå</h2></div>
  <div class="column" id="interview"><h2>–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ üéÄ</h2></div>
  <div class="column" id="accepted"><h2>–ü—Ä–∏–Ω—è—Ç—ã üëë</h2></div>
</div>

<div class="stats-container" style="margin-top:30px; background:white; padding:20px; border-radius:30px; border:4px solid var(--pink-soft);">
    <h2 style="text-align: center; color: var(--pink-bright); font-size: 1.4rem;">üíñ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π üíñ</h2>
    <div id="statsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;"></div>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeModal">‚úï</span>
    <img id="volunteerPhoto" src="" alt="–§–æ—Ç–æ">
    <h3 id="volunteerName" style="text-align: center; color: var(--pink-bright); font-size: 1.6rem; margin: 0 0 15px 0;"></h3>
    
    <div style="font-size: 0.95rem; line-height: 1.6;">
        <p><strong>üìß Email:</strong> <span id="volunteerEmail"></span></p>
        <p><strong>üìû –¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="volunteerPhone"></span></p>
        <p><strong>üéÇ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> <span id="volunteerDOB"></span></p>
        <p><strong>üè´ –ú–µ—Å—Ç–æ —É—á–µ–±—ã:</strong> <span id="volunteerStudy"></span></p>
        <hr style="border: 1px dashed var(--pink-soft);">
        <p><strong>üåà –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:</strong></p>
        <div id="volunteerDirections"></div>
        <hr style="border: 1px dashed var(--pink-soft);">
        <p><strong>ü§ù –û —Å–µ–±–µ:</strong> <span id="volunteerWhy"></span></p>
        <p><strong>‚è∞ –í—Ä–µ–º—è:</strong> <span id="volunteerHours"></span></p>
        <p><strong>üöó –í—ã–µ–∑–¥—ã:</strong> <span id="volunteerReadyTravel"></span></p>
    </div>
    <div class="buttons" id="modalButtons"></div>
  </div>
</div>

<script>
/* JS –õ–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∞ '‚úï' */
const columns = {
  submitted: document.getElementById('submitted'),
  interview: document.getElementById('interview'),
  accepted: document.getElementById('accepted')
};

const searchName = document.getElementById('searchName');
const filterStudy = document.getElementById('filterStudy');
const filterYear = document.getElementById('filterYear');
const statsGrid = document.getElementById('statsGrid');
const modal = document.getElementById('modal');
const closeModal = document.getElementById('closeModal');
const tabButtons = document.querySelectorAll('.tab-button');

let volunteers = [];

function spawnFairy() {
    const f = document.createElement('div');
    f.className = 'fairy-dust';
    f.innerHTML = ['‚ú®','üå∏','üíñ','ü¶Ñ'][Math.floor(Math.random()*4)];
    f.style.left = Math.random() * 100 + 'vw';
    f.style.animationDuration = (Math.random() * 3 + 2) + 's';
    document.body.appendChild(f);
    setTimeout(() => f.remove(), 5000);
}
setInterval(spawnFairy, 500);

async function fetchVolunteers() {
  try {
    const res = await fetch('/api/volunteer-columns/'); 
    const data = await res.json();
    volunteers = [];
    ['submitted','interview','accepted'].forEach(status => {
      (data[status] || []).forEach(v => { volunteers.push({...v, status: status}); });
    });
    populateFilters(); renderColumns(); renderStats();
  } catch (err) { console.error('–û—à–∏–±–∫–∞:', err); }
}

function populateFilters() {
    const studies = new Set(); const years = new Set();
    volunteers.forEach(v => {
        if (v.place_of_study) studies.add(v.place_of_study);
        if (v.date_of_birth) years.add(v.date_of_birth.split('-')[0]);
    });
    filterStudy.innerHTML = '<option value="">üè´ –í—Å–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è</option>';
    filterYear.innerHTML = '<option value="">üìÖ –í—Å–µ –≥–æ–¥—ã</option>';
    Array.from(studies).sort().forEach(s => filterStudy.innerHTML += `<option value="${s}">${s}</option>`);
    Array.from(years).sort((a,b) => b-a).forEach(y => filterYear.innerHTML += `<option value="${y}">${y}</option>`);
}

function renderColumns() {
  const titles = { submitted: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', interview: '–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ', accepted: '–ü—Ä–∏–Ω—è—Ç—ã' };
  const nQ = searchName.value.toLowerCase();
  const sQ = filterStudy.value;
  const yQ = filterYear.value;

  for (let col in columns) {
    const list = volunteers.filter(v => {
        const mS = v.status === col;
        const mN = (v.full_name || v.name).toLowerCase().includes(nQ);
        const mSt = !sQ || v.place_of_study === sQ;
        const mY = !yQ || (v.date_of_birth && v.date_of_birth.startsWith(yQ));
        return mS && mN && mSt && mY;
    });
    
    columns[col].innerHTML = `<h2>${titles[col]} (${list.length})</h2>`;
    list.forEach(v => {
      const card = document.createElement('div');
      card.className = 'card';
      const photo = v.photo_url || v.image_url;
      card.innerHTML = `
        <img src="${photo || 'https://via.placeholder.com/60/ffe5ec/800020?text=üå∏'}" alt="ava">
        <div class="card-info">
          <strong>${v.full_name || v.name}</strong>
          <div class="directions-brief">‚ú® ${v.directions ? v.directions.map(d => d.name || d).join(', ') : '---'}</div>
        </div>`;
      card.onclick = () => openModal(v);
      columns[col].appendChild(card);
    });
  }
}

function renderStats() {
    const counts = {};
    volunteers.forEach(v => {
        if (v.directions) v.directions.forEach(d => { const n = d.name || d; counts[n] = (counts[n] || 0) + 1; });
    });
    statsGrid.innerHTML = '';
    Object.entries(counts).sort((a,b) => b[1] - a[1]).forEach(([name, count]) => {
        statsGrid.innerHTML += `<div style="background:#fff5f8; padding:8px; border-radius:12px; border:1px solid var(--pink-soft); display:flex; justify-content:space-between; font-size:0.85rem;"><span>${name}</span><b style="color:var(--pink-bright)">${count}</b></div>`;
    });
}

function openModal(v) {
  const vPhoto = document.getElementById('volunteerPhoto');
  vPhoto.src = v.photo_url || v.image_url || '';
  vPhoto.style.display = (v.photo_url || v.image_url) ? 'block' : 'none';

  document.getElementById('volunteerName').textContent = v.full_name || v.name; 
  document.getElementById('volunteerEmail').textContent = v.email || '-';
  document.getElementById('volunteerPhone').textContent = v.phone_number || '-';
  document.getElementById('volunteerDOB').textContent = v.date_of_birth || '-';
  document.getElementById('volunteerStudy').textContent = v.place_of_study || '-';
  document.getElementById('volunteerWhy').textContent = v.why_volunteer || '-';
  document.getElementById('volunteerHours').textContent = v.weekly_hours || '-';
  document.getElementById('volunteerReadyTravel').textContent = v.ready_travel ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç';

  const vDirs = document.getElementById('volunteerDirections');
  vDirs.innerHTML = (v.directions) ? v.directions.map(d => `<span style="background:var(--pink-soft); padding:2px 8px; border-radius:10px; margin:2px; display:inline-block; font-size:0.8rem;">${d.name || d}</span>`).join('') : '-';

  const mBtns = document.getElementById('modalButtons');
  mBtns.innerHTML = '';
  let statusButtons = v.status === 'submitted' ? ['–ù–∞ 2 —ç—Ç–∞–ø', '–û—Ç–∫–∞–∑'] : (v.status === 'interview' ? ['–ü—Ä–∏–Ω—è—Ç', '–û—Ç–∫–∞–∑'] : []);

  statusButtons.forEach(btn => {
    const b = document.createElement('button');
    b.textContent = btn; b.className = btn === '–û—Ç–∫–∞–∑' ? 'btn-reject' : 'btn-stage';
    b.onclick = () => updateStatus(v.id, btn);
    mBtns.appendChild(b);
  });
  modal.style.display = 'flex';
}

async function updateStatus(id, action) {
  const statusMap = { '–ù–∞ 2 —ç—Ç–∞–ø': 'interview', '–ü—Ä–∏–Ω—è—Ç': 'accepted', '–û—Ç–∫–∞–∑': 'rejected' };
  try {
    await fetch(`/api/applications/${id}/update_status/`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({status: statusMap[action]})
    });
    modal.style.display = 'none'; fetchVolunteers();
  } catch(err) { alert('–û—à–∏–±–∫–∞ –º–∞–≥–∏–∏!'); }
}

searchName.addEventListener('input', renderColumns);
filterStudy.addEventListener('change', renderColumns);
filterYear.addEventListener('change', renderColumns);
tabButtons.forEach(btn => btn.onclick = () => {
    tabButtons.forEach(b => b.classList.remove('active')); btn.classList.add('active');
    Object.values(columns).forEach(c => c.classList.remove('active'));
    document.getElementById(btn.dataset.target).classList.add('active');
});
closeModal.onclick = () => modal.style.display = 'none';
window.onclick = (e) => { if(e.target === modal) modal.style.display='none'; }

fetchVolunteers();
</script>
</body>
</html>