<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Доска Волонтёров</title>
<style>
/* ОСНОВНОЙ СТИЛЬ */
body {
    font-family: 'Arial', sans-serif;
    background: linear-gradient(135deg,#f0f2f5,#e0e7ff);
    margin: 0;
    padding: 20px;
    color: #333;
}
h1 {
    text-align: center;
    margin-bottom: 20px;
    font-size: 2.5rem;
    color: #1e3a8a;
}

/* ПАНЕЛЬ ФИЛЬТРОВ */
.filter-panel {
    background: #fff;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 30px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
}
.filter-panel input, .filter-panel select {
    padding: 10px 15px;
    border: 2px solid #e0e7ff;
    border-radius: 8px;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.2s;
}
.filter-panel input:focus, .filter-panel select:focus {
    border-color: #3b82f6;
}
.filter-panel input[type="text"] {
    flex: 1;
    min-width: 250px;
}

.columns {
    display: flex;
    gap: 20px;
    flex-wrap: nowrap;
    justify-content: center;
}
.column {
    flex: 1 1 300px;
    background: #fff;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    min-width: 280px;
}
.column h2 {
    text-align: center;
    margin-bottom: 20px;
    text-transform: uppercase;
    color: #1e40af;
}

/* КАРТОЧКИ */
.card {
    background: #f9fafb;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
    border-left: 4px solid #3b82f6;
}
.card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}
.card img { 
    width: 60px; 
    height: 60px; 
    object-fit: cover; 
    border-radius: 50%; 
    border: 2px solid #3b82f6; 
}
.card-info {
    display: flex;
    flex-direction: column;
}
.card-info strong {
    font-size: 1.1rem;
    color: #1e3a8a;
}
.card-info span {
    font-size: 0.9rem;
    color: #555;
}
.card-info .directions-brief {
    font-size: 0.8rem;
    color: #3b82f6;
    margin-top: 2px;
}

/* СТАТИСТИКА */
.stats-container {
    margin-top: 40px;
    background: #fff;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
}
.stat-item {
    background: #f1f5f9;
    padding: 10px 15px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
}

/* МОДАЛКА */
.modal {
    display: none;
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
.modal-content {
    background: #fff;
    border-radius: 15px;
    padding: 25px;
    width: 500px;
    max-height: 90%;
    overflow-y: auto;
    position: relative;
}
.close-btn {
    position: absolute;
    top: 10px; right: 15px;
    cursor: pointer; font-size: 1.5rem; color: #888;
}
.modal-content img {
    display: block; width: 100%; height: auto; max-height: 400px;
    object-fit: contain; border-radius: 12px; margin: 0 auto 15px auto;
    border: 3px solid #3b82f6; background-color: #f3f4f6;
}
.directions-list { padding-left: 20px; color: #1e3a8a; font-weight: 600; }
.buttons { margin-top: 20px; display: flex; gap: 10px; }
.buttons button { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: #fff; }
.btn-stage { background: #3b82f6; }
.btn-reject { background: #ef4444; }

/* АДАПТИВНОСТЬ */
.tabs { display: none; background: #fff; border-radius: 10px; margin-bottom: 20px; justify-content: space-around; }
.tab-button { flex: 1; padding: 15px 10px; text-align: center; cursor: pointer; font-weight: bold; }
.tab-button.active { color: #1e40af; border-bottom: 3px solid #3b82f6; }

@media (max-width: 768px) {
    .columns { flex-direction: column; }
    .column { display: none; width: 100%; }
    .column.active { display: block; }
    .tabs { display: flex; }
    .filter-panel { flex-direction: column; align-items: stretch; }
}
</style>
</head>
<body>

<h1>Доска Волонтёров</h1>

<div class="filter-panel">
    <input type="text" id="searchName" placeholder="Поиск по ФИО...">
    <select id="filterStudy">
        <option value="">Все учебные заведения</option>
    </select>
    <select id="filterYear">
        <option value="">Все годы рождения</option>
    </select>
</div>

<div class="tabs" id="tabs">
    <div class="tab-button active" data-target="submitted">Отправлено</div>
    <div class="tab-button" data-target="interview">Собеседование</div>
    <div class="tab-button" data-target="accepted">Приняты</div>
</div>

<div class="columns">
  <div class="column active" id="submitted"><h2>Отправлено</h2></div>
  <div class="column" id="interview"><h2>Собеседование</h2></div>
  <div class="column" id="accepted"><h2>Приняты</h2></div>
</div>

<div class="stats-container">
    <h2 style="color: #1e3a8a; text-align: center;">Статистика направлений (Все анкеты)</h2>
    <div class="stats-grid" id="statsGrid"></div>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeModal">&times;</span>
    <img id="volunteerPhoto" src="" alt="Фото">
    <h3 id="volunteerName"></h3>
    <p><strong>Email:</strong> <span id="volunteerEmail"></span></p>
    <p><strong>Телефон:</strong> <span id="volunteerPhone"></span></p>
    <p><strong>Дата рождения:</strong> <span id="volunteerDOB"></span></p>
    <p><strong>Место учебы:</strong> <span id="volunteerStudy"></span></p>
    <hr>
    <p><strong>Направления:</strong></p>
    <div id="volunteerDirections"></div>
    <p><strong>Почему эти направления:</strong> <span id="volunteerChoiceMotives"></span></p>
    <hr>
    <p><strong>О себе и волонтерстве:</strong> <span id="volunteerWhy"></span></p>
    <p><strong>Опыт:</strong> <span id="volunteerExperience"></span></p>
    <p><strong>Навыки/Хобби:</strong> <span id="volunteerHobbies"></span></p>
    <p><strong>Сильные качества:</strong> <span id="volunteerStrengths"></span></p>
    <p><strong>Почему выбрать Вас:</strong> <span id="volunteerChoose"></span></p>
    <hr>
    <p><strong>Время в неделю:</strong> <span id="volunteerHours"></span></p>
    <p><strong>Будет на собраниях:</strong> <span id="volunteerMeetings"></span></p>
    <p><strong>Готовы к выездам:</strong> <span id="volunteerReadyTravel"></span></p>
    <p><strong>Согласие (удаление):</strong> <span id="volunteerAgreeInactivity"></span></p>
    <p><strong>Согласие (условия):</strong> <span id="volunteerAgreeTerms"></span></p>
    <hr>
    <p><strong>Ожидания:</strong> <span id="volunteerExpectations"></span></p>
    <p><strong>Идеи:</strong> <span id="volunteerIdeas"></span></p>
    <div class="buttons" id="modalButtons"></div>
  </div>
</div>

<script>
const columns = {
  submitted: document.getElementById('submitted'),
  interview: document.getElementById('interview'),
  accepted: document.getElementById('accepted')
};

const searchName = document.getElementById('searchName');
const filterStudy = document.getElementById('filterStudy');
const filterYear = document.getElementById('filterYear');
const statsGrid = document.getElementById('statsGrid');
const modal = document.getElementById('modal');
const closeModal = document.getElementById('closeModal');
const tabButtons = document.querySelectorAll('.tab-button');

let volunteers = [];

async function fetchVolunteers() {
  try {
    const res = await fetch('/api/volunteer-columns/'); 
    const data = await res.json();
    volunteers = [];
    ['submitted','interview','accepted'].forEach(status => {
      (data[status] || []).forEach(v => {
        volunteers.push({...v, status: status});
      });
    });
    populateFilters();
    renderColumns();
    renderStats();
  } catch (err) { console.error('Ошибка загрузки:', err); }
}

// Заполнение выпадающих списков уникальными значениями
function populateFilters() {
    const studies = new Set();
    const years = new Set();

    volunteers.forEach(v => {
        if (v.place_of_study) studies.add(v.place_of_study);
        if (v.date_of_birth) {
            const year = v.date_of_birth.split('-')[0];
            years.add(year);
        }
    });

    // Очистка и добавление (кроме первой опции)
    filterStudy.innerHTML = '<option value="">Все учебные заведения</option>';
    filterYear.innerHTML = '<option value="">Все годы рождения</option>';

    Array.from(studies).sort().forEach(s => {
        filterStudy.innerHTML += `<option value="${s}">${s}</option>`;
    });
    Array.from(years).sort((a,b) => b-a).forEach(y => {
        filterYear.innerHTML += `<option value="${y}">${y}</option>`;
    });
}

function renderColumns() {
  const titles = { submitted: 'Отправлено', interview: 'Собеседование', accepted: 'Приняты' };
  const nameQuery = searchName.value.toLowerCase();
  const studyQuery = filterStudy.value;
  const yearQuery = filterYear.value;

  for (let col in columns) {
    const list = volunteers.filter(v => {
        const matchesStatus = v.status === col;
        const matchesName = (v.full_name || v.name).toLowerCase().includes(nameQuery);
        const matchesStudy = !studyQuery || v.place_of_study === studyQuery;
        const matchesYear = !yearQuery || (v.date_of_birth && v.date_of_birth.startsWith(yearQuery));
        
        return matchesStatus && matchesName && matchesStudy && matchesYear;
    });
    
    columns[col].innerHTML = `<h2>${titles[col]} (${list.length})</h2>`;
    const tBtn = document.querySelector(`.tab-button[data-target="${col}"]`);
    if(tBtn) tBtn.textContent = `${titles[col]} (${list.length})`;

    list.forEach(v => {
      const photoSource = v.photo_url || v.image_url; 
      const card = document.createElement('div');
      card.className = 'card';
      const dirText = v.directions ? v.directions.map(d => d.name || d).join(', ') : 'Не указано';

      card.innerHTML = `
        ${photoSource ? `<img src="${photoSource}" alt="Фото">` : '<div style="width:60px;height:60px;background:#eee;border-radius:50%"></div>'}
        <div class="card-info">
          <strong>${v.full_name || v.name}</strong>
          <span>${v.phone_number || 'Нет номера'}</span>
          <span class="directions-brief"><b>Напр:</b> ${dirText}</span>
        </div>`;
      card.onclick = () => openModal(v);
      columns[col].appendChild(card);
    });
  }
}

function renderStats() {
    const counts = {};
    volunteers.forEach(v => {
        if (v.directions) {
            v.directions.forEach(d => {
                const name = d.name || d;
                counts[name] = (counts[name] || 0) + 1;
            });
        }
    });
    statsGrid.innerHTML = '';
    Object.entries(counts).sort((a,b) => b[1] - a[1]).forEach(([name, count]) => {
        statsGrid.innerHTML += `<div class="stat-item"><strong>${name}</strong><span>${count}</span></div>`;
    });
}

// Слушатели для фильтров
searchName.addEventListener('input', renderColumns);
filterStudy.addEventListener('change', renderColumns);
filterYear.addEventListener('change', renderColumns);

function formatISODate(isoDate) {
    if (!isoDate) return '-';
    const parts = isoDate.split('-');
    return parts.length === 3 ? `${parts[2]}.${parts[1]}.${parts[0]}` : isoDate;
}

function openModal(v) {
  const vPhoto = document.getElementById('volunteerPhoto');
  vPhoto.src = v.photo_url || v.image_url || '';
  vPhoto.style.display = (v.photo_url || v.image_url) ? 'block' : 'none';

  document.getElementById('volunteerName').textContent = v.full_name || v.name; 
  document.getElementById('volunteerEmail').textContent = v.email || '-';
  document.getElementById('volunteerPhone').textContent = v.phone_number || '-';
  document.getElementById('volunteerDOB').textContent = formatISODate(v.date_of_birth);
  document.getElementById('volunteerStudy').textContent = v.place_of_study || '-';
  document.getElementById('volunteerChoiceMotives').textContent = v.choice_motives || '-';
  document.getElementById('volunteerWhy').textContent = v.why_volunteer || '-';
  document.getElementById('volunteerExperience').textContent = v.volunteer_experience || '-';
  document.getElementById('volunteerHobbies').textContent = v.hobbies_skills || '-';
  document.getElementById('volunteerStrengths').textContent = v.strengths || '-';
  document.getElementById('volunteerChoose').textContent = v.why_choose_you || '-';
  document.getElementById('volunteerHours').textContent = v.weekly_hours || '-';
  document.getElementById('volunteerIdeas').textContent = v.ideas_improvements || '-';
  document.getElementById('volunteerExpectations').textContent = v.expectations || '-';
  document.getElementById('volunteerAgreeInactivity').textContent = v.agree_inactivity_removal ? 'Да' : 'Нет';
  document.getElementById('volunteerAgreeTerms').textContent = v.agree_terms ? 'Да' : 'Нет';
  document.getElementById('volunteerReadyTravel').textContent = v.ready_travel ? 'Да' : 'Нет';
  document.getElementById('volunteerMeetings').textContent = v.attend_meetings ? 'Да' : 'Нет';

  const vDirs = document.getElementById('volunteerDirections');
  if (v.directions && v.directions.length > 0) {
        vDirs.innerHTML = `<ul class="directions-list">${v.directions.map(d => `<li>${d.name || d}</li>`).join('')}</ul>`;
  } else { vDirs.innerHTML = '<span>-</span>'; }

  const mBtns = document.getElementById('modalButtons');
  mBtns.innerHTML = '';
  let statusButtons = [];
  if(v.status === 'submitted') statusButtons = ['На 2 этап', 'Отказ'];
  else if(v.status === 'interview') statusButtons = ['Принят', 'Отказ'];

  statusButtons.forEach(btn => {
    const button = document.createElement('button');
    button.textContent = btn;
    button.className = btn === 'Отказ' ? 'btn-reject' : 'btn-stage';
    button.onclick = () => updateStatus(v.id, btn);
    mBtns.appendChild(button);
  });
  modal.style.display = 'flex';
}

async function updateStatus(id, action) {
  const statusMap = { 'На 2 этап': 'interview', 'Принят': 'accepted', 'Отказ': 'rejected' };
  const newStatus = statusMap[action];
  try {
    await fetch(`/api/applications/${id}/update_status/`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({status: newStatus})
    });
    modal.style.display = 'none';
    fetchVolunteers();
  } catch(err) { alert('Ошибка соединения'); }
}

tabButtons.forEach(button => {
    button.addEventListener('click', () => {
        const targetId = button.getAttribute('data-target');
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        for (let colId in columns) columns[colId].classList.remove('active');
        document.getElementById(targetId).classList.add('active');
    });
});

closeModal.onclick = () => modal.style.display = 'none';
window.onclick = (e) => { if(e.target === modal) modal.style.display='none'; }

fetchVolunteers();
</script>
</body>
</html>