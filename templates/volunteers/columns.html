<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Доска Волонтёров</title>
<style>
/* ОСНОВНОЙ СТИЛЬ */
body {
    font-family: 'Arial', sans-serif;
    background: linear-gradient(135deg,#f0f2f5,#e0e7ff);
    margin: 0;
    padding: 20px;
    color: #333;
}
h1 {
    text-align: center;
    margin-bottom: 30px;
    font-size: 2.5rem; /* Крупный заголовок */
    color: #1e3a8a;
}
.columns {
    display: flex;
    gap: 20px;
    flex-wrap: nowrap;
    justify-content: center;
}
.column {
    flex: 1 1 350px; /* Увеличил ширину колонки */
    background: #fff;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    min-width: 300px;
}
.column h2 {
    text-align: center;
    margin-bottom: 25px;
    text-transform: uppercase;
    color: #1e40af;
    font-size: 1.3rem; /* Крупный текст заголовка колонки */
}

/* СТИЛИ КАРТОЧЕК */
.card {
    background: #f9fafb;
    border-radius: 12px;
    padding: 20px; /* Больше внутренних отступов */
    margin-bottom: 15px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    align-items: center;
    gap: 20px; /* Больше расстояния между фото и текстом */
    border-left: 6px solid #3b82f6; /* Толще линия */
}
.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.15);
}
.card img { 
    width: 80px;  /* Крупное фото */
    height: 80px; 
    object-fit: cover; 
    border-radius: 50%; 
    border: 3px solid #3b82f6; 
    flex-shrink: 0;
}
.card-info {
    display: flex;
    flex-direction: column;
    gap: 5px; /* Расстояние между строками текста */
}
.card-info strong {
    font-size: 1.25rem; /* Крупное ФИО */
    color: #1e3a8a;
}
.card-info .phone {
    font-size: 1.05rem; /* Крупный номер */
    color: #444;
    font-weight: bold;
}
.card-info .directions {
    font-size: 0.95rem; /* Хорошо читаемые направления */
    color: #1e40af;
    line-height: 1.4;
}

/* СЕКЦИЯ СТАТИСТИКИ */
.stats-section {
    background: #fff;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    max-width: 1200px;
    margin: 50px auto 20px auto;
}
.stats-section h2 {
    text-align: center;
    font-size: 1.8rem;
    margin-bottom: 30px;
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
}
.stat-item {
    background: #f1f5f9;
    padding: 15px 20px;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.1rem;
    border-bottom: 4px solid #3b82f6;
}
.stat-count {
    font-weight: bold;
    color: #fff;
    background: #3b82f6;
    padding: 5px 15px;
    border-radius: 20px;
}

/* МОДАЛЬНОЕ ОКНО */
.modal {
    display: none;
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
.modal-content {
    background: #fff;
    border-radius: 20px;
    padding: 30px;
    width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
}
.close-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    cursor: pointer;
    font-size: 2rem;
}

@media (max-width: 768px) {
    .columns { flex-direction: column; }
    .column { display: none; width: 100%; }
    .column.active { display: block; }
    .tabs { display: flex; justify-content: space-around; background: #fff; margin-bottom: 20px; }
    .tab-button { padding: 20px; font-size: 1.1rem; flex: 1; text-align: center; }
    .tab-button.active { border-bottom: 4px solid #3b82f6; color: #1e3a8a; }
}
</style>
</head>
<body>

<h1>Доска Волонтёров</h1>

<div class="tabs" id="tabs">
    <div class="tab-button active" data-target="submitted">Отправлено</div>
    <div class="tab-button" data-target="interview">Собеседование</div>
    <div class="tab-button" data-target="accepted">Приняты</div>
</div>

<div class="columns">
  <div class="column active" id="submitted"><h2>Отправлено (0)</h2></div>
  <div class="column" id="interview"><h2>Собеседование (0)</h2></div>
  <div class="column" id="accepted"><h2>Приняты (0)</h2></div>
</div>

<div class="stats-section">
    <h2>Статистика направлений</h2>
    <div class="stats-grid" id="statsGrid"></div>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeModal">&times;</span>
    <img id="volunteerPhoto" src="" alt="Фото" style="width:100%; border-radius:15px; margin-bottom:20px; border: 4px solid #3b82f6;">
    <h3 id="volunteerName" style="text-align:center; font-size: 1.8rem;"></h3>
    <div id="modalDetails" style="font-size: 1.1rem; line-height: 1.8;"></div>
    <div class="buttons" id="modalButtons" style="display:flex; gap:15px; margin-top:30px;"></div>
  </div>
</div>

<script>
const columns = {
  submitted: document.getElementById('submitted'),
  interview: document.getElementById('interview'),
  accepted: document.getElementById('accepted')
};
const statsGrid = document.getElementById('statsGrid');
const modal = document.getElementById('modal');
const closeModal = document.getElementById('closeModal');

let volunteers = [];

async function fetchVolunteers() {
  try {
    const res = await fetch('/api/volunteer-columns/'); 
    const data = await res.json();
    volunteers = [];
    ['submitted','interview','accepted'].forEach(status => {
      (data[status] || []).forEach(v => {
        volunteers.push({...v, status: status});
      });
    });
    renderColumns();
    renderStats();
  } catch (err) { console.error('Ошибка:', err); }
}

function renderColumns() {
  const titles = { submitted: 'Отправлено', interview: 'Собеседование', accepted: 'Приняты' };
  
  for (let col in columns) {
    const list = volunteers.filter(v => v.status === col);
    columns[col].querySelector('h2').textContent = `${titles[col]} (${list.length})`;
    
    // Обновляем текст табов
    const tBtn = document.querySelector(`.tab-button[data-target="${col}"]`);
    if(tBtn) tBtn.textContent = `${titles[col]} (${list.length})`;

    const cards = columns[col].querySelectorAll('.card');
    cards.forEach(c => c.remove());
    
    list.forEach(v => {
      const card = document.createElement('div');
      card.className = 'card';
      const photo = v.photo_url || v.image_url;
      
      const dirText = (v.directions && v.directions.length > 0)
        ? v.directions.map(d => d.name || d).join(', ') 
        : 'Не указано';

      card.innerHTML = `
        ${photo ? `<img src="${photo}">` : '<div style="width:80px; height:80px; border-radius:50%; background:#ddd; flex-shrink:0;"></div>'}
        <div class="card-info">
          <strong>${v.full_name || v.name}</strong>
          <span class="phone">${v.phone_number || 'Нет номера'}</span>
          <span class="directions"><b>Напр:</b> ${dirText}</span>
        </div>`;
      card.onclick = () => openModal(v);
      columns[col].appendChild(card);
    });
  }
}

function renderStats() {
    const counts = {};
    volunteers.forEach(v => {
        if (v.directions) {
            v.directions.forEach(d => {
                const name = d.name || d;
                counts[name] = (counts[name] || 0) + 1;
            });
        }
    });
    statsGrid.innerHTML = '';
    Object.entries(counts).sort((a,b) => b[1]-a[1]).forEach(([name, count]) => {
        statsGrid.innerHTML += `
            <div class="stat-item">
                <span>${name}</span>
                <span class="stat-count">${count}</span>
            </div>`;
    });
}

function openModal(v) {
  document.getElementById('volunteerPhoto').src = v.photo_url || v.image_url || '';
  document.getElementById('volunteerPhoto').style.display = (v.photo_url || v.image_url) ? 'block' : 'none';
  document.getElementById('volunteerName').textContent = v.full_name || v.name;
  
  const details = document.getElementById('modalDetails');
  details.innerHTML = `
    <p><strong>Телефон:</strong> ${v.phone_number || '-'}</p>
    <p><strong>Email:</strong> ${v.email || '-'}</p>
    <p><strong>Дата рождения:</strong> ${v.date_of_birth || '-'}</p>
    <p><strong>Направления:</strong> ${v.directions ? v.directions.map(d => d.name || d).join(', ') : '-'}</p>
    <p><strong>Опыт:</strong> ${v.volunteer_experience || '-'}</p>
  `;

  const btnBox = document.getElementById('modalButtons');
  btnBox.innerHTML = '';
  
  if(v.status !== 'accepted') {
    const b1 = document.createElement('button');
    b1.textContent = v.status === 'submitted' ? 'На собеседование' : 'Принять';
    b1.style = "flex:1; padding:15px; background:#3b82f6; color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:bold; font-size:1.1rem;";
    b1.onclick = () => updateStatus(v.id, v.status === 'submitted' ? 'interview' : 'accepted');
    btnBox.appendChild(b1);

    const b2 = document.createElement('button');
    b2.textContent = 'Отказ';
    b2.style = "flex:1; padding:15px; background:#ef4444; color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:bold; font-size:1.1rem;";
    b2.onclick = () => updateStatus(v.id, 'rejected');
    btnBox.appendChild(b2);
  }

  modal.style.display = 'flex';
}

async function updateStatus(id, newStatus) {
  await fetch(`/api/applications/${id}/update_status/`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({status: newStatus})
  });
  modal.style.display = 'none';
  fetchVolunteers();
}

document.querySelectorAll('.tab-button').forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll('.tab-button, .column').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.target).classList.add('active');
    };
});

closeModal.onclick = () => modal.style.display = 'none';
window.onclick = e => { if(e.target === modal) modal.style.display = 'none'; };

fetchVolunteers();
</script>
</body>
</html>