{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Схема зала</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f0f0f0;
  text-align: center;
  margin: 0;
  padding: 0 0 100px;
}

h2 { margin: 15px 0; }

.legend {
  margin: 20px auto;
  display: flex;
  justify-content: center;
  gap: 20px;
  font-size: 12px;
  position: relative;
  z-index: 100;
}
.legend-item { display: flex; align-items: center; gap: 5px; }
.legend-color { width: 14px; height: 14px; border-radius: 3px; }
.free-color { background: #2e7d32; }
.booked-color { background: #616161; }
.orange-color { background: #ff9800; }

.hall-container {
  display: flex;
  flex-direction: column-reverse;
  align-items: center;
  gap: 6px;
}

.row {
  display: flex;
  flex-direction: row-reverse;
  gap: 4px;
  justify-content: center;
  align-items: center;
  position: relative;
}

.seat {
  width: 20px;
  height: 20px;
  font-size: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 3px;
  cursor: pointer;
  color: white;
  background: #2e7d32;
  transition: transform 0.3s ease, background 0.3s ease;
  position: relative;
}
.seat:hover { transform: scale(1.3); background: #1b5e20; }

.booked { background: #616161; cursor: not-allowed; }
.premium { background: #ff9800; }
.premium:hover { background: #e65100; }

.gap {
  width: 50px;
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 10px;
  font-weight: bold;
  color: #1e3d7b;
}

.stage {
  margin: 50px auto 0;
  width: calc(36*20px + 35*4px + 50px);
  padding: 6px;
  background: #1e3d7b;
  color: white;
  font-weight: bold;
  border-radius: 3px;
}

/* Модалка */
.modal {
  display: none;
  position: fixed;
  z-index: 10;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  justify-content: center;
  align-items: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.modal.show { display:flex; opacity:1; }

.modal-content {
  background: linear-gradient(145deg, #ffffff, #e3f2fd);
  padding: 25px;
  border-radius: 8px;
  text-align: left;
  width: 360px;
  max-width: 90%;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  transform: scale(0.85);
  transition: transform 0.3s ease, opacity 0.3s ease;
}
.modal.show .modal-content { transform: scale(1); }

.modal-content input {
  width: 100%;
  padding: 10px;
  margin-bottom: 12px;
  border: 1px solid #90caf9;
  border-radius: 4px;
  outline: none;
  transition: border 0.3s;
  font-size: 13px;
}
.modal-content input:focus { border: 2px solid #1e88e5; }

.modal-content button {
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 4px;
  background: #1e88e5;
  color: white;
  font-weight: bold;
  font-size: 13px;
  cursor: pointer;
  transition: background 0.3s ease;
}
.modal-content button:hover { background: #1565c0; }

/* Tooltip */
.tooltip {
  position: absolute;
  display: none;
  background: rgba(33,33,33,0.95);
  color: white;
  padding: 5px 8px;
  border-radius: 4px;
  font-size: 11px;
  white-space: nowrap;
  pointer-events: none;
  z-index: 1000;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.tooltip.show { display: block; opacity: 1; }
</style>
</head>
<body>

<div class="legend">
  <div class="legend-item">
    <div class="legend-color free-color"></div> 1500 сом
  </div>
  <div class="legend-item">
    <div class="legend-color orange-color"></div> 1000 сом
  </div>
  <div class="legend-item">
    <div class="legend-color booked-color"></div> Занято
  </div>
</div>

<h2>Амфитеатр</h2>
<div class="hall-container" id="amphitheater"></div>

<h2>Партер</h2>
<div class="hall-container" id="parter"></div>

<div class="stage">СЦЕНА</div>

<!-- Модалка -->
<div class="modal" id="bookingModal">
  <div class="modal-content">
    <h3>Бронирование</h3>
    <form id="bookingForm">
      {% csrf_token %}
      <input type="hidden" id="modalRow">
      <input type="hidden" id="modalSeat">
      <input type="hidden" id="modalPrice" value="1500">
      <input type="hidden" id="modalHall">
      <input type="text" id="fullName" placeholder="Введите ФИО" required>
      <input type="text" id="phone" placeholder="Введите телефон" required>
      <button type="submit">Забронировать и скачать билет</button>
    </form>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// ======= ФУНКЦИЯ СОЗДАНИЯ МЕСТ =======
function createSeat(row, seatNumber, hall, price=1500, isBooked=false, isPremium=false) {
  let seatDiv = document.createElement("div");
  seatDiv.className = "seat";
  if(isBooked) seatDiv.classList.add("booked");
  if(isPremium) { seatDiv.classList.add("premium"); price = 1000; }

  seatDiv.innerText = seatNumber;
  seatDiv.dataset.row = row;
  seatDiv.dataset.seat = seatNumber;
  seatDiv.dataset.price = price;
  seatDiv.dataset.hall = hall;
  seatDiv.dataset.tooltip = `Ряд ${row}, Место ${seatNumber}, ${price} сом`;

  seatDiv.onclick = ()=> openModal(seatDiv);
  return seatDiv;
}

// ======= ПАРТЕР =======
let rowsConfig = {1:24,2:26,3:28,4:30,5:32,6:34,7:34,8:36,9:36,10:36,11:36};
let gapAfter = {1:13,2:14,3:15,4:16,5:17,6:18,7:18,8:19,9:19,10:19,11:19};
let hall = document.getElementById("parter");
let amphHall = document.getElementById("amphitheater");

let booked = [
{% for b in bookings %}
  {row: {{ b.row }}, seat: {{ b.seat }}, hall: "{{ b.hall_type }}" },
{% endfor %}
];

let premiumSeats = [
  {row:3, seats:[1,2,27,28]},
  {row:4, seats:[1,2,3,28,29,30]},
  {row:5, seats:[1,2,3,4,29,30,31,32]},
  {row:6, seats:[1,2,3,4,5,30,31,32,33,34]},
  {row:7, seats:[1,2,3,4,5,30,31,32,33,34]},
  {row:8, seats:[1,2,3,4,5,6,31,32,33,34,35,36]},
  {row:9, seats:[1,2,3,4,5,6,31,32,33,34,35,36]},
  {row:10,seats:[1,2,3,4,5,6,31,32,33,34,35,36]},
  {row:11,seats:[1,2,3,4,5,6,31,32,33,34,35,36]}
];

// ======= АМФИТЕАТР ПРЕМИУМ =======
let amphPremiumSeats = [
  {row:1, seats:[1,2,3,4,5,6,28,29,30,31,32]},
  {row:2, seats:[1,2,3,4,5,6,7,28,29,30,31,32,33,34]},
  {row:3, seats:[1,2,3,4,5,6,27,28,29,30,31,32]},
  {row:4, seats:[1,2,3,4,5,6,29,30,31,32,33,34]},
  {row:5, seats:[1,2,3,4,5,28,29,30,31,32]},
  {row:6, seats:[1,2,3,4,5,27,28,29,30,31]},
  {row:7, seats:[1,2,3,4,25,26,27,28]},
  {row:8, seats:[1,2,3,4,25,26,27,28]},
  {row:9, seats:[1,2,3,4,25,26,27,28]},
  {row:10,seats:[1,2,3,24,25,26]},
  {row:11,seats:[1,2,3,24,25,26]}
];

for (let row=1; row<=11; row++){
  let div = document.createElement("div");
  div.className = "row";
  div.dataset.row=row;
  let seatsCount = rowsConfig[row];
  let gapPos = gapAfter[row];

  for(let seat=1; seat<=seatsCount; seat++){
    if(seat === gapPos){
      let gap = document.createElement("div");
      gap.className="gap";
      gap.innerText = `Ряд: ${row}`;
      div.appendChild(gap);
    }

    let isBooked = booked.some(b=>b.row==row && b.seat==seat && b.hall=="parter");
    let premiumRow = premiumSeats.find(r => r.row===row);
    let isPremium = premiumRow && premiumRow.seats.includes(seat);

    div.appendChild(createSeat(row, seat, "parter", isPremium?1000:1500, isBooked, isPremium));
  }
  hall.appendChild(div);
}

// ======= АМФИТЕАТР =======
let amphRows = [
  {row:1, segments:[[1,6],[7,16],[17,26],[28,32]]},
  {row:2, segments:[[1,7],[8,17],[18,27],[28,34]]},
  {row:3, segments:[[1,6],[7,16],[17,26],[27,32]]},
  {row:4, segments:[[1,6],[7,16],[19,28],[29,34]]},
  {row:5, segments:[[1,5],[6,15],[18,27],[28,32]]},
  {row:6, segments:[[1,5],[6,15],[17,26],[27,31]]},
  {row:7, segments:[[1,4],[5,14],[15,24],[25,28]]},
  {row:8, segments:[[1,4],[5,14],[15,24],[25,28]]},
  {row:9, segments:[[1,4],[5,14],[15,24],[25,28]]},
  {row:10,segments:[[1,3],[4,13],[14,23],[24,26]]},
  {row:11,segments:[[1,3],[4,13],[14,23],[24,26]]},
];

amphRows.forEach(r => {
  let div = document.createElement("div");
  div.className = "row";
  div.dataset.row = r.row;
  div.style.display = "flex";
  div.style.justifyContent = "center";

  r.segments.forEach((seg, index) => {
    if(index>0){
      let label = document.createElement("div");
      label.className="gap";
      label.innerText = `Ряд: ${r.row}`;
      div.appendChild(label);
    }

    for(let s=seg[0]; s<=seg[1]; s++){
      let isBooked = booked.some(b=>b.row==r.row && b.seat==s && b.hall=="amphitheater");
      let premiumRow = amphPremiumSeats.find(rp => rp.row === r.row);
      let isPremium = premiumRow && premiumRow.seats.includes(s);

      div.appendChild(createSeat(r.row, s, "amphitheater", isPremium ? 1000 : 1500, isBooked, isPremium));
    }
  });

  amphHall.appendChild(div);
});

// ======= TOOLTIP =======
const tooltip = document.getElementById("tooltip");
document.addEventListener("mouseover", e=>{
  if(e.target.classList.contains("seat")){
    tooltip.innerText = e.target.dataset.tooltip;
    const rect = e.target.getBoundingClientRect();
    tooltip.style.top = `${rect.top + window.scrollY + rect.height/2 - tooltip.offsetHeight/2}px`;
    tooltip.style.left = `${rect.right + 12 + window.scrollX}px`;
    tooltip.classList.add('show');
  }
});
document.addEventListener("mouseout", e=>{
  if(e.target.classList.contains("seat")) tooltip.classList.remove('show');
});

// ======= MODAL =======
let selectedSeat = null;
function openModal(el){
  if(el.classList.contains("booked")){
    alert("Это место уже занято!");
    return;
  }
  selectedSeat = el;
  document.getElementById("modalRow").value = el.dataset.row;
  document.getElementById("modalSeat").value = el.dataset.seat;
  document.getElementById("modalPrice").value = el.dataset.price;
  document.getElementById("modalHall").value = el.dataset.hall;
  document.getElementById("bookingModal").classList.add("show");
}

document.getElementById("bookingForm").addEventListener("submit", function(e){
  e.preventDefault();
  let row = document.getElementById("modalRow").value;
  let seat = document.getElementById("modalSeat").value;
  let full_name = document.getElementById("fullName").value;
  let phone = document.getElementById("phone").value;
  let price = document.getElementById("modalPrice").value;
  let hall_type = document.getElementById("modalHall").value;
  let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  fetch("{% url 'api_book' %}", {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
    body: JSON.stringify({row, seat, full_name, phone, price, hall_type})
  })
  .then(res => res.json())
  .then(data => {
    if(data.success){
      selectedSeat.classList.add("booked");
      document.getElementById("bookingModal").classList.remove("show");
      document.getElementById("bookingForm").reset();

      if(data.ticket_url){
        const link = document.createElement('a');
        link.href = data.ticket_url;
        link.download = `ticket_${full_name.replace(/\s+/g,'_')}_ряд${row}_место${seat}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

    } else if(data.error){
      alert("Ошибка: "+data.error);
    }
  })
  .catch(err => {console.error(err); alert("Ошибка бронирования");});
});

window.onclick = function(e){
  let modal = document.getElementById("bookingModal");
  if(e.target===modal) modal.classList.remove("show");
}
</script>
</body>
</html>
