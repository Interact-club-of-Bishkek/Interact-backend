<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ê–Ω–∫–µ—Ç—ã –≤ –∫–æ–º–∞–Ω–¥—ã</title>
<link rel="icon" type="image/png" href="https://i.ibb.co/qFYrFSnD/2105176-1-removebg-preview.png">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { font-family: 'Inter', sans-serif; background:#020408; color:#fff; margin:0; }
.cmd-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:16px; }
.cmd-card { background:rgba(255,255,255,.05); border:2px solid rgba(255,255,255,.08); border-radius:20px; padding:20px; text-align:center; cursor:pointer; transition:.3s; }
.cmd-card:hover { border-color:#00c6ff; transform:translateY(-3px); }
.cmd-card.selected { background:#00c6ff; color:#000; border-color:#00c6ff; }

.neon-input { width:100%; padding:14px; border-radius:16px; background:rgba(255,255,255,.05); border:2px solid rgba(255,255,255,.08); outline:none; }
.neon-input:focus { border-color:#00c6ff; }

.file-upload-button { position: relative; display: flex; align-items: center; justify-content: center; padding:16px; border:2px dashed rgba(255,255,255,.3); border-radius:16px; cursor:pointer; gap:10px; margin-top:6px; }
.file-upload-button input { position:absolute; inset:0; opacity:0; cursor:pointer; }
.file-name { font-size:0.85rem; margin-top:4px; color:#aaa; }
.file-preview { margin-top:6px; max-height:150px; border-radius:12px; display:none; }

.btn-action { width:100%; padding:18px; border-radius:22px; background:#00c6ff; color:#000; font-weight:900; cursor:pointer; transition:.3s; }
.btn-action:hover { background:#00f0ff; }

.date-block { display:inline-block; padding:6px 12px; background:rgba(255,255,255,.05); border-radius:12px; margin-right:8px; font-size:0.9rem; }
.date-block span { color:#00c6ff; font-weight:600; }

.fullscreen-message { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; text-align:center; background:#020408; z-index:9999; }
.hidden { display:none; }

/* –ö–∞—Å—Ç–æ–º–Ω—ã–π select */
.select-wrapper { position:relative; }
.neon-select { padding:14px; border-radius:16px; border:2px solid rgba(255,255,255,.08); background:rgba(255,255,255,.05); cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
.neon-select:hover { border-color:#00c6ff; }
.neon-select .selected-text { color:#ccc; }
.neon-select .options { position:absolute; top:100%; left:0; right:0; background:#020408; border:2px solid #00c6ff; border-radius:16px; max-height:180px; overflow-y:auto; margin-top:4px; z-index:50; display:none; }
.neon-select .options li { padding:10px 14px; cursor:pointer; transition:0.2s; }
.neon-select .options li:hover { background:#00c6ff/20; }
</style>
</head>
<body>

<div id="fullscreenMessage" class="fullscreen-message hidden">
    <div class="text-center">
        <h1 class="text-4xl font-black mb-4 text-cyan-400"></h1>
        <p class="text-gray-400 text-lg"></p>
        <button onclick="hideMessage()" class="btn-action mt-4">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<div id="appContainer" class="max-w-4xl mx-auto p-6 hidden">

    <h1 class="text-center text-5xl font-black mb-10">
        Interact <span class="text-cyan-400">Commands</span>
    </h1>

    <div id="commandGrid" class="cmd-grid mb-10"></div>

    <div id="cmdInfo" class="hidden mb-8 p-6 rounded-2xl bg-white/5 whitespace-pre-line"></div>

    <form id="appForm" class="hidden space-y-6" enctype="multipart/form-data">
        <div id="questionsContainer" class="space-y-6"></div>
        <button type="submit" class="btn-action hidden" id="submitBtn">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
    </form>
</div>

<script>
const API_CMDS = '/commands/';
const API_APPS = '/commands-applications/';
const API_DIRECTIONS = '/api/volunteer-directions/';

let selectedSlug = '';
let directions = [];
let directionMap = {};

const app = document.getElementById('appContainer');
const message = document.getElementById('fullscreenMessage');
const submitBtn = document.getElementById('submitBtn');

function showMessage(title, text){
    message.querySelector('h1').textContent = title;
    message.querySelector('p').textContent = text;
    message.classList.remove('hidden');
    app.classList.add('hidden');
}

function hideMessage(){
    message.classList.add('hidden');
    app.classList.remove('hidden');
}

async function init(){
    try {
        const [resCmds, resDirs] = await Promise.all([fetch(API_CMDS), fetch(API_DIRECTIONS)]);
        const commands = await resCmds.json();
        directions = await resDirs.json();

        // –∫–∞—Ä—Ç–∞ id -> name
        directions.forEach(d=>directionMap[d.id]=d.name);

        const grid = document.getElementById('commandGrid');
        commands.forEach(cmd=>{
            const card = document.createElement('div');
            card.className = 'cmd-card';
            card.textContent = cmd.title;
            card.onclick = ()=>loadCommand(cmd, card);
            grid.appendChild(card);
        });

        hideMessage();
    } catch(e){
        showMessage('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã');
        console.error(e);
    }
}

function formatDate(dt){
    if(!dt) return '';
    return new Date(dt).toLocaleString('ru-RU', {day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit'});
}

function loadCommand(cmd, card){
    document.querySelectorAll('.cmd-card').forEach(c=>c.classList.remove('selected'));
    card.classList.add('selected');

    const now = new Date();
    const start = cmd.start_date ? new Date(cmd.start_date) : null;
    const end = cmd.end_date ? new Date(cmd.end_date) : null;

    if(start && now < start){
        showMessage('–ù–∞–±–æ—Ä –µ—â–µ –Ω–µ –æ—Ç–∫—Ä—ã—Ç','–û–∂–∏–¥–∞–π—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—Ç–∞. –ú—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–æ–±—â–∏–º ü§ç');
        return;
    }
    if(end && now > end){
        showMessage('–ù–∞–±–æ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω','–ü—Ä–∏–µ–º –∑–∞—è–≤–æ–∫ —É–∂–µ –∑–∞–∫—Ä—ã—Ç');
        return;
    }

    hideMessage();
    selectedSlug = cmd.slug;

    const info = document.getElementById('cmdInfo');
    info.classList.remove('hidden');
    info.innerHTML = `
        <h2 class="text-3xl font-black mb-2">${cmd.title}</h2>
        <p class="text-gray-400 mb-4">${cmd.description || ''}</p>
        <div class="flex gap-4">
            <div class="date-block">–ù–∞—á–∞–ª–æ: <span>${formatDate(cmd.start_date)}</span></div>
            <div class="date-block">–ö–æ–Ω–µ—Ü: <span>${formatDate(cmd.end_date)}</span></div>
        </div>
    `;

    const qBox = document.getElementById('questionsContainer');
    qBox.innerHTML = '';

    if(!cmd.questions || cmd.questions.length === 0){
        submitBtn.classList.add('hidden');
        return;
    } else {
        submitBtn.classList.remove('hidden');
    }

    cmd.questions.forEach(q=>{
        const required = q.required ? 'required' : '';
        const fieldName = `q_${q.id}`;
        let html = '';

        if(q.field_type === 'photo' || q.field_type === 'video'){
            html = `
            <div>
                <label class="text-xs text-gray-400">${q.label}</label>
                <label class="file-upload-button">
                    <span>–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</span>
                    <input type="file" name="${fieldName}" accept="${q.field_type==='photo'?'image/*':'video/*'}" ${required}>
                </label>
                <div class="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
                <img class="file-preview">
            </div>`;
        } else if(q.field_type === 'select'){
            html = `
            <div class="select-wrapper" data-fieldname="${fieldName}" ${q.required ? 'data-required="true"' : ''}>
                <label class="text-xs text-gray-400">${q.label}</label>
                <div class="neon-select">
                    <span class="selected-text">–í—ã–±–µ—Ä–∏—Ç–µ...</span>
                    <ul class="options"></ul>
                </div>
            </div>`;
        } else {
            html = `
            <div>
                <label class="text-xs text-gray-400">${q.label}</label>
                <input class="neon-input mt-2" name="${fieldName}" ${required}>
            </div>`;
        }

        qBox.insertAdjacentHTML('beforeend', html);
    });

    setupFileInputs();
    setupCustomSelects();
    document.getElementById('appForm').classList.remove('hidden');
}

// –§–∞–π–ª—ã
function setupFileInputs(){
    document.querySelectorAll('input[type=file]').forEach(input=>{
        const block = input.closest('div');
        const fileName = block.querySelector('.file-name');
        const preview = block.querySelector('.file-preview');

        input.onchange = ()=>{
            if(!input.files.length){
                fileName.textContent='–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
                preview.style.display='none';
                return;
            }
            const file = input.files[0];
            fileName.textContent = file.name;

            if(file.type.startsWith('image/')){
                const reader = new FileReader();
                reader.onload = e => { preview.src = e.target.result; preview.style.display='block'; };
                reader.readAsDataURL(file);
            } else { preview.style.display='none'; }
        };
    });
}

// –ö–∞—Å—Ç–æ–º–Ω—ã–π dropdown
function setupCustomSelects(){
    document.querySelectorAll('.select-wrapper').forEach(wrapper=>{
        const selectBox = wrapper.querySelector('.neon-select');
        const ul = selectBox.querySelector('.options');
        const selectedText = selectBox.querySelector('.selected-text');
        const fieldName = wrapper.dataset.fieldname;

        directions.forEach(d=>{
            const li = document.createElement('li');
            li.textContent = d.name;
            li.dataset.id = d.id;
            li.onclick = ()=>{
                wrapper.dataset.value = d.id;
                selectedText.textContent = d.name;
                ul.style.display = 'none';
            };
            ul.appendChild(li);
        });

        selectBox.onclick = e=>{
            e.stopPropagation();
            document.querySelectorAll('.select-wrapper .options').forEach(opt=>{ if(opt!==ul) opt.style.display='none'; });
            ul.style.display = ul.style.display==='block'?'none':'block';
        };
    });

    document.addEventListener('click', ()=>{
        document.querySelectorAll('.select-wrapper .options').forEach(ul=>ul.style.display='none');
    });
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
document.getElementById('appForm').onsubmit = async e=>{
    e.preventDefault();
    if(!selectedSlug){ alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É'); return; }

    const fd = new FormData();
    fd.append('command_slug', selectedSlug);

    let valid = true;
    const answers = {};

    document.querySelectorAll('#questionsContainer > div').forEach(div=>{
        const input = div.querySelector('input');
        if(input){
            const val = input.type==='file'?input.files[0]:input.value.trim();
            if(input.type==='file'){
                if(input.files.length) fd.append(input.name, input.files[0]);
                else if(input.required) valid=false;
            } else {
                answers[input.name] = val;
                if(input.required && !val) valid=false;
            }
        } else if(div.classList.contains('select-wrapper')){
            const wrapper = div;
            const val = wrapper.dataset.value;
            const name = wrapper.dataset.fieldname;
            answers[name] = directionMap[val] || '';
            if(wrapper.dataset.required === "true" && !val) valid=false;
        }
    });

    if(!valid){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è'); return; }

    fd.append('answers', JSON.stringify(answers));

    try{
        const res = await fetch(API_APPS, {method:'POST', body:fd});
        if(res.ok){
            showMessage('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞','–°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ ü§ç');
            document.getElementById('appForm').reset();
            document.getElementById('questionsContainer').innerHTML='';
            submitBtn.classList.add('hidden');
        } else {
            const err = await res.text();
            console.error(err);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ');
        }
    } catch(e){
        console.error(e);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    }
};

init();
</script>
</body>
</html>
