<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curator Pro | Management Console</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #00c6ff; --bg: #020408; --glass: rgba(15, 23, 42, 0.85); }
        body { 
            background: var(--bg); 
            font-family: 'Inter', sans-serif; 
            color: white;
            background-image: radial-gradient(circle at 50% -20%, #10192e 0%, #020408 100%);
            min-height: 100vh;
            margin: 0;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        .glass-card { 
            background: var(--glass); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .glass-card:hover { 
            border-color: var(--primary); 
            box-shadow: 0 0 30px rgba(0, 198, 255, 0.2);
            transform: translateY(-2px);
        }

        .media-container {
            width: 100%;
            background: #000;
            border-radius: 28px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .media-container video, .media-container img {
            width: 100%;
            display: block;
            object-fit: contain;
            max-height: 650px;
        }
        .media-container iframe {
            width: 100%;
            height: 500px;
            border: none;
        }

        #filter {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2300c6ff'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
        }

        .animate-fade-up { animation: fadeUp 0.4s ease-out forwards; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 md:p-10">
    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-16 gap-6">
            <div>
                <h1 class="font-['Montserrat'] font-black text-4xl tracking-tighter uppercase italic text-primary">
                    Curator<span class="text-white">Pro</span>
                </h1>
                <p class="text-[10px] text-primary/50 font-black uppercase tracking-[0.4em] mt-1">Management Interface v2.0</p>
            </div>
            <select id="filter" class="w-full md:w-80 bg-gray-900 border-2 border-primary/20 p-4 rounded-2xl outline-none text-xs font-black text-primary hover:border-primary transition-all cursor-pointer">
                <option value="">ВСЕ НАПРАВЛЕНИЯ</option>
            </select>
        </header>

        <div class="grid lg:grid-cols-2 gap-12">
            <section>
                <div class="flex items-center gap-4 mb-8">
                    <div class="w-3 h-3 bg-orange-500 rounded-full animate-pulse shadow-[0_0_15px_#f97316]"></div>
                    <h2 class="font-black uppercase text-sm tracking-widest italic text-orange-500">Входящие анкеты</h2>
                </div>
                <div id="pending" class="grid gap-6"></div>
            </section>

            <section>
                <div class="flex items-center gap-4 mb-8">
                    <div class="w-3 h-3 bg-green-500 rounded-full shadow-[0_0_15px_#22c55e]"></div>
                    <h2 class="font-black uppercase text-sm tracking-widest italic text-green-500">Одобренные</h2>
                </div>
                <div id="accepted" class="grid gap-6"></div>
            </section>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black/98 backdrop-blur-2xl flex items-center justify-center p-4 z-50">
        <div class="glass-card w-full max-w-5xl rounded-[48px] p-6 md:p-14 max-h-[92vh] overflow-y-auto relative shadow-2xl">
            <button onclick="closeModal()" class="fixed top-8 right-8 text-gray-500 hover:text-primary transition-all z-50 bg-black/50 w-12 h-12 rounded-full flex items-center justify-center border border-white/10">
                <i class="fas fa-times text-xl"></i>
            </button>
            
            <div id="modalContent" class="animate-fade-up"></div>
            
            <div class="mt-14 flex flex-col md:flex-row gap-5 border-t border-white/10 pt-10">
                <button id="approveBtn" class="flex-[2] py-6 bg-primary text-black font-black uppercase rounded-3xl hover:shadow-[0_0_40px_rgba(0,198,255,0.4)] transition-all text-lg active:scale-95">
                    <i class="fas fa-user-plus mr-2"></i> Принять в клуб
                </button>
                <button onclick="closeModal()" class="flex-1 py-6 bg-white/5 text-white font-bold uppercase rounded-3xl border border-white/10 hover:bg-white/10 transition-all">
                    Вернуться к списку
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_APPS = '/commands-applications/';
        const filter = document.getElementById('filter');

        async function load() {
            try {
                const res = await fetch(`${API_APPS}${filter.value ? '?slug='+filter.value : ''}`);
                const apps = await res.json();
                const p = document.getElementById('pending'), a = document.getElementById('accepted');
                p.innerHTML = ''; a.innerHTML = '';

                apps.forEach(app => {
                    // Фильтруем пустые заявки без выбранных команд
                    if (!app.command_title || app.command_title.includes('Загрузка')) return;

                    const card = document.createElement('div');
                    card.className = "glass-card p-8 rounded-[32px] cursor-pointer group relative overflow-hidden animate-fade-up";
                    card.onclick = () => show(app);
                    
                    const firstAnswer = Object.values(app.answers)[0] || "Нет описания";
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-5">
                            <span class="px-4 py-1.5 rounded-xl bg-primary/10 text-primary text-[10px] font-black uppercase tracking-widest border border-primary/20">
                                ${app.command_title}
                            </span>
                            <span class="text-[10px] text-gray-700 font-mono italic font-bold">#REQ-${app.id}</span>
                        </div>
                        <h3 class="text-lg font-bold text-gray-200 group-hover:text-white transition-colors leading-tight">
                            ${firstAnswer.substring(0, 70)}${firstAnswer.length > 70 ? '...' : ''}
                        </h3>
                        <div class="mt-8 flex justify-between items-center border-t border-white/5 pt-5">
                            <div class="flex items-center gap-2 text-gray-500">
                                <i class="far fa-calendar-alt text-[10px]"></i>
                                <span class="text-[9px] font-black uppercase tracking-tighter">${new Date(app.created_at).toLocaleString()}</span>
                            </div>
                            <i class="fas fa-arrow-right text-primary opacity-0 group-hover:opacity-100 group-hover:translate-x-3 transition-all"></i>
                        </div>
                    `;
                    (app.status === 'pending' ? p : a).appendChild(card);
                });
            } catch (e) { console.error("API Error:", e); }
        }

        function show(app) {
            const content = document.getElementById('modalContent');
            let html = `
                <div class="mb-14 pb-10 border-b border-white/10">
                    <div class="inline-block px-4 py-1 rounded-full bg-primary/20 text-primary text-[10px] font-black uppercase tracking-[0.3em] mb-4">${app.command_title}</div>
                    <h2 class="font-['Montserrat'] font-black text-5xl md:text-6xl uppercase italic tracking-tighter text-white">Досье<br><span class="text-primary">Кандидата</span></h2>
                </div>
                <div class="space-y-12">
            `;
            
            // Ответы
            Object.entries(app.answers).forEach(([q, a]) => {
                html += `
                    <div class="bg-white/[0.03] p-8 rounded-[32px] border border-white/5 hover:border-primary/20 transition-colors">
                        <label class="text-[10px] font-black uppercase text-gray-500 tracking-[0.4em] mb-4 block italic"><i class="fas fa-terminal mr-2 text-primary/50"></i> ${q}</label>
                        <p class="text-2xl font-medium text-gray-100 leading-relaxed">${a}</p>
                    </div>`;
            });

            // МЕДИА (ФОТО / ВИДЕО / PDF)
            if(app.files && app.files.length) {
                html += `<div class="pt-10 space-y-16">`;
                app.files.forEach(f => {
                    const fileUrl = f.file.toLowerCase();
                    const isImg = fileUrl.match(/\.(jpg|jpeg|png|webp|gif|avif|heic)$/i);
                    const isVid = fileUrl.match(/\.(mp4|mov|webm|ogg|quicktime)$/i);
                    const isPdf = fileUrl.match(/\.(pdf)$/i);
                    
                    html += `
                        <div class="space-y-6 animate-fade-up">
                            <div class="flex items-center justify-between px-2">
                                <label class="text-[11px] font-black uppercase text-primary tracking-[0.3em] italic">
                                    <i class="fas fa-link mr-2"></i> ${f.label}
                                </label>
                            </div>
                            
                            <div class="media-container">
                                ${isImg ? 
                                    `<img src="${f.file}" class="cursor-zoom-in hover:scale-[1.01] transition-transform duration-700" onclick="window.open('${f.file}', '_blank')">` : 
                                    isVid ?
                                    `<video src="${f.file}" controls playsinline preload="metadata"></video>` :
                                    isPdf ?
                                    `<iframe src="${f.file}"></iframe>` :
                                    `<div class="p-20 text-center flex flex-col items-center gap-4">
                                        <i class="fas fa-file-circle-exclamation text-6xl text-gray-800"></i>
                                        <p class="text-gray-600 text-[10px] font-black uppercase tracking-widest">Превью недоступно для этого расширения</p>
                                     </div>`
                                }
                            </div>

                            <div class="flex flex-col sm:flex-row gap-4">
                                <a href="${f.file}" download="${f.label}" target="_blank" 
                                   class="flex-[2] flex items-center justify-center gap-3 px-10 py-5 rounded-2xl bg-primary text-black text-[12px] font-black uppercase tracking-widest hover:shadow-[0_0_30px_rgba(0,198,255,0.4)] transition-all">
                                    <i class="fas fa-cloud-download-alt text-lg"></i> Запустить и скачать файл
                                </a>
                                <a href="${f.file}" target="_blank" 
                                   class="flex-1 flex items-center justify-center gap-3 px-10 py-5 rounded-2xl bg-white/5 border border-white/10 text-[11px] font-black uppercase tracking-widest text-gray-400 hover:bg-white/10 transition-all">
                                    <i class="fas fa-expand"></i> В новом окне
                                </a>
                            </div>
                        </div>`;
                });
                html += `</div>`;
            }
            
            content.innerHTML = html;
            const btn = document.getElementById('approveBtn');
            btn.style.display = app.status === 'pending' ? 'flex' : 'none';
            btn.onclick = async () => {
                const res = await fetch(`${API_APPS}${app.id}/accept/`, { method: 'PATCH' });
                if(res.ok) { closeModal(); load(); }
            };
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        
        // Подгрузка списка команд в фильтр
        fetch('/commands/').then(r => r.json()).then(data => {
            data.forEach(c => filter.innerHTML += `<option value="${c.slug}">${c.title}</option>`);
        });

        filter.onchange = load;
        load();
    </script>
</body>
</html>