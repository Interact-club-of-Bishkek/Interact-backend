{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Партер</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f0f0f0;
  text-align: center;
  margin: 0;
  padding: 0 0 100px;
}

h2 { margin: 15px 0; }

.legend {
  margin: 20px auto;
  display: flex;
  justify-content: center;
  gap: 20px;
  font-size: 14px;
  position: relative;
  z-index: 100;
}
.legend-item { display: flex; align-items: center; gap: 5px; }
.legend-color { width: 18px; height: 18px; border-radius: 3px; }
.free-color { background: #2e7d32; }
.booked-color { background: #616161; }
.orange-color { background: #ff9800; }

.hall-container {
  display: flex;
  flex-direction: column-reverse;
  align-items: center;
  gap: 8px;
}

.row {
  display: flex;
  gap: 6px;
  justify-content: center;
  align-items: center;
  position: relative;
}

.seat {
  width: 28px;
  height: 28px;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  cursor: pointer;
  color: white;
  background: #2e7d32;
  transition: transform 0.3s ease, background 0.3s ease;
  position: relative;
}
.seat:hover { transform: scale(1.3); background: #1b5e20; }

.booked { background: #616161; cursor: not-allowed; }
.premium { background: #ff9800; }
.premium:hover { background: #e65100; }

.gap {
  width: 80px;
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 12px;
  font-weight: bold;
  color: #1e3d7b;
}

.stage {
  margin: 70px auto 0; /* увеличено расстояние сверху */
  width: calc(36*28px + 35*6px + 80px);
  padding: 10px;
  background: #1e3d7b;
  color: white;
  font-weight: bold;
  border-radius: 3px;
}

/* Модалка */
.modal {
  display: none;
  position: fixed;
  z-index: 10;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  justify-content: center;
  align-items: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.modal.show { display:flex; opacity:1; }

.modal-content {
  background: linear-gradient(145deg, #ffffff, #e3f2fd);
  padding: 30px;
  border-radius: 8px;
  text-align: left;
  width: 380px;
  max-width: 90%;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  transform: scale(0.85);
  transition: transform 0.3s ease, opacity 0.3s ease;
}
.modal.show .modal-content { transform: scale(1); }

.modal-content input {
  width: 100%;
  padding: 12px;
  margin-bottom: 15px;
  border: 1px solid #90caf9;
  border-radius: 4px;
  outline: none;
  transition: border 0.3s;
  font-size: 14px;
}
.modal-content input:focus { border: 2px solid #1e88e5; }

.modal-content button {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 4px;
  background: #1e88e5;
  color: white;
  font-weight: bold;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.3s ease;
}
.modal-content button:hover { background: #1565c0; }

/* Tooltip */
.tooltip {
  position: absolute;
  display: none;
  background: rgba(33,33,33,0.95);
  color: white;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 12px;
  white-space: nowrap;
  pointer-events: none;
  z-index: 1000;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.tooltip.show { display: block; opacity: 1; }
</style>
</head>
<body>

<div class="legend">
  <div class="legend-item">
    <div class="legend-color free-color"></div> 1000 сом
  </div>
  <div class="legend-item">
    <div class="legend-color orange-color"></div> 2000 сом
  </div>
  <div class="legend-item">
    <div class="legend-color booked-color"></div> Занято
  </div>
</div>

<h2>Партер</h2>
<div class="hall-container" id="parter"></div>
<div class="stage">СЦЕНА</div>

<!-- Модалка -->
<div class="modal" id="bookingModal">
  <div class="modal-content">
    <h3>Бронирование</h3>
    <form id="bookingForm">
      {% csrf_token %}
      <input type="hidden" id="modalRow">
      <input type="hidden" id="modalSeat">
      <input type="hidden" id="modalPrice" value="1000">
      <input type="text" id="fullName" placeholder="Введите ФИО" required>
      <input type="text" id="phone" placeholder="Введите телефон" required>
      <button type="submit">Забронировать и скачать билет</button>
    </form>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let rowsConfig = {1:24,2:26,3:28,4:30,5:32,6:34,7:34,8:36,9:36,10:36,11:36};
let gapAfter = {1:12,2:13,3:14,4:15,5:16,6:17,7:17,8:18,9:18,10:18,11:18};
let hall = document.getElementById("parter");

let booked = [
{% for b in bookings %}
  {row: {{ b.row }}, seat: {{ b.seat }} },
{% endfor %}
];

// Премиум места 2000 сом
let premiumSeats = [
  {row:3, seats:[1,2,27,28]},
  {row:4, seats:[1,2,3,28,29,30]},
  {row:5, seats:[1,2,3,4,29,30,31,32]},
  {row:6, seats:[1,2,3,4,5,30,31,32,33,34]},
  {row:7, seats:[1,2,3,4,5,30,31,32,33,34]},
  {row:8, seats:[1,2,3,4,5,6,31,32,33,34,35,36]},
  {row:9, seats:[1,2,3,4,5,6,31,32,33,34,35,36]},
  {row:10,seats:[1,2,3,4,5,6,31,32,33,34,35,36]},
  {row:11,seats:[1,2,3,4,5,6,31,32,33,34,35,36]}
];

for (let row=1; row<=11; row++){
  let div=document.createElement("div");
  div.className="row";
  div.dataset.row=row;
  let seatsCount=rowsConfig[row];
  let gapPos=gapAfter[row];

  for(let seat=seatsCount; seat>=1; seat--){
    if(seat===gapPos){
      let gap = document.createElement("div");
      gap.className="gap";
      gap.innerText = `Ряд: ${row}`;
      div.appendChild(gap);
    }

    let seatDiv=document.createElement("div");
    let price = 1000;
    let seatClass = "seat";

    if(booked.some(b=>b.row==row && b.seat==seat)){
        seatClass += " booked";
    } else {
        let premiumRow = premiumSeats.find(r => r.row===row);
        if(premiumRow && premiumRow.seats.includes(seat)){
            seatClass += " premium";
            price = 2000;
        }
    }

    seatDiv.className = seatClass;
    seatDiv.dataset.price = price;
    seatDiv.innerText = seat;
    seatDiv.dataset.row = row;
    seatDiv.dataset.seat = seat;
    seatDiv.dataset.tooltip = `Ряд ${row}, Место ${seat}, ${price} сом`;

    seatDiv.onclick = ()=> openModal(seatDiv);
    div.appendChild(seatDiv);
  }
  hall.appendChild(div);
}

const tooltip=document.getElementById("tooltip");
document.addEventListener("mouseover", e=>{
  if(e.target.classList.contains("seat")){
    tooltip.innerText=e.target.dataset.tooltip;
    const rect=e.target.getBoundingClientRect();
    tooltip.style.top=`${rect.top + window.scrollY + rect.height/2 - tooltip.offsetHeight/2}px`;
    tooltip.style.left=`${rect.right + 12 + window.scrollX}px`;
    tooltip.classList.add('show');
  }
});
document.addEventListener("mouseout", e=>{
  if(e.target.classList.contains("seat")) tooltip.classList.remove('show');
});

let selectedSeat=null;
function openModal(el){
  if(el.classList.contains("booked")){
    alert("Это место уже занято!");
    return;
  }
  selectedSeat=el;
  document.getElementById("modalRow").value=el.dataset.row;
  document.getElementById("modalSeat").value=el.dataset.seat;
  document.getElementById("modalPrice").value=el.dataset.price;
  document.getElementById("bookingModal").classList.add("show");
}

document.getElementById("bookingForm").addEventListener("submit", function(e){
  e.preventDefault();
  let row=document.getElementById("modalRow").value;
  let seat=document.getElementById("modalSeat").value;
  let full_name=document.getElementById("fullName").value;
  let phone=document.getElementById("phone").value;
  let price=document.getElementById("modalPrice").value;
  let csrfToken=document.querySelector('[name=csrfmiddlewaretoken]').value;

  fetch("{% url 'api_book' %}", {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
    body: JSON.stringify({row, seat, full_name, phone, price})
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.success){
      selectedSeat.classList.add("booked");
      document.getElementById("bookingModal").classList.remove("show");
      document.getElementById("bookingForm").reset();
      downloadTicketPDF(full_name, row, seat, price);
    } else if(data.error){
      alert("Ошибка: "+data.error);
    }
  })
  .catch(err=>{console.error(err); alert("Ошибка бронирования");});
});

window.onclick=function(e){
  let modal=document.getElementById("bookingModal");
  if(e.target===modal) modal.classList.remove("show");
}

function downloadTicketPDF(fullName, row, seat, price){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(20);
  doc.text("Билет", 105, 20, {align: "center"});
  doc.setFontSize(16);
  doc.text(`ФИО: ${fullName}`, 20, 40);
  doc.text(`Ряд: ${row}`, 20, 60);
  doc.text(`Место: ${seat}`, 20, 80);
  doc.text(`Цена: ${price} сом`, 20, 100);
  doc.text("Спасибо за покупку!", 105, 130, {align:"center"});
  doc.save(`Билет_${fullName.replace(/\s+/g,'_')}_ряд${row}_место${seat}.pdf`);
}
</script>
</body>
</html>
